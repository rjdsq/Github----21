<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>关于她 · 图集</title>
<style>
* {margin:0;padding:0;box-sizing:border-box}
body {font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:#111;color:#fff;padding-bottom:60px}
.gallery {display:grid;gap:12px;padding:12px}
.gallery.col-1 {grid-template-columns:1fr}
.gallery.col-2 {grid-template-columns:repeat(2,1fr)}
.gallery.col-4 {grid-template-columns:repeat(4,1fr)}
.thumb {position:relative;border-radius:6px;overflow:hidden;background:#222;aspect-ratio:16/10;cursor:pointer;transition:transform .2s,box-shadow .2s}
.thumb:hover {transform:translateY(-4px);box-shadow:0 8px 16px rgba(0,0,0,.3)}
.thumb img {width:100%;height:100%;object-fit:cover;transition:transform .3s}
.thumb:hover img {transform:scale(1.05)}
.viewer {position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;z-index:999;opacity:0;transition:opacity .3s}
.viewer.active {opacity:1}
.viewer img,.viewer video {max-width:95%;max-height:95%;border-radius:6px;transition:opacity .3s ease}
.viewer img.active,.viewer video.active {opacity:1}
.viewer .info {position:absolute;left:0;right:0;bottom:20px;text-align:center;font-size:16px;color:#fff;text-shadow:0 0 5px #000;z-index:1000}
.viewer .close {position:absolute;top:20px;right:20px;font-size:30px;color:#fff;cursor:pointer;z-index:1001;transition:transform .2s}
.viewer .close:hover {transform:scale(1.2)}
.nav-bar {position:fixed;bottom:0;left:0;right:0;background:#222;display:flex;z-index:998;padding:8px;box-shadow:0 -2px 10px rgba(0,0,0,.2)}
.nav-btn {flex:1;padding:10px 0;margin:0 4px;border-radius:4px;background:#333;border:none;color:#fff;font-size:14px;cursor:pointer;transition:background .2s,transform .1s}
.nav-btn:hover {background:#444}
.nav-btn.active {background:#007bff}
.nav-btn:active {transform:scale(.96)}
.layout-controls {position:fixed;bottom:60px;right:10px;z-index:997}
.layout-btn {width:40px;height:40px;border-radius:50%;background:#333;border:none;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 2px 5px rgba(0,0,0,.3);transition:background .2s}
.layout-btn:hover {background:#444}
.music-player {position:fixed;bottom:60px;left:0;right:0;background:#222;padding:15px;display:none;z-index:998;box-shadow:0 -2px 10px rgba(0,0,0,.2);border-top:1px solid #333;transform:translateY(100%);transition:transform .3s ease}
.music-player.active {transform:translateY(0)}
.music-player .title {margin-bottom:10px;text-align:center;font-size:16px;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.music-controls {display:flex;align-items:center;justify-content:center;gap:15px;margin-bottom:10px}
.music-control-btn {background:#333;border:none;color:#fff;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:background .2s}
.music-control-btn:hover {background:#444}
.music-control-btn.play-pause {background:#007bff;width:50px;height:50px}
.music-progress {height:4px;background:#333;border-radius:2px;margin-bottom:10px;overflow:hidden}
.music-progress-bar {height:100%;background:#007bff;width:0%;transition:width .1s}
.music-time {display:flex;justify-content:space-between;font-size:12px;color:#aaa;margin-bottom:10px}
.music-list {margin-top:10px;max-height:150px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:#444 #222}
.music-list::-webkit-scrollbar {width:4px}
.music-list::-webkit-scrollbar-track {background:#222}
.music-list::-webkit-scrollbar-thumb {background-color:#444;border-radius:2px}
.music-item {padding:10px;margin:4px 0;background:#333;cursor:pointer;transition:background .2s;border-radius:4px}
.music-item:hover {background:#444}
.music-item.active {background:#007bff}
.loading {text-align:center;padding:40px;font-size:16px;color:#666;animation:pulse 1.5s infinite}
@keyframes pulse {0% {opacity:.6}50% {opacity:1}100% {opacity:.6}}
</style>
</head>
<body>
<div id="gallery" class="gallery col-2">
  <div class="loading">加载中…</div>
</div>
<div id="viewer" class="viewer">
  <span class="close" onclick="closeViewer()">&times;</span>
  <img id="viewerImg" style="display:none" />
  <video id="viewerVideo" controls style="display:none"></video>
  <div id="viewerInfo" class="info"></div>
</div>
<div class="layout-controls">
  <button class="layout-btn" onclick="toggleLayout()">
    <i class="fa fa-th-large"></i>
  </button>
</div>
<div class="nav-bar">
  <button class="nav-btn active" onclick="loadImages('douyin')">最新图片</button>
  <button class="nav-btn" onclick="loadImages('yunnan')">云南图片</button>
  <button class="nav-btn" onclick="loadVideos()">视频播放</button>
  <button class="nav-btn" onclick="toggleMusicPlayer()">音乐播放</button>
</div>

<div id="musicPlayerContainer" class="music-player">
  <div class="title" id="currentMusicTitle">加载中...</div>
  <div class="music-controls">
    <button class="music-control-btn" onclick="playPrevious()">
      <i class="fa fa-step-backward"></i>
    </button>
    <button class="music-control-btn play-pause" id="playPauseBtn" onclick="togglePlayPause()">
      <i class="fa fa-play"></i>
    </button>
    <button class="music-control-btn" onclick="playNext()">
      <i class="fa fa-step-forward"></i>
    </button>
  </div>
  <div class="music-time">
    <span id="currentTime">0:00</span>
    <span id="totalTime">0:00</span>
  </div>
  <div class="music-progress">
    <div class="music-progress-bar" id="progressBar"></div>
  </div>
  <div class="music-list" id="musicList"></div>
</div>

<audio id="musicPlayer"></audio>

<script>
const API_URLS={douyin:'https://api.github.com/repos/rjdsq/rjdsq.github.io/contents/img/douyin',yunnan:'https://api.github.com/repos/rjdsq/rjdsq.github.io/contents/img/yunnan',music:'https://api.github.com/repos/rjdsq/rjdsq.github.io/contents/music',videos:'https://api.github.com/repos/rjdsq/rjdsq.github.io/contents/mp4/douyin'};
const GITHUB_TOKEN='\u0067\u0068\u0070\u005f\u0048\u0031\u0058\u0036\u0062\u0055\u006e\u004f\u0046\u0033\u0071\u005a\u0047\u007a\u0036\u0047\u0053\u0074\u006e\u0043\u0057\u0045\u004c\u0049\u0074\u0072\u005a\u0054\u0034\u0063\u0030\u0041\u0036\u0051\u0067\u0076';
const PROXY='https://gh-proxy.com/';
let imgs=[],videos=[],idx=0,currentSource='douyin',musicList=[],currentMusicIndex=0,isViewingVideos=false,isMusicPlaying=false,currentLayout=2;
const musicPlayer=document.getElementById('musicPlayer'),musicPlayerContainer=document.getElementById('musicPlayerContainer'),currentMusicTitle=document.getElementById('currentMusicTitle'),viewerImg=document.getElementById('viewerImg'),viewerVideo=document.getElementById('viewerVideo'),viewer=document.getElementById('viewer'),playPauseBtn=document.getElementById('playPauseBtn'),progressBar=document.getElementById('progressBar'),currentTime=document.getElementById('currentTime'),totalTime=document.getElementById('totalTime'),gallery=document.getElementById('gallery');

loadImages('douyin');
loadMusic();

const fontAwesome=document.createElement('link');
fontAwesome.href='https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css';
fontAwesome.rel='stylesheet';
document.head.appendChild(fontAwesome);

const tailwind=document.createElement('script');
tailwind.src='https://cdn.tailwindcss.com';
document.head.appendChild(tailwind);

function loadImages(source){
  isViewingVideos=false;
  document.querySelectorAll('.nav-btn').forEach(btn=>btn.classList.remove('active'));
  document.querySelector(`.nav-btn[onclick="loadImages('${source}')"]`).classList.add('active');
  currentSource=source;
  gallery.innerHTML='<div class="loading">加载中…</div>';
  fetch(API_URLS[source],{headers:{'Authorization':`token ${GITHUB_TOKEN}`}})
    .then(r=>r.json())
    .then(list=>{
      imgs=list.filter(f=>/\.(jpe?g|png|gif|webp)$/i.test(f.name)).reverse();
      renderThumbs();
    })
    .catch(()=>gallery.innerHTML='<div style="text-align:center;padding:40px;color:#666">加载失败，请稍后重试</div>');
}

function loadVideos(){
  isViewingVideos=true;
  document.querySelectorAll('.nav-btn').forEach(btn=>btn.classList.remove('active'));
  document.querySelector(`.nav-btn[onclick="loadVideos()"]`).classList.add('active');
  gallery.innerHTML='<div class="loading">加载视频中…</div>';
  fetch(API_URLS.videos,{headers:{'Authorization':`token ${GITHUB_TOKEN}`}})
    .then(r=>r.json())
    .then(list=>{
      videos=list.filter(f=>/\.(mp4|webm|mov|avi)$/i.test(f.name)).reverse();
      renderVideos();
    })
    .catch(()=>gallery.innerHTML='<div style="text-align:center;padding:40px;color:#666">视频加载失败，请稍后重试</div>');
}

function renderThumbs(){
  gallery.className=`gallery col-${currentLayout}`;
  gallery.innerHTML='';
  if(imgs.length===0){
    gallery.innerHTML='<div style="text-align:center;padding:40px;color:#666">没有找到图片</div>';
    return;
  }
  gallery.style.opacity='0';
  setTimeout(()=>{
    imgs.forEach((f,i)=>{
      const box=document.createElement('div');
      box.className='thumb';
      box.innerHTML=`<img src="${PROXY + f.download_url}" alt="${f.name}">`;
      box.onclick=()=>openViewer(i);
      gallery.appendChild(box);
    });
    gallery.style.opacity='1';
    gallery.style.transition='opacity 0.5s';
  },200);
}

function renderVideos(){
  gallery.className=`gallery col-${currentLayout}`;
  gallery.innerHTML='';
  if(videos.length===0){
    gallery.innerHTML='<div style="text-align:center;padding:40px;color:#666">没有找到视频</div>';
    return;
  }
  gallery.style.opacity='0';
  setTimeout(()=>{
    videos.forEach((f,i)=>{
      const box=document.createElement('div');
      box.className='thumb';
      box.innerHTML=`
        <img src="https://img.youtube.com/vi/${f.name.replace(/\.[^/.]+$/,'')}/0.jpg" alt="${f.name}" onerror="this.src='https://picsum.photos/200/300?random=${i}'" style="filter: brightness(0.8);">
        <div class="title" style="padding-top: 30px;">
          <span class="fa fa-play-circle" style="font-size: 24px; margin-bottom: 5px;"></span><br>
          ${f.name.replace(/\.[^/.]+$/,'')}
        </div>`;
      box.onclick=()=>openVideo(i);
      gallery.appendChild(box);
    });
    gallery.style.opacity='1';
    gallery.style.transition='opacity 0.5s';
  },200);
}

function openViewer(i){
  idx=i;
  viewer.style.display='flex';
  viewerImg.style.display='block';
  viewerImg.src=PROXY + imgs[idx].download_url;
  document.getElementById('viewerInfo').textContent=`${idx+1} / ${imgs.length}  ${imgs[idx].name.replace(/\.[^/.]+$/,'')}`;
  viewer.classList.add('active');
  viewerImg.classList.add('active');
  document.addEventListener('keydown',onKey);
  viewer.addEventListener('click',onClick);
  viewer.addEventListener('touchstart',onTouch);
}

function openVideo(i){
  idx=i;
  viewer.style.display='flex';
  viewerVideo.style.display='block';
  viewerVideo.src=PROXY + videos[idx].download_url;
  viewerVideo.load();
  viewer.classList.add('active');
  viewerVideo.classList.add('active');
  viewerVideo.play();
  document.getElementById('viewerInfo').textContent=`${idx+1} / ${videos.length}  ${videos[idx].name.replace(/\.[^/.]+$/,'')}`;
  document.addEventListener('keydown',onKey);
  viewer.addEventListener('click',onClick);
  viewer.addEventListener('touchstart',onTouch);
}

function closeViewer(){
  viewer.classList.remove('active');
  viewerImg.classList.remove('active');
  viewerVideo.classList.remove('active');
  setTimeout(()=>{
    viewer.style.display='none';
    viewerImg.style.display='none';
    viewerVideo.style.display='none';
    viewerVideo.pause();
  },300);
  document.removeEventListener('keydown',onKey);
  viewer.removeEventListener('click',onClick);
  viewer.removeEventListener('touchstart',onTouch);
}

function updateSrc(){
  viewerImg.src=PROXY + imgs[idx].download_url;
  document.getElementById('viewerInfo').textContent=`${idx+1} / ${imgs.length}  ${imgs[idx].name.replace(/\.[^/.]+$/,'')}`;
}

function onKey(e){
  if(e.key==='ArrowLeft') prev();
  if(e.key==='ArrowRight') next();
  if(e.key==='Escape') closeViewer();
}

function onClick(e){
  if(e.target===viewer||e.target.classList.contains('close')){
    closeViewer();
  }else{
    const vw=window.innerWidth;
    e.clientX<vw/3?prev():e.clientX>vw*2/3?next():0;
  }
}

let sx=0;
function onTouch(e){
  sx=e.touches[0].clientX;
  viewer.addEventListener('touchmove',onMove,{passive:true});
  viewer.addEventListener('touchend',onEnd,{once:true});
}

function onMove(e){
  if(Math.abs(e.touches[0].clientX-sx)>50){
    viewerImg.style.transform=`translateX(${e.touches[0].clientX-sx}px)`;
    viewerVideo.style.transform=`translateX(${e.touches[0].clientX-sx}px)`;
  }
}

function onEnd(e){
  const dx=e.changedTouches[0].clientX-sx;
  viewerImg.style.transform='';
  viewerVideo.style.transform='';
  viewer.removeEventListener('touchmove',onMove);
  if(Math.abs(dx)>50){
    dx<0?next():prev();
  }
}

function prev(){
  if(isViewingVideos){
    idx=(idx-1+videos.length)%videos.length;
    viewerVideo.src=PROXY + videos[idx].download_url;
    viewerVideo.load();
    document.getElementById('viewerInfo').textContent=`${idx+1} / ${videos.length}  ${videos[idx].name.replace(/\.[^/.]+$/,'')}`;
  }else{
    idx=(idx-1+imgs.length)%imgs.length;
    updateSrc();
  }
}

function next(){
  if(isViewingVideos){
    idx=(idx+1)%videos.length;
    viewerVideo.src=PROXY + videos[idx].download_url;
    viewerVideo.load();
    document.getElementById('viewerInfo').textContent=`${idx+1} / ${videos.length}  ${videos[idx].name.replace(/\.[^/.]+$/,'')}`;
  }else{
    idx=(idx+1)%imgs.length;
    updateSrc();
  }
}

function toggleLayout(){
  if(currentLayout===1){
    currentLayout=2;
    gallery.className='gallery col-2';
    document.querySelector('.layout-btn i').className='fa fa-th-large';
  }else if(currentLayout===2){
    currentLayout=4;
    gallery.className='gallery col-4';
    document.querySelector('.layout-btn i').className='fa fa-th-list';
  }else{
    currentLayout=1;
    gallery.className='gallery col-1';
    document.querySelector('.layout-btn i').className='fa fa-th';
  }
  if(!isViewingVideos){
    renderThumbs();
  }
}

function loadMusic(){
  fetch(API_URLS.music,{headers:{'Authorization':`token ${GITHUB_TOKEN}`}})
    .then(r=>r.json())
    .then(list=>{
      musicList=list.filter(f=>/\.(mp3|ogg|wav)$/i.test(f.name));
      renderMusicList();
      if(musicList.length>0){
        updateMusicTitle();
      }else{
        currentMusicTitle.textContent='没有找到音乐';
      }
    })
    .catch(()=>{
      currentMusicTitle.textContent='音乐加载失败';
      document.getElementById('musicList').innerHTML='<div class="music-item">加载失败，请稍后重试</div>';
    });
  musicPlayer.addEventListener('timeupdate',updateProgress);
  musicPlayer.addEventListener('loadedmetadata',updateTotalTime);
  musicPlayer.addEventListener('canplay',()=>{
    if(isMusicPlaying){
      musicPlayer.play();
    }
  });
}

let firstMusicClick=true;
function toggleMusicPlayer(){
  if(musicPlayerContainer.style.display==='none'){
    musicPlayerContainer.style.display='block';
    setTimeout(()=>{
      musicPlayerContainer.classList.add('active');
    },50);
    if(firstMusicClick && musicList.length>0){
      playMusic(currentMusicIndex);
      firstMusicClick=false;
    }
  }else{
    musicPlayerContainer.classList.remove('active');
    setTimeout(()=>{
      musicPlayerContainer.style.display='none';
    },300);
  }
}

function updateMusicTitle(){
  if(musicList.length>0){
    currentMusicTitle.textContent=musicList[currentMusicIndex].name.replace(/\.[^/.]+$/,'');
  }
}

function renderMusicList(){
  const musicListElement=document.getElementById('musicList');
  musicListElement.innerHTML='';
  if(musicList.length===0){
    musicListElement.innerHTML='<div class="music-item">没有找到音乐</div>';
    return;
  }
  musicList.forEach((item,index)=>{
    const musicItem=document.createElement('div');
    musicItem.className=`music-item ${index===currentMusicIndex?'active':''}`;
    musicItem.innerHTML=`<div>${item.name.replace(/\.[^/.]+$/,'')}</div>`;
    musicItem.onclick=()=>playMusic(index);
    musicListElement.appendChild(musicItem);
  });
}

function playMusic(index){
  if(index===currentMusicIndex && isMusicPlaying){
    togglePlayPause();
    return;
  }
  currentMusicIndex=index;
  musicPlayer.src=PROXY + musicList[currentMusicIndex].download_url;
  musicPlayer.load();
  isMusicPlaying=true;
  updatePlayPauseButton();
  updateMusicTitle();
  renderMusicList();
}

function togglePlayPause(){
  if(musicPlayer.paused){
    musicPlayer.play().catch(e=>{
      console.error("播放失败:",e);
      alert("由于浏览器限制，需要用户交互后才能播放音乐。请再次点击播放按钮。");
    });
    isMusicPlaying=true;
  }else{
    musicPlayer.pause();
    isMusicPlaying=false;
  }
  updatePlayPauseButton();
}

function updatePlayPauseButton(){
  if(isMusicPlaying){
    playPauseBtn.innerHTML='<i class="fa fa-pause"></i>';
  }else{
    playPauseBtn.innerHTML='<i class="fa fa-play"></i>';
  }
}

function playPrevious(){
  currentMusicIndex=(currentMusicIndex-1+musicList.length)%musicList.length;
  playMusic(currentMusicIndex);
}

function playNext(){
  currentMusicIndex=(currentMusicIndex+1)%musicList.length;
  playMusic(currentMusicIndex);
}

function updateProgress(){
  const percent=(musicPlayer.currentTime/musicPlayer.duration)*100;
  progressBar.style.width=percent+'%';
  currentTime.textContent=formatTime(musicPlayer.currentTime);
}

function updateTotalTime(){
  totalTime.textContent=formatTime(musicPlayer.duration);
}

function formatTime(seconds){
  if(isNaN(seconds)) return '0:00';
  const minutes=Math.floor(seconds/60);
  seconds=Math.floor(seconds%60);
  return `${minutes}:${seconds<10?'0':''}${seconds}`;
}

musicPlayer.addEventListener('ended',()=>{
  playNext();
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>关于她 · 图集</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:#111;color:#fff}
.gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:8px;padding:8px}
.thumb{position:relative;border-radius:4px;overflow:hidden;background:#222;aspect-ratio:1/1;cursor:pointer}
.thumb img{width:100%;height:100%;object-fit:cover;transition:transform .2s}
.thumb:hover img{transform:scale(1.05)}
.thumb .title{position:absolute;left:0;right:0;bottom:0;padding:20px 6px 6px;font-size:12px;
              background:linear-gradient(to top,rgba(0,0,0,.7),transparent);pointer-events:none}

/* 全屏查看层 */
.viewer{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;z-index:999}
.viewer img{max-width:95%;max-height:95%;border-radius:4px;transition:transform .3s ease}
.viewer .info{position:absolute;left:0;right:0;bottom:20px;text-align:center;font-size:16px;color:#fff;text-shadow:0 0 5px #000}
.viewer .close{position:absolute;top:20px;right:20px;font-size:30px;color:#fff;cursor:pointer}
</style>
</head>
<body>

<!-- 缩略图网格 -->
<div id="gallery" class="gallery">
  <div class="loading">加载中…</div>
</div>

<!-- 全屏查看器 -->
<div id="viewer" class="viewer">
  <span class="close" onclick="closeViewer()">&times;</span>
  <img id="viewerImg" />
  <div id="viewerInfo" class="info"></div>
</div>

<script>
const API  = 'https://api.github.com/repos/rjdsq/rjdsq.github.io/contents/img/yunnan';
const PROXY= 'https://gh-proxy.com/';

let imgs=[];           // 图片数组
let idx =0;            // 当前索引


fetch(API)
  .then(r=>r.json())
  .then(list=>{
    imgs=list.filter(f=>/\.(jpe?g|png|gif|webp)$/i.test(f.name));
    renderThumbs();
  })
  .catch(()=>gallery.innerHTML='<div style="text-align:center;padding:40px;color:#666">加载失败，请稍后重试</div>');


function renderThumbs(){
  gallery.innerHTML='';
  imgs.forEach((f,i)=>{
    const box=document.createElement('div');
    box.className='thumb';
    box.innerHTML=`
      <img src="${PROXY+f.download_url}" alt="">
      <div class="title">${f.name.replace(/\.[^/.]+$/,'')}</div>`;
    box.onclick=()=>openViewer(i);
    gallery.appendChild(box);
  });
}


function openViewer(i){
  idx=i;
  viewer.style.display='flex';
  updateSrc();
  document.addEventListener('keydown',onKey);
  viewer.addEventListener('click',onClick);
  viewer.addEventListener('touchstart',onTouch);
}


function closeViewer(){
  viewer.style.display='none';
  document.removeEventListener('keydown',onKey);
  viewer.removeEventListener('click',onClick);
  viewer.removeEventListener('touchstart',onTouch);
}


function updateSrc(){
  viewerImg.src=PROXY+imgs[idx].download_url;
  viewerInfo.textContent=`${idx+1} / ${imgs.length}  ${imgs[idx].name.replace(/\.[^/.]+$/,'')}`;
}


function onKey(e){
  if(e.key==='ArrowLeft') prev();
  if(e.key==='ArrowRight') next();
  if(e.key==='Escape') closeViewer();
}
function onClick(e){
  if(e.target===viewer || e.target.classList.contains('close')) closeViewer();
  else{
    const vw=window.innerWidth;
    e.clientX<vw/3?prev():e.clientX>vw*2/3?next():0;
  }
}


let sx=0;
function onTouch(e){
  sx=e.touches[0].clientX;
  viewer.addEventListener('touchmove',onMove,{passive:true});
  viewer.addEventListener('touchend',onEnd,{once:true});
}
function onMove(e){
  if(Math.abs(e.touches[0].clientX-sx)>50) viewerImg.style.transform=`translateX(${e.touches[0].clientX-sx}px)`;
}
function onEnd(e){
  const dx=e.changedTouches[0].clientX-sx;
  viewerImg.style.transform='';
  viewer.removeEventListener('touchmove',onMove);
  if(Math.abs(dx)>50) dx<0?next():prev();
}


function prev(){idx=(idx-1+imgs.length)%imgs.length;updateSrc();}
function next(){idx=(idx+1)%imgs.length;updateSrc();}
</script>
</body>
</html>

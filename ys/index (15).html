<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GitHub文件管理器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="./music.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
</head>
<style>


/* 1. 为作为图片背景的 file-item 设置定位上下文 */
#fileList.grid .file-item.is-image-grid {
    position: relative;
    overflow: hidden; /* 隐藏图片溢出的部分，确保圆角效果 */
    justify-content: flex-start; /* 覆盖原有的居中对齐 */
    align-items: stretch;

    
}

/* --- 更新后的代码：用于将小图片居中 --- */
#fileList.grid .file-item.is-image-grid .file-thumbnail {
    position: absolute;
    
    /* 核心居中代码 */
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);

    /* 在这里设置您希望的图片大小 */
    width: 100%;  /* 示例：宽度为70px */
    height: 100%; /* 示例：高度为70px */
    
    /* 建议：让图片自适应其小容器 */
    object-fit: cover; 
    
    /* 建议：为小图片本身添加圆角 */
    border-radius: 0.3rem; 
    
    z-index: 1;
    margin-bottom: 0;
}

/* 3. 让文件信息层叠加在图片之上 */
/* --- 最终解决方案：使用绝对定位将信息块固定在左下角 --- */
#fileList.grid .file-item.is-image-grid .file-info {
    /* 核心改动：切换为绝对定位 */
    position: absolute;
    bottom: 0; /* 距离底部 0px */
    left: 0;   /* 距离左侧 0px */
    right: 0;  /* 撑满整个宽度 */

    /* 以下是您熟悉的视觉样式，保持不变 */
    z-index: 2; /* 确保在图片之上 */
    padding: 0.8rem 0.4rem 0.3rem; /* 调整内边距 */
    text-align: left; /* 内部文字左对齐 */
    background: linear-gradient(to top, rgba(0, 0, 0, 0.85) 0%, rgba(0, 0, 0, 0.6) 50%, transparent 100%);
}

/* 4. 修改叠加层中文字的颜色和样式 */
#fileList.grid .file-item.is-image-grid .file-name,
#fileList.grid .file-item.is-image-grid .file-meta {
    color: #ffffff; /* 将文字颜色改为白色以保证清晰 */
    text-shadow: 1px 1px 3px rgba(0,0,0,0.5); /* 添加轻微的文字阴影 */
}

#fileList.grid .file-item.is-image-grid .file-name {
    font-size: 0.6rem; /* 可以微调字体大小 */
    -webkit-line-clamp: 2; /* 保持最多两行 */
    le
    padding:2px;
            margin:0px;
}

#fileList.grid .file-item.is-image-grid .file-meta {
    font-size: 0.5rem; /* 元数据字体可以更小一些 */
    opacity: 0.9;
        padding:2px;
        margin:0px;
}

    * {
        -webkit-tap-highlight-color: transparent;
        outline: none;
        box-sizing: border-box;
    }
    body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        background: radial-gradient(ellipse at bottom, #1B2C4F 0%, #04091A 100%);
        color: #f3f4f6;
        min-height: 100vh;
        overflow-x: hidden;
    }
    #authScreen {
        height: 100vh;
        display: flex;
        flex-direction: column;
        padding: 1rem;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        overflow: auto;
    }
    .auth-header {
        text-align: center;
        margin-bottom: 1.5rem;
    }
    .auth-header i {
        font-size: 2.5rem;
        color: #6366f1;
        text-shadow: 0 0 10px rgba(99, 102, 241, 0.6);
        margin-bottom: 0.8rem;
    }
    .auth-header h1 {
        font-size: 1.8rem;
        font-weight: 700;
        color: #E0E7FF;
        letter-spacing: 0.05em;
        margin-bottom: 0.4rem;
    }
    .auth-header p {
        font-size: 0.8rem;
        color: #A2A7C7;
        line-height: 1.4;
        max-width: 280px;
        margin: 0 auto;
    }
    .auth-form {
        background: rgba(17, 24, 39, 0.95);
        border-radius: 0.6rem;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6),
                    0 0 0 1px rgba(255, 255, 255, 0.08);
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
        width: 100%;
        max-width: 320px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .auth-form:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.7),
                    0 0 0 1px rgba(255, 255, 255, 0.12);
    }
    #tokenInput {
        background-color: #0B1220;
        border: 1px solid #374151;
        border-radius: 0.4rem;
        padding: 0.6rem 0.8rem;
        font-size: 0.9rem;
        color: #E0E7FF;
        outline: none;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    #tokenInput::placeholder {
        color: #7B859A;
    }
    #tokenInput:focus {
        border-color: #0ea5e9;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.4), 0 0 0 2px rgba(14, 165, 233, 0.3);
    }
    #authBtn {
        background: linear-gradient(90deg, #6366f1, #0ea5e9);
        border-radius: 0.4rem;
        padding: 0.7rem 1rem;
        font-weight: 600;
        font-size: 0.95rem;
        letter-spacing: 0.03em;
        border: none;
        color: white;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        transition: all 0.3s ease;
    }
    #authBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.7);
        background: linear-gradient(90deg, #0ea5e9, #6366f1);
    }
    #authBtn:active {
        transform: translateY(0);
        box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
    }
    #app {
        flex-direction: column;
        height: 100vh;
        display: flex;
    }
    header {
        background-color: rgba(17, 24, 39, 0.8);
        backdrop-filter: blur(10px);
        box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2), -1px -1px 3px rgba(75, 85, 99, 0.05);
        padding: 0.3rem 0.6rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }
    .header-left {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        min-width: 0;
    }
    .header-left i {
        color: #9ca3af;
        font-size: 0.9rem;
    }
    .header-right {
        display: flex;
        align-items: center;
        gap: 0.2rem;
    }
    #currentRepo {
        font-weight: bold;
        font-size: 0.75rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1;
        min-width: 0;
    }
    #mainMenuBtn {
        padding: 0.3rem;
        border-radius: 9999px;
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        transition: background-color 0.2s;
        min-width: 36px;
        min-height: 36px;
    }
    #mainMenuBtn:hover {
        background-color: rgba(107, 114, 128, 0.2);
    }
   
    #pathNav {
        display: flex;
        gap: 0.2rem;
        font-size: 0.6rem;
    }
    #pathNav span {
        cursor: pointer;
    }
    #pathNav span:hover {
        color: #d1d5db;
    }
    #toolbar {
        background-color: rgba(17, 24, 39, 0.8);
        backdrop-filter: blur(10px);
        border-top: 1px solid #1f2937;
        border-bottom: 1px solid #1f2937;
        padding: 0.3rem 0.5rem;
        display: flex;
        gap: 0.3rem;
        align-items: center;
        flex-shrink: 0;
        position: relative; 
        z-index: 40; 
    }
    #toolbar .toolbar-left {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }
    #toolbar .toolbar-right {
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }
    #searchInput {
        display: none;
        flex: 1;
        min-width: 100px;
        padding: 0.3rem 0.5rem;
        background: #030712;
        color: #f3f4f6;
        border: 1px solid #374151;
        border-radius: 0.3rem;
        outline: none;
        margin-left: 0.3rem;
        font-size: 0.8rem;
        transition: all 0.2s ease-in-out;
    }
    .custom-select-container {
        position: relative;
        display: inline-block;
    }
    .custom-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        background-color: #111827;
        border: 1px solid #374151;
        border-radius: 0.3rem;
        box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.06);
        min-width: 120px;
        
        z-index: 30;
        overflow: hidden;
        padding: 0.1rem 0;
    }
    .dropdown-item {
        padding: 0.4rem 0.6rem;
        cursor: pointer;
        color: #f3f4f6;
        font-size: 0.7rem;
        white-space: nowrap;
        transition: background-color 0.2s;
    }
    .dropdown-item:hover {
        background-color: rgba(107, 114, 128, 0.2);
    }
    .dropdown-item.selected {
        background-color: #1f2937;
        color: #22c55e;
        font-weight: bold;
    }
    #viewToggleBtn {
        padding: 0.3rem;
        background: none;
        border: 1px solid #374151;
        color: #f3f4f6;
        border-radius: 0.3rem;
        cursor: pointer;
        font-size: 0.75rem;
    }
    #viewToggleBtn.active {
        background: #1f2937;
    }
    main {
        flex: 1;
        overflow-y: auto;
        padding-bottom: 60px;
    }
    #repoList,
    #fileList {
        padding: 0.5rem;
        margin:5px;
    }
    .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        
        padding: 1.2rem 0;
        grid-column: 1 / -1;

    align-items: center; /* 垂直居中 */
    height: 80vh; /* 占满整个视口高度，确保垂直居中 */
    
    }
    .spinner {
        animation: spin 1s linear infinite;
        border-radius: 9999px;
        height: 2.5rem;
        width: 2.5rem;
        border-top: 2px solid #6366f1;
    border-bottom: 2px solid #6366f1;

    }
    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
    footer {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(17, 24, 39, 0.8);
        backdrop-filter: blur(10px);
        box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2), -1px -1px 3px rgba(75, 85, 99, 0.05);
        padding: 0.6rem 0.5rem;
        display: flex;
        justify-content: space-around;
        flex-shrink: 0;
                z-index: 5;
    }
    footer button {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 0.3rem;
        width: 25%;
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        min-height: 36px;
    }
    footer button i {
        font-size: 0.9rem;
    }
    #editModal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.8);
        z-index: 50;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.6rem;
    }
    .modal-content {
        box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2), -1px -1px 3px rgba(75, 85, 99, 0.05);
        background-color: #111827;
        border-radius: 0.4rem;
        display: flex;
        flex-direction: column;
        width: 100%;
        max-width: 90vw;
        min-height: 40vh;
        max-height: 90vh;
        overflow: hidden;
    }
    @media (min-width: 768px) {
        .modal-content {
            max-width: 70rem;
        }
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-left: 0.4rem;
        height: auto;
        padding-top: 6px;
        padding-bottom: 6px;
        flex-shrink: 0;
    }
    .modal-header h5 {
        font-size: 0.7rem;
        font-weight: bold;
        margin: 0;
    }
    #closeEditModal,
    #toggleMaximizeModal {
        padding: 0.3rem;
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        border-radius: 9999px;
        font-size: 0.9rem;
    }
    #closeEditModal:hover,
    #toggleMaximizeModal:hover {
        background-color: rgba(107, 114, 128, 0.2);
    }
    #editStatus {
        margin: 0.1rem 0.4rem;
        border-radius: 0.3rem;
        font-size: 0.65rem;
        text-align: center;
    }
    .editor-container {
        flex: 1;
        overflow: hidden;
        position: relative;
        display: flex;
        justify-content: center;
        padding: 0 0.4rem 0.4rem 0.4rem;
    }
    #editorOverlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: rgba(17, 24, 39, 0.7);
        z-index: 10;
        border-radius: 0.3rem;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }
    #editorOverlay.show {
        opacity: 1;
        pointer-events: auto;
    }
    #saveNotification {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background-color: rgba(15, 81, 50, 0.9);
        color: white;
        padding: 3px 6px;
        border-radius: 3px;
        font-size: 12px;
        z-index: 5;
        opacity: 0;
        transform: translateY(-8px);
        transition: opacity 0.3s ease, transform 0.3s ease;
    }
    #saveNotification.show {
        opacity: 1;
        transform: translateY(0);
    }
    #fileContent {
        box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.2), inset -1px -1px 3px rgba(75, 85, 99, 0.05);
        background-color: #030712;
        width: 100%;
        height: 100%;
        outline: none;
        min-height: 40VH;
        box-sizing: border-box;
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow-wrap: break-word;
        overflow: auto;
        max-width: 1000px;
        border-top: 1px solid #374151;
        border-bottom: 1px solid #374151;
        color: #a2a7c7;
        resize: none;
        border: none;
        padding:0.6rem;
        align-items: center;
    }
    .modal-footer {
        display: flex;
        gap: 0.4rem;
        height: 35px;
                margin:12px;
        flex-shrink: 0;
    }
    .modal-footer button {
        flex: 1;
        border-radius: 0.3rem;
        border: none;
        cursor: pointer;
        font-size: 0.85rem;


        
    }
    #cancelEdit {
        background-color: #374151;
        color: white;
    }
    #cancelEdit:hover {
        background-color: #4b5563;
    }
    #saveEdit {
        background-color: #6366f1;
        color: white;
    }
    #saveEdit:hover {
        background-color: #5a5edb;
    }
    #uploadPanel {
        position: fixed;
        bottom: 3.5rem;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(17, 24, 39, 0.8);
        backdrop-filter: blur(10px);
        box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2), -1px -1px 3px rgba(75, 85, 99, 0.05);
        border-radius: 0.3rem;
        padding: 0.6rem;
        width: 90%;
        max-width: 26rem;
        font-size: 0.75rem;
    }
    .upload-progress .percent-text {
        color: #f3f4f6;
        font-size: 0.6rem;
        font-weight: bold;
        white-space: nowrap;
        padding: 0 4px;
        position: absolute;
        right: -1px;
        top: 50%;
        transform: translateY(-50%) translateX(100%);
        transition: transform 0.3s ease;
    }
    .upload-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        font-size: 0.8rem;
        min-width: 0;
    }
    .upload-name {
        flex: 1 1 0;
        min-width: 0;
        max-width: 70%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: inline-block;
    }
    .upload-size {
        margin-left: 5px;
        color: #9ca3af;
        flex-shrink: 0;
        font-size: 0.8em;
    }
    #uploadItems {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        max-height: 6rem;
        overflow-y: auto;
    }
    #modalOverlay {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        margin: auto;
        z-index: 100;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.6rem;
        background-color: rgba(0, 0, 0, 0.7);
    }
    #modalOverlay .modal-content {
        max-width: 90vw;
        width: 100%;
        min-height: unset;
        max-height: unset;
        padding: 0;
    }
    #contextMenu {
        position: fixed;
        background-color: rgba(17, 24, 39, 0.8);
        backdrop-filter: blur(10px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2), 0 1px 2px rgba(75, 85, 99, 0.04);
        border-radius: 0.3rem;
        z-index: 50;
        min-width: 120px;
        max-width: 180px;
        overflow: hidden;
    }
    #contextMenuItems a {
        display: block;
        padding: 0.3rem 0.6rem;
        font-size: 0.75rem;
        color: white;
        text-decoration: none;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    #contextMenuItems a:hover {
        background-color: rgba(107, 114, 128, 0.2);
    }
    #contextMenuItems a i {
        margin-right: 0.5rem;
    }
    #toast {
        position: fixed;
        bottom: 3.5rem;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(17, 24, 39, 0.9);
        backdrop-filter: blur(10px);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        padding: 0.5rem 1rem;
        border-radius: 9999px;
        z-index: 101;
        font-size: 0.85rem;
        color: #e0e7ff;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .hidden {
        display: none !important;
    }
    #mainMenuPopup {
        position: fixed;
        top: 3rem;
        right: 0.6rem;
        z-index: 50;
        background-color: #111827;
        border-radius: 0.3rem;
        box-shadow: 0 1px 2px -1px rgba(0, 0, 0, 0.08), 0 0.5px 1px -1px rgba(0, 0, 0, 0.04);
        border: 1px solid #374151;
        min-width: 100px;
        text-align: center;
        font-size: 0.8rem;
        overflow: hidden;
    }
    #mainMenuPopup button {
        width: 100%;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.7rem;
        background: none;
        border: none;
        color: white;
        text-align: left;
        cursor: pointer;
        font-size: 0.85rem;
    }
    #mainMenuPopup button:hover {
        background-color: rgba(107, 114, 128, 0.2);
    }
    .file-item {
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2), 0 0.5px 1px rgba(75, 85, 99, 0.05);
        background-color: #111827;
        border-radius: 0.3rem;
        padding: 0.3rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.6rem;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .file-item:hover {
        background-color: rgba(107, 114, 128, 0.15);
    }
    .file-icon {
        width: 1.8rem;
        height: 1.8rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.3rem;
        background-color: rgba(17, 24, 39, 0.5);
        flex-shrink: 0;
    }
    .file-icon i {
        font-size: 1rem;
        color: #e0e7ff;
    }
    .file-item .file-thumbnail {
        width: 2.4rem;
        height: 2.6rem;
        object-fit:cover;
        border-radius: 0.3rem;
        background-color: rgba(17, 24, 39, 0.5);
        flex-shrink: 0;
    }
    .file-info {
        flex: 1;
        min-width: 0;
    }
    .file-name {
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 0.8rem;
        color: #e0e7ff;
    }
    .file-meta {
        font-size: 0.7rem;
        color: #9ca3af;
        margin-top: 0.1rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.3;
    }
    #multiActionBar {
        width: 100%;
        position: fixed;
        bottom: 3.8rem;
        padding: 0;
        left: 0;
        right: 0;
        display: flex;
        align-items: center;
        justify-content: space-around;
        background-color: rgba(17, 24, 39, 0.8);
        backdrop-filter: blur(10px);
        padding: 0.3rem 0;
        z-index: 20;
    }
    #multiActionBar button {
        width: 14%;
        height: 2.2rem;
        margin: 0.2rem;
        border: none;
        border-radius: 0.3rem;
        background: linear-gradient(90deg, #0ea5e9, #6366f1);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 0.85rem;
    }
    #selectedCount {
        color: white;
        font-weight: bold;
        font-size: 0.85rem;
        margin: 0 0.3rem;
        text-align: right;
        margin-right: 15%;
    }
    .multi-select-checkbox {
        margin-right: 0.3rem;
    }
    .empty-state {
        text-align: center;
        padding: 1.5rem 0;
        color: #9ca3af;
    }
    .empty-state i {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        color: #6366f1;
    }
    .empty-state p {
        font-size: 0.85rem;
    }
    #mediaPreview {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.9);
        z-index: 60;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 8px;
    }
    #mediaPreview img,
    #mediaPreview video {
        max-width: 95%;
        max-height: 95vh;
        object-fit: contain;
        display: block;
        margin: auto;
    }
    #fileList.grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 0.4rem;
    }
    #fileList.grid .file-item {
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        gap: 0.2rem;
        padding: 0.5rem;
        min-height: 90px;
    }
    #fileList.grid .file-icon {
        width: 2.2rem;
        height: 2.2rem;
        margin-bottom: 0.3rem;
    }
    #fileList.grid .file-icon i {
        font-size: 1.2rem;
    }
    #fileList.grid .file-thumbnail {
        width: 3.2rem;
        height: 3.2rem;
        margin-bottom: 0.3rem;
        
    }
    #fileList.grid .file-name {
        font-size: 0.75rem;
        max-width: 100%;
        white-space: normal;
        word-break: break-all;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    #fileList.grid .file-meta {
        -webkit-line-clamp: 1;
        font-size: 0.65rem;
    }
    @media (max-width: 640px) {
        footer button {
            width: 20%;
        }
        #multiActionBar button {
            width: 18%;
        }
    }
    .btn {
        border-radius: 0.3rem;
        border: none;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s, opacity 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.3rem;
        white-space: nowrap;
        padding: 0.4rem 0.7rem;
        min-height: 36px;
    }
    .btn-primary {
        background: #22c55e;
        color: #fff;
    }
    .btn-primary:hover:not(:disabled) {
        background: #16a34a;
    }
    .btn-danger {
        background: #ef4444;
        color: #fff;
    }
    .btn-danger:hover:not(:disabled) {
        background: #dc2626;
    }
    .btn-cancel {
        background: #374151;
        color: #f3f4f6;
    }
    .btn-cancel:hover:not(:disabled) {
        background: #4b5563;
    }
    .btn-secondary {
        background-color: #374151;
        color: #f3f4f6;
        font-size: 0.75rem;
        padding: 0.3rem 0.6rem;
    }
    .btn-secondary:hover:not(:disabled) {
        background-color: #4b5563;
    }
    .btn:disabled,
    .btn.disabled {
        background: #6b7280 !important;
        color: #ccc !important;
        cursor: not-allowed !important;
        opacity: 0.7;
    }
    .btn-icon {
        background: none;
        border: none;
        color: #f3f4f6;
        cursor: pointer;
        padding: 0.4rem;
        border-radius: 9999px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s, color 0.2s;
        flex-shrink: 0;
        font-size: 0.9rem;
        min-width: 38px;
        min-height: 38px;
    }
    .btn-icon:hover:not(:disabled) {
        background-color: rgba(107, 114, 128, 0.2);
    }
    .btn-icon.active {
        color: #22c55e;
    }
    .btn-icon.danger {
        color: #ef4444;
    }
    .btn-icon.danger:hover:not(:disabled) {
        background-color: rgba(239, 68, 68, 0.2);
    }
    .btn-icon-sm {
        background: none;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        padding: 0.2rem;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s, color 0.2s;
        flex-shrink: 0;
        font-size: 0.95rem;
    }
    .btn-icon-sm:hover:not(:disabled) {
        background-color: rgba(107, 114, 128, 0.2);
        color: #f3f4f6;
    }
    .btn-icon-sm.active {
        color: #22c55e;
    }
    .btn-icon-sm.danger {
        color: #ef4444;
    }
    .btn-icon-sm.danger:hover:not(:disabled) {
        background-color: rgba(239, 68, 68, 0.2);
    }
    .modal-form-container {
        background: #111827;
        border-radius: 0.4rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2), 0 0.5px 1.5px rgba(75, 85, 99, 0.04);
        padding: 0.8rem;
        max-width: 320px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        min-width: 280px;
        width: 100%;
    }
    .modal-form-container h3 {
        font-size: 0.95rem;
        font-weight: bold;
        color: #f3f4f6;
        margin-bottom: 0.3rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .modal-form-container h3 .modal-title-text {
        flex: 1;
        margin-right: 0.4rem;
    }
    .modal-form-container p {
        color: #9ca3af;
        font-size: 0.75rem;
        line-height: 1.4;
        margin-bottom: 0.3rem;
    }
    .modal-form-container input,
    .modal-form-container textarea {
        background: #030712;
        color: #f3f4f6;
        border: 1px solid #374151;
        border-radius: 0.3rem;
        padding: 0.4rem 0.5rem;
        font-size: 0.8rem;
        outline: none;
        margin-bottom: 0.3rem;
        transition: border 0.2s;
    }
    .modal-form-container input:focus,
    .modal-form-container textarea:focus {
        border-color: #6366f1;
    }
    .modal-form-container textarea {
        min-height: 70px;
        resize: vertical;
    }
    .modal-buttons {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
        flex-wrap: wrap;
        justify-content: flex-end;
    }
    .modal-buttons button {
        flex: 1;
        min-width: 60px;
        height: 34px;
    }
    .checkbox-container {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        margin-bottom: 0.3rem;
        font-size: 0.85rem;
        color: #f3f4f6;
    }
    @media (max-width: 480px) {
        .modal-form-container {
            max-width: 70vw;
            padding: 0.7rem 0.5rem;
            min-width: unset;
        }
        .modal-buttons button {
            flex-grow: 1;
            width: auto;
        }
    }
    .modal-overlay {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        margin: auto;
        z-index: 100;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.6rem;
        background-color: rgba(0, 0, 0, 0.8);
    }
    .hidden {
        display: none !important;
    }
    .upload-progress-container {
        height: 10px;
        background: #374151;
        border-radius: 3px;
        overflow: hidden;
        margin: 3px 0;
        position: relative;
    }
    .upload-progress {
        height: 100%;
        width: 0;
        background: linear-gradient(90deg, #22c55e, #0ea5e9, #6366f1, #f472b6, #f59e42, #22c55e);
        background-size: 200% 100%;
        animation: rainbow-bar 2s linear infinite;
        transition: width 0.3s;
        border-radius: 3px;
        display: flex;
        align-items: center;
        justify-content: flex-end;
    }
    @keyframes rainbow-bar {
        0% {
            background-position: 0% 50%;
        }
        100% {
            background-position: 100% 50%;
        }
    }
    .upload-status {
        text-align: right;
        margin-top: 4px;
        font-size: 0.7rem;
    }
    .upload-status.success {
        color: #22c55e;
    }
    .upload-status.error {
        color: #ef4444;
    }
    .text-red-400 {
        color: #f87171 !important;
    }
    .text-green-500 {
        color: #22c55e !important;
    }
    .text-orange-400 {
        color: #fb923c !important;
    }
    .text-gray-400 {
        color: #9ca3af !important;
    }
    #proxyQuickToggle {
        padding: 0.3rem;
        background: none;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        border-radius: 9999px;
        transition: background-color 0.2s, color 0.2s;
        font-size: 1rem;
        min-width: 36px;
        min-height: 36px;
    }
    #proxyQuickToggle:hover {
        background-color: rgba(107, 114, 128, 0.2);
    }
    #proxyQuickToggle.active {
        color: #22c55e;
    }
    #proxySettingsModal .modal-form-container {
        max-width:95%;
        padding: 0.9rem;
        gap: 0.7rem;
    }
    #proxySettingsModal .proxy-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #374151;
        border-radius: 0.3rem;
        background-color: #030712;
        padding: 0.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    .proxy-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        background-color: #111827;
        padding: 1.8rem;
        border: 2px solid transparent;
        border-radius: 0.3rem;
        font-size: 0.75rem;
        min-height: 38px;
        position: relative;
        transition: border-color 0.2s;
        flex-wrap: nowrap;
        cursor: pointer;
    }
    .proxy-item.active {
        border-color: #22c55e;
    }
    .proxy-item .proxy-info {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    .proxy-item .proxy-url {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-weight: 500;
        line-height: 1.2;
    }
    .proxy-item .proxy-latency {
        flex-shrink: 0;
        font-weight: bold;
        min-width: 60px;
        text-align: left;
        font-size: 0.65rem;
        margin-top: 0.1rem;
    }
    .proxy-item .proxy-type {
        font-size: 0.65rem;
        color: #6b7280;
        margin-top: 0.1rem;
    }
    .proxy-item .proxy-actions {
        display: flex;
        gap: 0.1rem;
        flex-shrink: 0;
        flex-wrap: nowrap;
        justify-content: flex-end;
        align-items: center;
        margin-left: auto;
    }
    #proxyGlobalEnableToggle {
        font-size: 1.1rem;
        padding: 0.3rem;
        min-width: 40px;
        min-height: 40px;
    }
    #proxyGlobalEnableToggle.active {
        color: #22c55e;
    }
    #proxyGlobalEnableToggle.disabled {
        color: #9ca3af;
        cursor: not-allowed;
    }
    #addEditProxyModal .modal-form-container {
        max-width: 320px;
        padding: 0.9rem;
        gap: 0.7rem;
    }
    #addEditProxyModal .modal-buttons {
        margin-top: 0.5rem;
        flex-wrap: wrap;
    }
    #addEditProxyTestBtn {
        flex: 0 0 auto;
        min-width: 80px;
        padding: 0.4rem 0.7rem;
        font-size: 0.8rem;
        height: 34px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.3rem;
    }
    #addEditProxyTestResult {
        flex: 1;
        text-align: right;
        font-size: 0.75rem;
        min-height: 1rem;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding: 0 0.3rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    #toggleMaximizeModal {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    #editModal.maximized {
        padding: 0 !important;
    }
    #editModal.maximized .modal-content {
        width: 100vw !important;
        height: 100vh !important;
        max-width: 100vw !important;
        min-height: 100vh !important;
        border-radius: 0 !important;
        margin: 0 !important;
        display: flex;
        flex-direction: column;
    }
    #editModal.maximized .editor-container {
        height: calc(100vh - 80px) !important;
        flex: 1;
        overflow: hidden;
    }
    #editModal.maximized #fileContent {
        height: 100% !important;
        min-height: unset !important;
    }
    #editModal.maximized .modal-header,
    #editModal.maximized .modal-footer {
        flex-shrink: 0;
    }
    .spinner-small {
        animation: spin 1s linear infinite;
        border-radius: 9999px;
        height: 0.8em;
        width: 0.8em;
        border-top: 1px solid currentColor;
        border-bottom: 1px solid currentColor;
        vertical-align: middle;
        margin-left: 0.2em;
        flex-shrink: 0;
    }
    #confirmDeleteProxyModal .modal-form-container {
        max-width: 280px;
        padding: 1rem;
        gap: 0.7rem;
    }
    #confirmDeleteProxyModal h3 {
        font-size: 0.9rem;
    }
    #confirmDeleteProxyModal p {
        font-size: 0.75rem;
        line-height: 1.4;
    }
    #confirmDeleteProxyModal .modal-buttons button {
        height: 34px;
        font-size: 0.8rem;
    }
    #confirmClearAllProxiesModal .modal-form-container {
        max-width: 320px;
        padding: 1rem;
        gap: 0.7rem;
    }
    #confirmClearAllProxiesModal h3 {
        font-size: 0.9rem;
    }
    #confirmClearAllProxiesModal p {
        font-size: 0.75rem;
        line-height: 1.4;
    }
    #confirmClearAllProxiesModal .modal-buttons button {
        height: 34px;
        font-size: 0.8rem;
    }
    .proxy-type-selection {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
        margin-top: 0.3rem;
    }
    .proxy-type-selection label {
        font-size: 0.75rem;
        color: #f3f4f6;
        margin-bottom: 0.1rem;
    }
    .proxy-type-display {
        background-color: #030712;
        border: 1px solid #374151;
        border-radius: 0.3rem;
        padding: 0.5rem 0.6rem;
        font-size: 0.8rem;
        color: #9ca3af;
        display: flex;
        justify-content: space-between;
        align-items: center;
        min-height: 34px;
    }
    .proxy-type-display span {
        flex: 1;
    }
    .proxy-type-display i {
        margin-left: 0.5rem;
        color: #22c55e;
        flex-shrink: 0;
    }
    


</style>
<body>

    <div id="authScreen">
        <div class="auth-header">
            <i class="fa fa-github"></i>
            <h1>GitHub文件管理器</h1>
            <p>您的安全企业文件门户</p>
        </div>
        <div class="auth-form">
            <input type="text" id="tokenInput" placeholder="输入GitHub访问令牌">
            <button id="authBtn">登录</button>
        </div>
    </div>
    <div id="app" class="hidden">
        <header>
            <div class="header-left">
                <i class="fa fa-github"></i>
                <h1 id="currentRepo">选择仓库</h1>
                <div id="pathNav"></div>
                <div id="pathNavContainer"></div>
            </div>

            <div class="header-right">
                <button id="proxyQuickToggle" title="代理已开启">
                    <i class="fa fa-plug"></i>
                </button>
                <button id="mainMenuBtn" title="菜单">
                    <i class="fa fa-ellipsis-v"></i>
                </button>
            </div>
                    
        </header>

        <div id="toolbar" class="hidden">
            <div class="toolbar-left">
                <input id="searchInput" placeholder="搜索文件/文件夹..." class="hidden">
            </div>
                            <button id="searchToggleBtn" class="btn-icon" title="搜索">
                    <i class="fa fa-search"></i>
                </button>
            <div class="toolbar-right">
                <div class="custom-select-container">
                    <button id="sortToggleBtn" class="btn-icon" title="排序">
                        <i class="fa fa-sort"></i>
                    </button>
                    <div id="customSortDropdown" class="hidden custom-dropdown">
                        <div class="dropdown-item" data-value="name_asc">名称 A→Z</div>
                        <div class="dropdown-item" data-value="name_desc">名称 Z→A</div>
                        <div class="dropdown-item" data-value="time_desc">时间 最新优先</div>
                        <div class="dropdown-item" data-value="time_asc">时间 最旧优先</div>
                        <div class="dropdown-item" data-value="size_desc">大小 大→小</div>
                        <div class="dropdown-item" data-value="size_asc">大小 小→大</div>
                    </div>
                </div>
                <button id="viewToggleBtn" title="切换视图">
                    <i class="fa fa-th-large"></i>
                </button>
            </div>
        </div>
        <main>
            <div id="repoList">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
            </div>
            <div id="fileList" class="hidden">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
            </div>
        </main>
        <div id="renameModal" class="modal-overlay hidden">
            <div class="modal-form-container">
                <h3 id="renameTitle"><span class="modal-title-text">重命名</span><button class="btn-icon-sm"
                        onclick="el.renameModal.classList.add('hidden')" title="关闭"><i
                            class="fa fa-times"></i></button></h3>
                <input type="text" id="renameInput" value="" autocomplete="off">
                <div id="renameWarn" class="text-red-400"
                    style="font-size: 0.75rem; margin-top: -0.4rem; margin-bottom: 0.4rem; display: none;"></div>
                <div class="modal-buttons">
                    <button id="renameCancel" class="btn btn-cancel">取消</button>
                    <button id="renameConfirm" class="btn btn-primary" disabled>确认</button>
                </div>
            </div>
        </div>
        <div id="deleteModal" class="modal-overlay hidden">
            <div class="modal-form-container">
                <h3 id="deleteTitle"><span class="modal-title-text">确认删除</span><button class="btn-icon-sm"
                        onclick="el.deleteModal.classList.add('hidden')" title="关闭"><i
                            class="fa fa-times"></i></button></h3>
                <p id="deleteDesc"></p>
                <div class="modal-buttons">
                    <button id="deleteCancel" class="btn btn-cancel">取消</button>
                    <button id="deleteConfirm" class="btn btn-danger">确认删除</button>
                </div>
            </div>
        </div>
        <div id="editModal" class="hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="editFileName">编辑文件</h5>
                    <div style="display:flex; gap:0.4rem;">
                        <button id="toggleMaximizeModal" title="最大化">
                            <i class="fa fa-expand"></i>
                        </button>
                        <button id="closeEditModal">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                </div>
                <div id="editStatus"></div>
                <div class="editor-container">
                    <div id="editorOverlay">
                        <div class="spinner-container">
                            <i class="fa fa-spinner fa-spin"></i>
                        </div>
                    </div>
                    <div id="saveNotification">
                        <i class="fa fa-check"></i> 保存成功
                    </div>
                    <textarea id="fileContent"></textarea>
                </div>
                <div class="modal-footer">
                    <button id="cancelEdit">取消</button>
                    <button id="saveEdit">保存修改</button>
                </div>
            </div>
        </div>
        <div id="modalOverlay" class="hidden">
            <div class="modal-content">
                <div id="modalContent"></div>
            </div>
        </div>
        <div id="contextMenu" class="hidden">
            <div id="contextMenuItems"></div>
        </div>
        <div id="toast" class="hidden">
            <span id="toastMessage"></span>
        </div>
        <input type="file" id="fileUploadInput" multiple class="hidden">
        <div id="mainMenuPopup" class="hidden">
            <button id="menuLogout">
                <i class="fa fa-sign-out"></i> 退出登录
            </button>
            <button id="menuRepoList">
                <i class="fa fa-list"></i> 仓库列表
            </button>
            <button id="menuProxySettings">
                <i class="fa fa-plug"></i> 代理设置
            </button>
            <button id="menuClearCache">
                <i class="fa fa-trash"></i> 清除缓存
            </button>
            <button id="menuRefresh">
                <i class="fa fa-refresh"></i> 刷新页面
            </button>
        </div>
        <footer>
            <button id="backBtn" title="返回上级">
                <i class="fa fa-arrow-up"></i>
            </button>
            <button id="newFolderBtn" title="新建仓库">
                <i class="fa fa-plus"></i>
            </button>
            <button id="newFileBtn" title="新建文件">
                <i class="fa fa-file-o"></i>
            </button>
            <button id="uploadBtn" title="上传文件">
                <i class="fa fa-upload"></i>
            </button>
        </footer>
        <div id="mediaPreview" class="hidden">
            <img id="mediaPreviewImg" style="display:none;" alt="预览图片">
            <video id="mediaPreviewVideo" style="display:none;" controls></video>
        </div>
        <div id="createRepoModal" class="modal-overlay hidden">
            <div class="modal-form-container">
                <h3><span class="modal-title-text">新建仓库</span><button class="btn-icon-sm"
                        onclick="el.createRepoModal.classList.add('hidden')" title="关闭"><i
                            class="fa fa-times"></i></button></h3>
                <input id="createRepoNameInput" placeholder="输入仓库名称（仅支持英文、数字、连字符）">
                <div id="repoNameError" class="text-red-400"
                    style="font-size: 0.75rem; margin-top: -0.4rem; margin-bottom: 0.4rem; display: none;"></div>
                <textarea id="createRepoDescInput" placeholder="仓库描述（可选）"></textarea>
                <div class="checkbox-container">
                    <input type="checkbox" id="createRepoPrivate">
                    <label for="createRepoPrivate">公开仓库</label>
                </div>
                <div class="modal-buttons">
                    <button id="createRepoCancel" class="btn btn-cancel">取消</button>
                    <button id="createRepoConfirm" class="btn btn-primary" disabled>创建仓库</button>
                </div>
            </div>
        </div>
        <div id="createFolderModal" class="modal-overlay hidden">
            <div class="modal-form-container">
                <h3><span class="modal-title-text">新建文件夹</span><button class="btn-icon-sm"
                        onclick="el.createFolderModal.classList.add('hidden')" title="关闭"><i
                            class="fa fa-times"></i></button></h3>
                <input id="createFolderInput" placeholder="输入文件夹名称">
                <div class="modal-buttons">
                    <button id="createFolderCancel" class="btn btn-cancel">取消</button>
                    <button id="createFolderConfirm" class="btn btn-primary" disabled>确认</button>
                </div>
            </div>
        </div>
        <div id="createFileModal" class="modal-overlay hidden">
            <div class="modal-form-container">
                <h3><span class="modal-title-text">新建文件</span><button class="btn-icon-sm"
                        onclick="el.createFileModal.classList.add('hidden')" title="关闭"><i
                            class="fa fa-times"></i></button></h3>
                <input id="createFileNameInput" placeholder="输入文件名，如 example.txt">
                <textarea id="createFileContentInput" placeholder="文件内容（可选）"></textarea>
                <div class="modal-buttons">
                    <button id="createFileCancel" class="btn btn-cancel">取消</button>
                    <button id="createFileConfirm" class="btn btn-primary" disabled>确认</button>
                </div>
            </div>
        </div>
        <div id="uploadPanel" class="hidden">
            <div id="uploadItems" class="scmz"></div>
        </div>
        <div id="proxySettingsModal" class="modal-overlay hidden">
            <div class="modal-form-container">
                <h3>
                    <span class="modal-title-text">代理设置</span>
                    <button id="proxyGlobalEnableToggle" class="btn-icon" title="点击切换全局代理状态">
                        <i class="fa fa-power-off"></i>
                    </button>
                </h3>
                <div class="proxy-list" id="proxyListContainer">
                    <div class="empty-state" id="proxyListEmpty" style="padding:0.8rem;">
                        <i class="fa fa-plug"></i>
                        <p>暂无代理</p>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button id="proxyClearAllBtn" class="btn-icon danger" title="清空所有代理(保留默认)">
                        <i class="fa fa-trash"></i>
                    </button>
                    <button id="proxyTestAllBtn" class="btn-icon" title="全部测试延迟">
                        <i class="fa fa-flash"></i>
                        <span class="spinner-small hidden" id="proxyTestAllSpinner"></span>
                    </button>
                    <button id="proxyAddBtn" class="btn-icon" title="添加代理">
                        <i class="fa fa-plus"></i>
                    </button>
                    <button id="proxyCancelSettingsBtn" class="btn-icon" title="关闭设置">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
        <div id="addEditProxyModal" class="modal-overlay hidden">
            <div class="modal-form-container">
                <h3 id="addEditProxyTitle">
                    <span class="modal-title-text">添加代理</span>
                    <button class="btn-icon-sm" onclick="closeAddEditProxyModal()" title="关闭">
                        <i class="fa fa-times"></i>
                    </button>
                </h3>
                <input id="addEditProxyUrlInput" type="url" placeholder="代理URL，例如：https://gh-proxy.com/"
                    autocomplete="off">
                <div id="addEditProxyError" class="text-red-400"
                    style="font-size: 0.75rem; margin-top: -0.4rem; margin-bottom: 0.4rem; display: none;"></div>

                <div class="proxy-type-selection">
                    <label>代理类型:</label>
                    <div class="proxy-type-display">
                        <span id="autoDetectedProxyType">保存时将自动测试并确定</span> <i class="fa fa-check"></i>
                    </div>
                </div>
                <div class="modal-buttons" style="margin-top:0.6rem;">
                    <button id="addEditProxySaveBtn" class="btn btn-primary" disabled>保存</button>
                </div>
            </div>
        </div>
        <div id="confirmDeleteProxyModal" class="modal-overlay hidden">
            <div class="modal-form-container">
                <h3 id="confirmDeleteProxyTitle">
                    <span class="modal-title-text">确认删除</span>
                    <button class="btn-icon-sm" onclick="hideConfirmDeleteProxyModal()" title="取消">
                        <i class="fa fa-times"></i>
                    </button>
                </h3>
                <p id="confirmDeleteProxyMessage"></p>
                <div class="modal-buttons">
                    <button id="confirmDeleteProxyCancelBtn" class="btn btn-cancel">取消</button>
                    <button id="confirmDeleteProxyConfirmBtn" class="btn btn-danger">确认删除</button>
                </div>
            </div>
        </div>
        <div id="confirmClearAllProxiesModal" class="modal-overlay hidden">
            <div class="modal-form-container">
                <h3>
                    <span class="modal-title-text">确认清空所有代理</span>
                    <button class="btn-icon-sm" onclick="hideConfirmClearAllProxiesModal()" title="取消">
                        <i class="fa fa-times"></i>
                    </button>
                </h3>
                <p>这将只保留默认代理</p>
                <div class="modal-buttons">
                    <button id="clearAllProxiesCancelBtn" class="btn btn-cancel">取消</button>
                    <button id="clearAllProxiesConfirmBtn" class="btn btn-danger">确认清空</button>
                </div>
            </div>
        </div>
    </div>
<script>
    const state = {
        token: localStorage.getItem('gh_token') || null,
        currentRepo: null,
        currentPath: '',
        files: [],
        displayFiles: [],
        repos: [],
        selectedFile: null,
        selectedRepo: null,
        uploadQueue: [],
        editingFile: null,
        fileSha: '',
        originalContent: '',
        proxies: JSON.parse(localStorage.getItem('proxies') || '[{"url": "https://gh-proxy.com/", "latency": null, "status": null, "err": null, "type": null}]'),
        activeProxyIndex: parseInt(localStorage.getItem('active_proxy_index') || '0'),
        proxyGlobalEnable: JSON.parse(localStorage.getItem('proxy_global_enable') || 'true'),
        editingProxyIndex: null,
        lastTestResult: null,
        lastTestUrl: null,
        
        fileCache: new Map(),
        viewMode: localStorage.getItem('view_mode') || 'list',
        sortBy: localStorage.getItem('sort_by') || 'name_asc',
        searchQuery: ''
    };
    if (state.proxies.length === 0) {
        state.activeProxyIndex = -1;
    } else if (state.activeProxyIndex < 0 || state.activeProxyIndex >= state.proxies.length) {
        state.activeProxyIndex = 0;
    }
    const el = {
        authScreen: document.getElementById('authScreen'),
        app: document.getElementById('app'),
        tokenInput: document.getElementById('tokenInput'),
        authBtn: document.getElementById('authBtn'),
        fileList: document.getElementById('fileList'),
        repoList: document.getElementById('repoList'),
        pathNav: document.getElementById('pathNav'),
        pathNavContainer: document.getElementById('pathNavContainer'),
        currentRepo: document.getElementById('currentRepo'),
        backBtn: document.getElementById('backBtn'),
        newFolderBtn: document.getElementById('newFolderBtn'),
        uploadBtn: document.getElementById('uploadBtn'),
        modalOverlay: document.getElementById('modalOverlay'),
        modalContent: document.getElementById('modalContent'),
        contextMenu: document.getElementById('contextMenu'),
        contextMenuItems: document.getElementById('contextMenuItems'),
        toast: document.getElementById('toast'),
        toastMessage: document.getElementById('toastMessage'),
        uploadPanel: document.getElementById('uploadPanel'),
        uploadItems: document.getElementById('uploadItems'),
        editModal: document.getElementById('editModal'),
        editFileName: document.getElementById('editFileName'),
        fileContent: document.getElementById('fileContent'),
        closeEditModal: document.getElementById('closeEditModal'),
        cancelEdit: document.getElementById('cancelEdit'),
        saveEdit: document.getElementById('saveEdit'),
        editStatus: document.getElementById('editStatus'),
        editorOverlay: document.getElementById('editorOverlay'),
        saveNotification: document.getElementById('saveNotification'),
        fileUploadInput: document.getElementById('fileUploadInput'),
        mainMenuPopup: document.getElementById('mainMenuPopup'),
        menuLogout: document.getElementById('menuLogout'),
        menuRepoList: document.getElementById('menuRepoList'),
        menuProxySettings: document.getElementById('menuProxySettings'),
        menuClearCache: document.getElementById('menuClearCache'),
        menuRefresh: document.getElementById('menuRefresh'),
        newFileBtn: document.getElementById('newFileBtn'),
        mainMenuBtn: document.getElementById('mainMenuBtn'),
        toolbar: document.getElementById('toolbar'),
        searchInput: document.getElementById('searchInput'),
        sortSelect: document.getElementById('sortSelect'), 
        viewToggleBtn: document.getElementById('viewToggleBtn'),
        proxyQuickToggle: document.getElementById('proxyQuickToggle'),
        proxySettingsModal: document.getElementById('proxySettingsModal'),
        proxyGlobalEnableToggle: document.getElementById('proxyGlobalEnableToggle'),
        proxyAddBtn: document.getElementById('proxyAddBtn'),
        proxyListContainer: document.getElementById('proxyListContainer'),
        proxyListEmpty: document.getElementById('proxyListEmpty'),
        proxyTestAllBtn: document.getElementById('proxyTestAllBtn'),
        proxyTestAllSpinner: document.getElementById('proxyTestAllSpinner'),
        proxyClearAllBtn: document.getElementById('proxyClearAllBtn'),
        proxyCancelSettingsBtn: document.getElementById('proxyCancelSettingsBtn'),
        addEditProxyModal: document.getElementById('addEditProxyModal'),
        addEditProxyTitle: document.getElementById('addEditProxyTitle'),
        addEditProxyUrlInput: document.getElementById('addEditProxyUrlInput'),
        addEditProxyError: document.getElementById('addEditProxyError'),
        autoDetectedProxyType: document.getElementById('autoDetectedProxyType'),
        addEditProxySaveBtn: document.getElementById('addEditProxySaveBtn'),
        confirmDeleteProxyModal: document.getElementById('confirmDeleteProxyModal'),
        confirmDeleteProxyTitle: document.getElementById('confirmDeleteProxyTitle'),
        confirmDeleteProxyMessage: document.getElementById('confirmDeleteProxyMessage'),
        confirmDeleteProxyCancelBtn: document.getElementById('confirmDeleteProxyCancelBtn'),
        confirmDeleteProxyConfirmBtn: document.getElementById('confirmDeleteProxyConfirmBtn'),
        confirmClearAllProxiesModal: document.getElementById('confirmClearAllProxiesModal'),
        clearAllProxiesCancelBtn: document.getElementById('clearAllProxiesCancelBtn'),
        clearAllProxiesConfirmBtn: document.getElementById('clearAllProxiesConfirmBtn'),
        renameModal: document.getElementById('renameModal'),
        renameTitle: document.getElementById('renameTitle'),
        renameInput: document.getElementById('renameInput'),
        renameWarn: document.getElementById('renameWarn'),
        renameCancel: document.getElementById('renameCancel'),
        renameConfirm: document.getElementById('renameConfirm'),
        deleteModal: document.getElementById('deleteModal'),
        deleteTitle: document.getElementById('deleteTitle'),
        deleteDesc: document.getElementById('deleteDesc'),
        deleteCancel: document.getElementById('deleteCancel'),
        deleteConfirm: document.getElementById('deleteConfirm'),
        createRepoModal: document.getElementById('createRepoModal'),
        createRepoNameInput: document.getElementById('createRepoNameInput'),
        createRepoDescInput: document.getElementById('createRepoDescInput'),
        createRepoPrivate: document.getElementById('createRepoPrivate'),
        repoNameError: document.getElementById('repoNameError'),
        createRepoCancel: document.getElementById('createRepoCancel'),
        createRepoConfirm: document.getElementById('createRepoConfirm'),
        createFolderModal: document.getElementById('createFolderModal'),
        createFolderInput: document.getElementById('createFolderInput'),
        createFolderCancel: document.getElementById('createFolderCancel'),
        createFolderConfirm: document.getElementById('createFolderConfirm'),
        createFileModal: document.getElementById('createFileModal'),
        createFileNameInput: document.getElementById('createFileNameInput'),
        createFileContentInput: document.getElementById('createFileContentInput'),
        createFileCancel: document.getElementById('createFileCancel'),
        createFileConfirm: document.getElementById('createFileConfirm'),
        searchToggleBtn: document.getElementById('searchToggleBtn'),
        sortToggleBtn: document.getElementById('sortToggleBtn'),
        customSortDropdown: document.getElementById('customSortDropdown'),
    };
    function getFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const icons = {
            js: 'fa-code',
            html: 'fa-html5',
            css: 'fa-css3',
            json: 'fa-file-code-o',
            md: 'fa-file-text-o',
            png: 'fa-file-image-o',
            jpg: 'fa-file-image-o',
            jpeg: 'fa-file-image-o',
            gif: 'fa-file-image-o',
            pdf: 'fa-file-pdf-o',
            zip: 'fa-file-zip-o',
            git: 'fa-git',
            mp3: 'fa-music',
            wav: 'fa-music',
            ogg: 'fa-music',
            flac: 'fa-music',
            m4a: 'fa-music',
            mp4: 'fa-film',
            webm: 'fa-film',
            mov: 'fa-film',
            mkv: 'fa-film',
            avi: 'fa-film'
        };
        return icons[ext] || 'fa-file-o';
    }
    function formatSize(bytes) {
        if (!bytes && bytes !== 0) return '';
        const k = 1024,
            sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.max(0, Math.log(bytes || 1) / Math.log(k)));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    function formatRelativeTime(date) {
        const diffMs = new Date() - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMins / 60);
        const diffDays = Math.floor(diffHours / 24);
        if (diffMins < 1) return '刚刚';
        if (diffMins < 60) return `${diffMins}分钟前`;
        if (diffHours < 24) return `${diffHours}小时前`;
        if (diffDays < 30) return `${diffDays}天前`;
        return date.toLocaleDateString();
    }
    function escapeHtml(unsafe) {
        return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;")
            .replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }
    function getDomainFromUrl(url) {
        try {
            const urlObj = new URL(url.startsWith('http') ? url : `https://${url}`);
            return urlObj.hostname;
        } catch (e) {
            return '';
        }
    }
    function getProxiedUrl(originalUrl) {
        if (!state.proxyGlobalEnable || state.proxies.length === 0 || state.activeProxyIndex === -1) {
            return originalUrl;
        }
        const activeProxy = state.proxies[state.activeProxyIndex];
        if (!activeProxy || !activeProxy.url || activeProxy.status === 'fail' || !activeProxy.type) {
            return originalUrl;
        }
        const isRawGitHubUserContent = originalUrl.startsWith('https://raw.githubusercontent.com/');
        if (!isRawGitHubUserContent) {
            return originalUrl;
        }
        let proxiedUrl = originalUrl;
        const proxyInputUrl = (activeProxy.url || '').trim();
        const proxyDomain = getDomainFromUrl(proxyInputUrl);
        if (activeProxy.type === 'prefix') {
            let base = proxyInputUrl;
            if (!base.endsWith('/')) {
                base += '/';
            }
            proxiedUrl = base + originalUrl;
        } else if (activeProxy.type === 'raw_domain_replace') {
            proxiedUrl = originalUrl.replace(/^(https?:\/\/raw\.)githubusercontent\.com(\/.*)$/i, `$1${proxyDomain}$2`);
            if (!proxiedUrl.startsWith('http')) {
                proxiedUrl = 'https://' + proxiedUrl;
            }
        } else {
            proxiedUrl = originalUrl;
        }
        return proxiedUrl;
    }
    function applyFiltersAndSort() {
        let arr = Array.isArray(state.files) ? [...state.files] : [];
        const q = (state.searchQuery || '').toLowerCase();
        if (q) {
            arr = arr.filter(f => (f.name || '').toLowerCase().includes(q));
        }
        const by = state.sortBy;
        const sorters = {
            name_asc: (a, b) => a.type === b.type ? a.name.localeCompare(b.name) : a.type === 'dir' ? -1 : 1,
            name_desc: (a, b) => a.type === b.type ? b.name.localeCompare(a.name) : a.type === 'dir' ? -1 : 1,
            time_desc: (a, b) => {
                const ta = a.last_modified ? +new Date(a.last_modified) : 0;
                const tb = b.last_modified ? +new Date(b.last_modified) : 0;
                if (a.type !== b.type) return a.type === 'dir' ? -1 : 1;
                return tb - ta;
            },
            time_asc: (a, b) => {
                const ta = a.last_modified ? +new Date(a.last_modified) : 0;
                const tb = b.last_modified ? +new Date(b.last_modified) : 0;
                if (a.type !== b.type) return a.type === 'dir' ? -1 : 1;
                return ta - tb;
            },
            size_desc: (a, b) => {
                if (a.type !== b.type) return a.type === 'dir' ? -1 : 1;
                return (b.size || 0) - (a.size || 0);
            },
            size_asc: (a, b) => {
                if (a.type !== b.type) return a.type === 'dir' ? -1 : 1;
                return (a.size || 0) - (b.size || 0);
            }
        };
        (sorters[by] || sorters.name_asc) && arr.sort(sorters[by]);
        state.displayFiles = arr;
    }
    function updateFileListViewMode() {
        if (!el.fileList) return;
        if (state.viewMode === 'grid') {
            el.fileList.classList.add('grid');
            el.viewToggleBtn && el.viewToggleBtn.classList.add('active');
            if (el.viewToggleBtn) {
                el.viewToggleBtn.title = '切换为列表视图';
                el.viewToggleBtn.innerHTML = '<i class="fa fa-list"></i>';
            }
        } else {
            el.fileList.classList.remove('grid');
            el.viewToggleBtn && el.viewToggleBtn.classList.remove('active');
            if (el.viewToggleBtn) {
                el.viewToggleBtn.title = '切换为网格视图';
                el.viewToggleBtn.innerHTML = '<i class="fa fa-th-large"></i>';
            }
        }
    }
    function updateProxyUI() {
        const on = !!state.proxyGlobalEnable &&
            state.proxies.length > 0 &&
            state.activeProxyIndex !== -1 &&
            state.proxies[state.activeProxyIndex]?.status !== 'fail';
        if (el.proxyQuickToggle) {
            el.proxyQuickToggle.classList.toggle('active', on);
            const currentProxy = state.proxies[state.activeProxyIndex];
            el.proxyQuickToggle.title = on && currentProxy ? `代理已开启 (${currentProxy.url})` : '代理已关闭';
            el.proxyQuickToggle.onclick = async function() {
                state.proxyGlobalEnable = !state.proxyGlobalEnable;
                localStorage.setItem('proxy_global_enable', JSON.stringify(state.proxyGlobalEnable));
                updateProxySettingsUI();
                updateProxyUI();
                showToast(state.proxyGlobalEnable ? '代理已开启' : '代理已关闭');
                if (state.currentRepo && !el.fileList.classList.contains('hidden')) {
                    el.fileList.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
                    await fetchFiles(true);
                }
            };
        }
    }
    function toggleView(showRepoList) {
        if (showRepoList) {
            el.repoList.classList.remove('hidden');
            el.fileList.classList.add('hidden');
            el.pathNavContainer.classList.add('hidden');
            el.currentRepo.textContent = '选择仓库';
            el.newFolderBtn.title = '新建仓库';
            el.newFolderBtn.innerHTML = '<i class="fa fa-plus"></i>';
            el.toolbar && el.toolbar.classList.add('hidden');
        } else {
            el.repoList.classList.add('hidden');
            el.fileList.classList.remove('hidden');
            el.pathNavContainer.classList.remove('hidden');
            el.newFolderBtn.title = '新建文件夹';
            el.newFolderBtn.innerHTML = '<i class="fa fa-folder"></i>';
            el.toolbar && el.toolbar.classList.remove('hidden');
            updateFileListViewMode();
        }
    }
    function showAuth() {
        el.authScreen.classList.remove('hidden');
        el.app.classList.add('hidden');
    }
    function showApp() {
        el.authScreen.classList.add('hidden');
        el.app.classList.remove('hidden');
    }
    function showModal(content) {
        el.modalContent.innerHTML = content;
        el.modalOverlay.classList.remove('hidden');
        el.modalOverlay.classList.add('flex');
    }
    function hideModal() {
        el.modalOverlay.classList.add('hidden');
        el.modalOverlay.classList.remove('flex');
        el.modalContent.innerHTML = '';
    }
    function showToast(message) {
        el.toastMessage.textContent = message;
        el.toast.classList.remove('hidden');
        setTimeout(() => el.toast.classList.add('hidden'), 3000);
    }
    function showSaveNotification() {
        el.saveNotification.classList.add('show');
        setTimeout(() => el.saveNotification.classList.remove('show'), 3000);
    }
    function loadReposFromCache() {
        const cachedRepos = localStorage.getItem('cached_repos');
        const cacheTime = localStorage.getItem('repos_cache_time');
        if (cachedRepos && cacheTime) {
            try {
                state.repos = JSON.parse(cachedRepos);
                renderRepoList();
                showRepoListView();
                setTimeout(() => {
                    fetchReposInBackground();
                }, 1000);
                return;
            } catch (e) {
                console.error('缓存数据解析失败:', e);
            }
        }
        fetchRepos();
    }
    async function fetchReposInBackground() {
        try {
            const res = await fetch('https://api.github.com/user/repos?timestamp=' + Date.now(), {
                headers: {
                    Authorization: `token ${state.token}`,
                    'User-Agent': 'Mozilla/5.0'
                }
            });
            if (res.ok) {
                const repos = await res.json();
                localStorage.setItem('cached_repos', JSON.stringify(repos));
                localStorage.setItem('repos_cache_time', Date.now().toString());
            }
        } catch (err) {
            console.log('后台更新失败:', err);
        }
    }
    async function fetchRepos() {
        try {
            state.repos = [];
            el.repoList.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
            const res = await fetch('https://api.github.com/user/repos?timestamp=' + Date.now(), {
                headers: {
                    Authorization: `token ${state.token}`,
                    'User-Agent': 'Mozilla/5.0'
                }
            });
            if (!res.ok) throw new Error('获取仓库失败');
            state.repos = await res.json();
            localStorage.setItem('cached_repos', JSON.stringify(state.repos));
            localStorage.setItem('repos_cache_time', Date.now().toString());
            renderRepoList();
            showRepoListView();
        } catch (err) {
            showToast('加载仓库失败');
            console.error(err);
        }
    }
    function renderRepoList() {
        state.repos.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
        el.repoList.innerHTML = state.repos.length === 0 ? '<div class="empty-state"><i class="fa fa-github"></i><p>没有找到仓库</p></div>' : '';
        state.repos.forEach(repo => {
            const item = document.createElement('div');
            item.className = 'file-item';
            item.innerHTML = `
                <div class="file-icon"><i class="fa fa-github"></i></div>
                <div class="file-info">
                    <p class="file-name">${repo.name}</p>
                    <p class="file-meta">
                        ${repo.private ? '私有仓库' : '公开仓库'} ${repo.size || repo.updated_at ? ' · ' : ''}
                        ${repo.size ? formatSize(repo.size * 1024) : ''}
                        ${repo.size && repo.updated_at ? ' · ' : ''}
                        ${formatRelativeTime(new Date(repo.updated_at))}
                    </p>
                    <p class="file-meta">${repo.description || ''}</p>
                </div>
            `;

item.addEventListener('click', () => {
    // 创建一个代表新状态的对象
    const newState = { repo: repo.full_name, path: '' };
    // 将新状态推入历史记录栈，并可以更新URL的hash（可选，但推荐）
    history.pushState(newState, '', `#/${repo.full_name}`);

    // 更新应用内部状态并渲染
    state.currentRepo = repo.full_name;
    state.currentPath = '';
    el.currentRepo.textContent = repo.name;
    renderPathNav();
    fetchFiles();
    toggleView(false);
});
            let pressTimer = null;
            item.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    pressTimer = setTimeout(() => {
                        e.preventDefault();
                        state.selectedRepo = repo;
                        showRepoContextMenu(e, repo);
                        pressTimer = null;
                    }, 500);
                }
            }, {
                passive: false
            });
            item.addEventListener('mousedown', (e) => {
                if (e.button === 0) {
                    pressTimer = setTimeout(() => {
                        e.preventDefault();
                        state.selectedRepo = repo;
                        showRepoContextMenu(e, repo);
                        pressTimer = null;
                    }, 500);
                }
            });
            ['touchend', 'touchcancel', 'mouseup', 'mouseleave'].forEach(event => {
                item.addEventListener(event, () => {
                    if (pressTimer) {
                        clearTimeout(pressTimer);
                        pressTimer = null;
                    }
                });
            });
            item.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                if (pressTimer) {
                    clearTimeout(pressTimer);
                    pressTimer = null;
                }
                state.selectedRepo = repo;
                showRepoContextMenu(e, repo);
            });
            el.repoList.appendChild(item);
        });
    }
    function showRepoListView() {
        el.repoList.classList.remove('hidden');
        el.fileList.classList.add('hidden');
        el.pathNavContainer.classList.add('hidden');
        el.currentRepo.textContent = '选择仓库';
        toggleView(true);
        state.currentRepo = null;
        state.currentPath = '';
    }
    async function fetchFiles(forceRefresh = false) {
        if (!state.currentRepo) return;
        const cacheKey = `${state.currentRepo}:${state.currentPath}`;
        if (!forceRefresh && state.fileCache.has(cacheKey)) {
            state.files = state.fileCache.get(cacheKey);
            applyFiltersAndSort();
            renderFileList();
            setTimeout(() => {
                fetchFilesInBackground(cacheKey);
            }, 2000);
            return;
        }
        await fetchFilesFromNetwork(cacheKey);
    }
    async function fetchFilesFromNetwork(cacheKey) {
        el.fileList.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
        try {
            const timestamp = Date.now();
            const res = await fetch(`https://api.github.com/repos/${state.currentRepo}/contents/${state.currentPath}?t=${timestamp}`, {
                headers: {
                    Authorization: `token ${state.token}`,
                    'User-Agent': 'Mozilla/5.0'
                },
                cache: 'no-store'
            });
            if (!res.ok) {
                if (res.status === 404) {
                    state.files = [];
                    applyFiltersAndSort();
                    renderFileList();
                    return;
                }
                throw new Error('加载文件失败');
            }
            const data = await res.json();
            if (data.message) throw new Error(data.message);
            state.files = Array.isArray(data) ? data : [];
            state.files.sort((a, b) => a.type === 'dir' && b.type !== 'dir' ? -1 : a.type !== 'dir' && b.type === 'dir' ? 1 : a.name.localeCompare(b.name));
            state.fileCache.set(cacheKey, [...state.files]);
            await Promise.all(state.files.map(async (file) => {
                try {
                    const [owner, repo] = state.currentRepo.split('/');
                    const r = await fetch(`https://api.github.com/repos/${owner}/${repo}/commits?path=${file.path}&per_page=1`, {
                        headers: {
                            Authorization: `token ${state.token}`,
                            'User-Agent': 'Mozilla/5.0'
                        }
                    });
                    const commits = await r.json();
                    if (Array.isArray(commits) && commits.length > 0) {
                        file.last_modified = commits[0].commit.committer.date;
                    }
                } catch (e) {
                    file.last_modified = null;
                }
            }));
            state.fileCache.set(cacheKey, [...state.files]);
            applyFiltersAndSort();
            renderFileList();
        } catch (err) {
            if (err.message.includes('404')) {
                state.files = [];
                applyFiltersAndSort();
                renderFileList();
                return;
            }
            showToast('加载文件失败: ' + err.message);
            console.error(err);
        }
    }
    async function fetchFilesInBackground(cacheKey) {
        try {
            const timestamp = Date.now();
            const res = await fetch(`https://api.github.com/repos/${state.currentRepo}/contents/${state.currentPath}?t=${timestamp}`, {
                headers: {
                    Authorization: `token ${state.token}`,
                    'User-Agent': 'Mozilla/5.0'
                },
                cache: 'no-store'
            });
            if (res.ok) {
                const data = await res.json();
                if (!data.message && Array.isArray(data)) {
                    const files = data.sort((a, b) => a.type === 'dir' && b.type !== 'dir' ? -1 : a.type !== 'dir' && b.type === 'dir' ? 1 : a.name.localeCompare(b.name));
                    state.fileCache.set(cacheKey, [...files]);
                }
            }
        } catch (err) {
            console.log('后台文件更新失败:', err);
        }
    }
    function renderFileList() {
        const list = (state.displayFiles && state.displayFiles.length >= 0) ? state.displayFiles : state.files;
        el.fileList.innerHTML = (!list || list.length === 0) ? '<div class="empty-state"><i class="fa fa-github"></i><p>仓库为空</p></div>' : '';
        const imageExtensions = ['png', 'jpg', 'jpeg', 'gif', 'webp', 'bmp', 'svg'];
        (list || []).forEach((file) => {
            const isDir = file.type === 'dir';
            const icon = isDir ? 'fa-folder' : getFileIcon(file.name);
            const item = document.createElement('div');
            item.className = 'file-item';
            const fileExtension = file.name.split('.').pop()?.toLowerCase();
            const isImage = !isDir && imageExtensions.includes(fileExtension);

            // 根据是否为图片，添加不同的类
            item.className = isImage ? 'file-item is-image-grid' : 'file-item';
            // --- END: 修改部分 ---
            
            let iconOrThumbnailHtml = '';
            if (isImage) {
                const rawUrl = (file.download_url) ? file.download_url : file.html_url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
                const imageUrl = getProxiedUrl(rawUrl);
                iconOrThumbnailHtml = `<img src="${imageUrl}" class="file-thumbnail" alt="${file.name}">`;
            } else {
                iconOrThumbnailHtml = `<div class="file-icon"><i class="fa ${icon}"></i></div>`;
            }
            item.innerHTML = `
                ${iconOrThumbnailHtml}
                <div class="file-info">
                    <p class="file-name">${file.name}</p>
                    <p class="file-meta">
                        ${isDir ? '文件夹' : formatSize(file.size)} · ${file.last_modified ? formatRelativeTime(new Date(file.last_modified)) : '加载中'}
                    </p>
                </div>
            `;
            item.addEventListener('click', (e) => {
                if (e.imagePreviewAction) return;
                isDir ? navigateToDir(file.name) : editFile(file);
            });
            let pressTimer = null;
            item.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    pressTimer = setTimeout(() => {
                        e.preventDefault();
                        showContextMenu(e, file);
                        pressTimer = null;
                    }, 700);
                }
            }, {
                passive: false
            });
            item.addEventListener('mousedown', (e) => {
                if (e.button === 0) {
                    pressTimer = setTimeout(() => {
                        e.preventDefault();
                        showContextMenu(e, file);
                        pressTimer = null;
                    }, 700);
                }
            });
            ['touchend', 'touchcancel', 'mouseup', 'mouseleave'].forEach(event => {
                item.addEventListener(event, () => {
                    if (pressTimer) {
                        clearTimeout(pressTimer);
                        pressTimer = null;
                    }
                });
            });
            item.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                if (pressTimer) {
                    clearTimeout(pressTimer);
                    pressTimer = null;
                }
                showContextMenu(e, file);
            });
            el.fileList.appendChild(item);
        });
    }
    function renderPathNav() {
        el.pathNav.innerHTML = '';
        const parts = state.currentPath.split('/').filter(p => p);
        let currentPath = '';
        addPathItem('', '/');
        parts.forEach((part) => {
            currentPath += part + '/';
            addPathItem(part, currentPath);
        });
    }
    function addPathItem(name, path) {
        const item = document.createElement('span');
        item.className = 'path-item';
        item.textContent = name;
        item.dataset.path = path;
        item.addEventListener('click', () => {
            el.fileList.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
            navigateToPath(path);
        });
        el.pathNav.appendChild(item);
        if (name !== '/') el.pathNav.appendChild(document.createTextNode(' / '));
    }
    
function navigateToDir(dirName) {
    // 1. 计算出要进入的新路径
    const newPath = state.currentPath ? `${state.currentPath}${dirName}/` : `${dirName}/`;
    // 2. 将导航任务完全交给 navigateToPath 函数处理
    navigateToPath(newPath);
}
    function navigateToPath(path) {
    const newState = { repo: state.currentRepo, path: path };
    history.pushState(newState, '', `#/${state.currentRepo}/${path}`);

    state.currentPath = path;
    renderPathNav();
    fetchFiles();
}
    function setupEventListeners() {
        el.newFolderBtn.onclick = function() {
            if (!state.currentRepo) {
                showCreateRepoModal();
            } else {
                showCreateFolderModal();
            }
        };
        el.authBtn.addEventListener('click', async () => {
            const token = el.tokenInput.value.trim();
            if (token) {
                localStorage.setItem('gh_token', token);
                state.token = token;
                showApp();
                await fetchRepos();
                updateProxyUI();
                
                fetchFiles(true);
            } else {
                showToast('请输入令牌');
            }
        });
        el.mainMenuBtn.onclick = (e) => {
            e.stopPropagation();
            hideContextMenu();
            el.mainMenuPopup.classList.toggle('hidden');
        };
        document.addEventListener('click', function(e) {
            if (!el.mainMenuPopup.classList.contains('hidden')) {
                if (!el.mainMenuPopup.contains(e.target) && e.target !== el.mainMenuBtn) {
                    el.mainMenuPopup.classList.add('hidden');
                }
            }
            if (!el.customSortDropdown.classList.contains('hidden') && !el.customSortDropdown.contains(e.target) && e.target !== el.sortToggleBtn) {
                el.customSortDropdown.classList.add('hidden');
            }
        });
        el.menuRepoList.onclick = () => {
            el.mainMenuPopup.classList.add('hidden');
            showRepoListView();
        };
        el.menuRefresh.onclick = () => {
            el.mainMenuPopup.classList.add('hidden');
            if (!state.currentRepo) {
                fetchRepos();
            } else {
                fetchFiles(true);
            }
        };
        el.menuLogout.onclick = () => {
            el.mainMenuPopup.classList.add('hidden');
            localStorage.removeItem('gh_token');
            state.token = null;
            state.repos = [];
            state.currentRepo = null;
            showAuth();
        };
        el.proxyGlobalEnableToggle.addEventListener('click', async function() {
            state.proxyGlobalEnable = !state.proxyGlobalEnable;
            localStorage.setItem('proxy_global_enable', JSON.stringify(state.proxyGlobalEnable));
            updateProxySettingsUI();
            updateProxyUI();
            showToast(state.proxyGlobalEnable ? '代理已开启' : '代理已关闭');
            if (state.currentRepo && !el.fileList.classList.contains('hidden')) {
                el.fileList.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
                await fetchFiles(true);
            }
        });
        el.menuProxySettings.addEventListener('click', () => {
            el.mainMenuPopup.classList.add('hidden');
            openProxySettingsModal();
        });
        el.menuClearCache.addEventListener('click', clearCache);
        el.saveEdit.addEventListener('click', saveEditedFile);
        el.closeEditModal.onclick = hideEditModal;
        el.cancelEdit.onclick = hideEditModal;
        document.addEventListener('click', hideContextMenu);
        document.addEventListener('touchstart', (e) => {
            if (!el.contextMenu.contains(e.target)) hideContextMenu();
        });
        document.addEventListener('touchmove', (e) => {
            if (!el.contextMenu.contains(e.target)) hideContextMenu();
        });
        el.modalOverlay.addEventListener('click', (e) => {
            if (e.target === el.modalOverlay) hideModal();
        });
        el.backBtn.onclick = goUp;
        el.newFileBtn.onclick = showCreateFileModal;
        el.uploadBtn.onclick = handleUploadClick;
        el.fileUploadInput.addEventListener('change', handleFilesSelected);
        el.searchToggleBtn.addEventListener('click', () => {
            el.searchInput.classList.toggle('hidden');
            if (!el.searchInput.classList.contains('hidden')) {
                el.searchInput.focus();
                el.searchInput.style.display = 'block';
            } else {
                el.searchInput.value = '';
                state.searchQuery = '';
                applyFiltersAndSort();
                renderFileList();
                el.searchInput.style.display = 'none';
            }
        });
        if (el.searchInput) {
            el.searchInput.addEventListener('input', () => {
                state.searchQuery = el.searchInput.value || '';
                applyFiltersAndSort();
                renderFileList();
            });
        }
        el.sortToggleBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            el.customSortDropdown.classList.toggle('hidden');
        });
        el.customSortDropdown.addEventListener('click', (e) => {
            if (e.target.classList.contains('dropdown-item')) {
                state.sortBy = e.target.dataset.value;
                localStorage.setItem('sort_by', state.sortBy);
                applyFiltersAndSort();
                renderFileList();
                el.customSortDropdown.classList.add('hidden');
                Array.from(el.customSortDropdown.children).forEach(item => {
                    item.classList.remove('selected');
                });
                e.target.classList.add('selected');
            }
        });
        if (el.customSortDropdown) {
            Array.from(el.customSortDropdown.children).forEach(item => {
                if (item.dataset.value === state.sortBy) {
                    item.classList.add('selected');
                }
            });
        }
        if (el.viewToggleBtn) {
            updateFileListViewMode();
            el.viewToggleBtn.addEventListener('click', () => {
                state.viewMode = state.viewMode === 'list' ? 'grid' : 'list';
                localStorage.setItem('view_mode', state.viewMode);
                updateFileListViewMode();
            });
        }
        el.proxyCancelSettingsBtn.addEventListener('click', closeProxySettingsModal);
        el.proxyGlobalEnableToggle.addEventListener('click', () => {
            state.proxyGlobalEnable = !state.proxyGlobalEnable;
            localStorage.setItem('proxy_global_enable', JSON.stringify(state.proxyGlobalEnable));
            updateProxySettingsUI();
            updateProxyUI();
            showToast(state.proxyGlobalEnable ? '代理全局已启用' : '代理全局已禁用');
        });
        el.proxyAddBtn.addEventListener('click', () => openAddEditProxyModal());
        el.proxyTestAllBtn.addEventListener('click', testAllProxies);
        el.proxyClearAllBtn.addEventListener('click', showConfirmClearAllProxiesModal);
        el.addEditProxyUrlInput.addEventListener('input', validateAddEditProxyInput);
        el.addEditProxySaveBtn.addEventListener('click', async () => {
            const url = el.addEditProxyUrlInput.value.trim();
            if (!validateAddEditProxyInput()) {
                return;
            }
            el.addEditProxySaveBtn.disabled = true;
            el.addEditProxySaveBtn.innerHTML = `测试中 <span class="spinner-small"></span>`;
            el.addEditProxyError.style.display = 'none';
            const result = await determineBestProxyTypeAndTest(url);
            if (result.ok) {
                el.addEditProxySaveBtn.innerHTML = `保存中 <span class="spinner-small"></span>`;
                const proxyObj = state.editingProxyIndex !== null ?
                    state.proxies[state.editingProxyIndex] :
                    {};
                proxyObj.url = url;
                proxyObj.latency = result.ms;
                proxyObj.status = 'ok';
                proxyObj.err = null;
                proxyObj.type = result.type;
                if (state.editingProxyIndex === null) {
                    state.proxies.push(proxyObj);
                    if (state.proxies.length === 1) {
                        state.activeProxyIndex = 0;
                    }
                }
                
                showToast('代理已保存');
                renderProxyList();
                saveProxyConfig();
                closeAddEditProxyModal();
            } else {
                el.addEditProxyError.textContent = `测试失败: ${result.err}`;
                el.addEditProxyError.style.display = 'block';
                el.addEditProxySaveBtn.disabled = false;
                el.addEditProxySaveBtn.innerHTML = '重试保存';
            }
        });
        el.confirmDeleteProxyCancelBtn.addEventListener('click', hideConfirmDeleteProxyModal);
        el.clearAllProxiesCancelBtn.addEventListener('click', hideConfirmClearAllProxiesModal);
        el.clearAllProxiesConfirmBtn.addEventListener('click', clearAllProxiesConfirmed);
        el.renameInput.oninput = function() {
            el.renameConfirm.disabled = !el.renameInput.value.trim() || el.renameInput.value.trim() === state.selectedFile?.name;
        };
        el.renameCancel.onclick = function() {
            el.renameModal.classList.add('hidden');
        };
        el.deleteCancel.onclick = function() {
            el.deleteModal.classList.add('hidden');
        };
        el.createRepoCancel.onclick = function() {
            el.createRepoModal.classList.add('hidden');
        };
        el.createFolderInput.oninput = function() {
            el.createFolderConfirm.disabled = !el.createFolderInput.value.trim();
        };
        el.createFolderCancel.onclick = function() {
            el.createFolderModal.classList.add('hidden');
        };
        el.createFileNameInput.oninput = function() {
            el.createFileConfirm.disabled = !el.createFileNameInput.value.trim() || el.createFileNameInput.value.trim().endsWith('/');
        };
        el.createFileCancel.onclick = function() {
            el.createFileModal.classList.add('hidden');
        };
    }
    function showEditModal() {
        el.editModal.classList.remove('hidden');
        el.editModal.classList.add('flex');
        el.editorOverlay.classList.add('show');
        setTimeout(adjustEditorDimensions, 10);
    }
    function hideEditModal() {
        el.editModal.classList.add('hidden');
        el.editModal.classList.remove('flex');
        state.editingFile = state.fileSha = state.originalContent = '';
        el.saveEdit.className = 'save-btn';
    }
    function showEditStatus(text, type) {
        el.editStatus.textContent = text;
        el.editStatus.className = `edit-status ${type}`;
    }
    function adjustEditorDimensions() {
        const viewportHeight = window.innerHeight;
        const targetEditorHeight = viewportHeight * 0.6;
        const modal = el.editModal.querySelector('.modal-content');
        const headerHeight = modal.querySelector('.modal-header').offsetHeight;
        const statusHeight = el.editStatus.offsetHeight;
        const footerHeight = modal.querySelector('.modal-footer').offsetHeight;
        const paddingOffset = 20;
        const otherElementsHeight = headerHeight + statusHeight + footerHeight + paddingOffset;
        
        modal.style.height = `${targetEditorHeight + otherElementsHeight}px`;
        el.fileContent.style.height = `${targetEditorHeight}px`;
    }
    async function editFile(file) {
        state.editingFile = file;
        el.editFileName.textContent = `${file.name}`;
        el.fileContent.value = '';
        showEditStatus('', '');
        showEditModal();
        try {
            const [owner, repo] = state.currentRepo.split('/');
            const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${file.path}`, {
                headers: {
                    'Authorization': `token ${state.token}`,
                    'User-Agent': 'Mozilla/5.0'
                }
            });
            if (!res.ok) {
                const err = await res.json();
                el.editorOverlay.classList.remove('show');
                showEditStatus(`加载失败：${err.message}`, 'error');
                return;
            }
            const data = await res.json();
            const content = decodeURIComponent(escape(atob(data.content)));
            el.fileContent.value = content;
            state.originalContent = content;
            state.fileSha = data.sha;
            el.editorOverlay.classList.remove('show');
            el.fileContent.oninput = checkContentChanges;
        } catch (e) {
            el.editorOverlay.classList.remove('show');
            showEditStatus(`错误：${e.message}`, 'error');
            console.error(e);
        }
    }
    function checkContentChanges() {
        const isModified = el.fileContent.value !== state.originalContent;
        el.saveEdit.className = isModified ? 'save-btn modified' : 'save-btn';
    }
    async function saveEditedFile() {
        if (!state.editingFile || !state.fileSha) return;
        const currentContent = el.fileContent.value;
        if (currentContent === state.originalContent) {
            showToast('未检测到修改');
            return;
        }
        el.editorOverlay.classList.add('show');
        try {
            const [owner, repo] = state.currentRepo.split('/');
            const encodedContent = btoa(unescape(encodeURIComponent(currentContent)));
            const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${state.editingFile.path}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${state.token}`,
                    'Content-Type': 'application/json',
                    'User-Agent': 'Mozilla/5.0'
                },
                body: JSON.stringify({
                    message: `Update ${state.editingFile.name} via web editor`,
                    content: encodedContent,
                    sha: state.fileSha
                })
            });
            if (!res.ok) {
                const err = await res.json();
                el.editorOverlay.classList.remove('show');
                showEditStatus(`保存失败：${err.message}`, 'error');
                return;
            }
            const result = await res.json();
            state.fileSha = result.content.sha;
            state.originalContent = currentContent;
            el.editorOverlay.classList.remove('show');
            showToast('文件已保存');
            showSaveNotification();
            fetchFiles(true);
            el.saveEdit.className = 'save-btn';
        } catch (e) {
            el.editorOverlay.classList.remove('show');
            showEditStatus(`错误：${e.message}`, 'error');
            console.error(e);
        }
    }
    async function downloadFile(item) {
        if (item.type === 'dir') return;
        try {
            showToast(`准备下载 ${item.name}`);
            const rawUrl = (item.download_url) ? item.download_url : item.html_url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
            const url = getProxiedUrl(rawUrl);
            const response = await fetch(url);
            if (!response.ok) throw new Error(`下载失败 (${response.status})`);
            const blob = await response.blob();
            const objectUrl = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = objectUrl;
            a.download = item.name;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(objectUrl);
            }, 500);
            showToast(`开始下载 ${item.name}`);
        } catch (e) {
            showToast(`下载出错: ${e.message}`);
            console.error(e);
        }
    }
    function copyLink(file) {
        const rawUrl = file.download_url || file.html_url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
        navigator.clipboard.writeText(rawUrl).then(() => {
            showToast('Raw 链接已复制');
        }).catch(e => {
            showToast(`复制失败: ${e.message || '请检查浏览器权限或非安全上下文'}`);
            console.error(e);
        });
    }
    function copyProxyLink(file) {
        const raw = file.download_url || file.html_url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
        if (!state.proxyGlobalEnable || state.proxies.length === 0 || state.activeProxyIndex === -1) {
            navigator.clipboard.writeText(raw)
                .then(() => showToast('未启用代理或无有效代理，已复制直连 Raw'))
                .catch(e => {
                    showToast(`复制失败: ${e.message || '请检查浏览器权限或非安全上下文'}`);
                    console.error(e);
                });
            return;
        }
        const proxyUrl = getProxiedUrl(raw);
        navigator.clipboard.writeText(proxyUrl).then(() => {
            showToast('代理链接已复制');
        }).catch(e => {
            showToast(`复制失败: ${e.message || '请检查浏览器权限或非安全上下文'}`);
            console.error(e);
        });
    }
    function positionContextMenu(e) {
        const rect = e.target.closest('.file-item').getBoundingClientRect();
        const menuWidth = 160,
            windowWidth = window.innerWidth,
            windowHeight = window.innerHeight;
        let leftPos = rect.right + 8;
        let topPos = rect.top;
        if (leftPos + menuWidth + 8 > windowWidth) {
            leftPos = rect.left - menuWidth - 8;
            if (leftPos < 0) {
                leftPos = Math.max(8, (windowWidth - menuWidth) / 2);
            }
        }
        
        const estimatedMenuHeight = 30 * 8; 
        if (topPos + estimatedMenuHeight > windowHeight) {
            topPos = Math.max(8, windowHeight - estimatedMenuHeight - 16);
        }
        return {
            top: topPos,
            left: leftPos
        };
    }
    function showContextMenu(e, file) {
        state.selectedFile = file;
        const position = positionContextMenu(e);
        const menu = el.contextMenu;
        menu.style.top = `${position.top}px`;
        menu.style.left = `${position.left}px`;
        menu.style.opacity = '0';
        menu.style.transform = 'scale(0.8)';
        menu.classList.remove('hidden');
        let start = null,
            duration = 150;
        function animate(timestamp) {
            if (!start) start = timestamp;
            const progress = Math.min((timestamp - start) / duration, 1);
            menu.style.opacity = progress.toString();
            menu.style.transform = `scale(${0.8 + 0.2 * progress})`;
            if (progress < 1) requestAnimationFrame(animate);
        }
        requestAnimationFrame(animate);
        renderContextMenuItems(file);
    }
    function showRepoContextMenu(e, repo) {
        state.selectedRepo = repo;
        const position = positionContextMenu(e);
        const menu = el.contextMenu;
        menu.style.top = `${position.top}px`;
        menu.style.left = `${position.left}px`;
        menu.style.opacity = '0';
        menu.style.transform = 'scale(0.8)';
        menu.classList.remove('hidden');
        let start = null,
            duration = 150;
        function animate(timestamp) {
            if (!start) start = timestamp;
            const progress = Math.min((timestamp - start) / duration, 1);
            menu.style.opacity = progress.toString();
            menu.style.transform = `scale(${0.8 + 0.2 * progress})`;
            if (progress < 1) requestAnimationFrame(animate);
        }
        requestAnimationFrame(animate);
        renderRepoContextMenuItems(repo);
    }
    function renderRepoContextMenuItems(repo) {
        el.contextMenuItems.innerHTML = '';
        [
            ['downloadRepoDirect', 'fa-download', '下载ZIP (直连)'],
            ['downloadRepoProxied', 'fa-cloud-download', '下载ZIP (代理)'],
            ['renameRepo', 'fa-pencil', '重命名'],
            ['deleteRepo', 'fa-trash', '删除', 'text-red-400']
        ].forEach(([action, icon, text, className = '']) => {
            const item = document.createElement('a');
            item.className = `context-menu-item ${className}`;
            item.dataset.action = action;
            item.innerHTML = `<i class="fa ${icon} mr-2"></i>${text}`;
            item.addEventListener('click', () => {
                handleRepoContextMenuAction(action, state.selectedRepo);
                hideContextMenu();
            });
            el.contextMenuItems.appendChild(item);
        });
    }
    function renderContextMenuItems(file) {
        el.contextMenuItems.innerHTML = '';
        const isDir = file.type === 'dir';
        const items = isDir ? [
            ['rename', 'fa-pencil', '重命名'],
            ['delete', 'fa-trash', '删除', 'text-red-400']
        ] : [
            ['download', 'fa-download', '下载'],
            ['copyLink', 'fa-link', '复制链接'],
            ['copyProxy', 'fa-share', '代理链接'],
            ['edit', 'fa-edit', '编辑'],
            ['rename', 'fa-pencil', '重命名'],
            ['delete', 'fa-trash', '删除', 'text-red-400']
        ];
        items.forEach(([action, icon, text, className = '']) => {
            const item = document.createElement('a');
            item.className = `context-menu-item ${className}`;
            item.dataset.action = action;
            item.innerHTML = `<i class="fa ${icon} mr-2"></i>${text}`;
            item.addEventListener('click', () => {
                handleContextMenuAction(action, state.selectedFile);
                hideContextMenu();
            });
            el.contextMenuItems.appendChild(item);
        });
    }
    const hideContextMenu = () => {
        const menu = el.contextMenu;
        if (menu.classList.contains('hidden') && menu.style.display === 'none') return;
        let start = null,
            duration = 150;
        function animate(timestamp) {
            if (!start) start = timestamp;
            const progress = Math.min((timestamp - start) / duration, 1);
            menu.style.opacity = (1 - progress).toString();
            menu.style.transform = `scale(${1 - 0.2 * progress})`;
            if (progress < 1) requestAnimationFrame(animate);
            else {
                menu.classList.add('hidden');
                state.selectedFile = null;
                state.selectedRepo = null;
            }
        }
        requestAnimationFrame(animate);
    };
    function handleContextMenuAction(action, oldFileObject) {
        const currentFile = state.files.find(f => f.path === oldFileObject.path);
        if (!currentFile) {
            showToast('文件已更新，请重新选择或刷新页面');
            return;
        }
        switch (action) {
            case 'download':
                downloadFile(currentFile);
                break;
            case 'copyLink':
                copyLink(currentFile);
                break;
            case 'copyProxy':
                copyProxyLink(currentFile);
                break;
            case 'edit':
                editFile(currentFile);
                break;
            case 'rename':
                showRenameModal(currentFile, currentFile.type === 'dir');
                break;
            case 'delete':
                showDeleteModal(currentFile, currentFile.type === 'dir');
                break;
        }
    }
    function handleRepoContextMenuAction(action, repo) {
        const zipRaw = `https://github.com/${repo.full_name}/archive/refs/heads/${repo.default_branch || 'main'}.zip`;
        switch (action) {
            case 'downloadRepoDirect':
                downloadRepoAsZip(repo, false);
                break;
            case 'downloadRepoProxied':
                downloadRepoAsZip(repo, true);
                break;
            case 'renameRepo':
                showRenameRepoModal(repo);
                break;
            case 'deleteRepo':
                showDeleteRepoModal(repo);
                break;
        }
    }
    function downloadRepoAsZip(repo, useProxy) {
        const zipRaw = `https://github.com/${repo.full_name}/archive/refs/heads/${repo.default_branch || 'main'}.zip`;
        const zipUrl = useProxy ? getProxiedUrl(zipRaw) : zipRaw;
        const a = document.createElement('a');
        a.href = zipUrl;
        a.download = `${repo.name}.zip`;
        a.classList.add('hidden');
        document.body.appendChild(a);
        a.click();
        setTimeout(() => document.body.removeChild(a), 500);
        showToast(`正在下载 ${repo.name}.zip (${useProxy ? '代理' : '直连'})`);
    }
    function handleUploadClick() {
        if (!state.currentRepo) {
            showToast('请先选择仓库');
            return;
        }
        el.fileUploadInput.click();
    }
    el.fileUploadInput.addEventListener('change', function(e) {
        const files = Array.from(e.target.files || []);
        if (files.length === 0) return;
        files.forEach((file, index) => uploadSingleFile(file, index));
    });
    function handleFilesSelected(e) {
        const files = Array.from(e.target.files || []);
        if (files.length === 0) return;
        el.uploadPanel.classList.remove('hidden');
        el.uploadItems.innerHTML = '';
        files.forEach((file, index) => {
            let displayName = file.name;
            if (displayName.length > 25) {
                displayName = displayName.slice(0, 22) + '...';
            }
            const uploadItem = document.createElement('div');
            uploadItem.className = 'upload-item';
            uploadItem.innerHTML = `
                <div class="upload-info">
                    <span class="upload-name" title="${file.name}">${displayName}</span>
                    <span class="upload-size">${formatSize(file.size)}</span>
                </div>
                <div class="upload-progress-container">
                    <div class="upload-progress" data-index="${index}">
                        <span class="percent-text" data-index="${index}">0%</span>
                    </div>
                </div>
                <div class="upload-status" data-index="${index}">等待上传...</div>
            `;
            el.uploadItems.appendChild(uploadItem);
        });
        uploadFilesInSequence(files, 0);
        e.target.value = '';
    }
    function uploadFilesInSequence(files, index) {
        if (index >= files.length) {
            setTimeout(() => {
                el.uploadPanel.classList.add('hidden');
                fetchFiles(true);
            }, 200);
            return;
        }
        const file = files[index];
        const statusElement = document.querySelector(`.upload-status[data-index="${index}"]`);
        if (statusElement) statusElement.textContent = '准备上传...';
        uploadSingleFile(file, index)
            .then(() => uploadFilesInSequence(files, index + 1))
            .catch(() => uploadFilesInSequence(files, index + 1));
    }
    async function uploadSingleFile(file, index) {
        const MAX_FILE_SIZE_BYTES = 100 * 1024 * 1024;
        return new Promise(async (resolve, reject) => {
            const progressBar = document.querySelector(`.upload-progress[data-index="${index}"]`);
            const statusElement = document.querySelector(`.upload-status[data-index="${index}"]`);
            const percentTextEl = progressBar.querySelector(`.percent-text[data-index="${index}"]`);
            if (file.size > MAX_FILE_SIZE_BYTES) {
                if (statusElement) {
                    statusElement.textContent = `文件过大，限制100MB`;
                    statusElement.className = 'upload-status error';
                }
                showToast(`文件 "${file.name}" 使用token上传超过100MB官方限制`);
                reject(new Error('文件过大'));
                return;
            }
            if (progressBar) progressBar.style.width = '5%';
            if (statusElement) statusElement.textContent = '正在处理文件...';
            if (percentTextEl) percentTextEl.textContent = '5%';
            const reader = new FileReader();
            reader.readAsArrayBuffer(file);
            reader.onload = async (e) => {
                try {
                    if (statusElement) statusElement.textContent = '正在编码内容...';
                    const base64String = arrayBufferToBase64(e.target.result);
                    if (progressBar) progressBar.style.width = '30%';
                    if (percentTextEl) percentTextEl.textContent = '30%';
                    if (!state || !state.currentRepo) throw new Error('未选择仓库');
                    const fileName = file.name;
                    const filePath = state.currentPath ? `${state.currentPath}${fileName}` : fileName;
                    const [owner, repo] = state.currentRepo.split('/');
                    let existingFileSha = null;
                    try {
                        const checkRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`, {
                            headers: { 'Authorization': `token ${state.token}`, 'User-Agent': 'Mozilla/5.0' }
                        });
                        if (checkRes.ok) {
                            const fileData = await checkRes.json();
                            existingFileSha = fileData.sha;
                        } else if (checkRes.status !== 404) {
                            throw new Error(`获取文件信息失败: HTTP ${checkRes.status}`);
                        }
                    } catch (e) {
                        console.warn(`无法获取文件SHA (可能为新文件或网络问题): ${e.message}`);
                    }
                    if (statusElement) statusElement.textContent = '正在上传...';
                    const requestBody = {
                        message: `Upload ${fileName}`,
                        content: base64String
                    };
                    if (existingFileSha) {
                        requestBody.sha = existingFileSha;
                    }
                    const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${state.token}`,
                            'Content-Type': 'application/json',
                            'User-Agent': 'Mozilla/5.0'
                        },
                        body: JSON.stringify(requestBody),
                        signal: AbortSignal.timeout(180000)
                    });
                    if (progressBar) progressBar.style.width = '100%';
                    if (percentTextEl) percentTextEl.textContent = '100%';
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.message || `上传失败: HTTP ${response.status}`);
                    }
                    if (statusElement) {
                        statusElement.textContent = '上传成功';
                        statusElement.className = 'upload-status success';
                    }
                    resolve();
                } catch (error) {
                    if (statusElement) {
                        statusElement.textContent = '上传失败';
                        statusElement.className = 'upload-status error';
                    }
                    reject(new Error(`上传失败: ${error.message}`));
                }
            };
            reader.onerror = () => {
                if (statusElement) {
                    statusElement.textContent = '文件读取失败';
                    statusElement.className = 'upload-status error';
                }
                showToast(`无法读取文件: ${file.name}`);
                reject(new Error('文件读取失败'));
            };
        });
    }
    function arrayBufferToBase64(buffer) {
        let binary = '';
        const bytes = new Uint8Array(buffer);
        const len = bytes.byteLength;
        for (let i = 0; i < len; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary);
    }
    function showRenameModal(item, isDir) {
        el.renameTitle.querySelector('.modal-title-text').textContent = `重命名${isDir ? '文件夹' : '文件'}: ${item.name}`;
        el.renameInput.value = item.name;
        el.renameWarn.innerHTML = '';
        el.renameModal.classList.remove('hidden');
        el.renameConfirm.disabled = true;
        el.renameInput.oninput = function() {
            el.renameConfirm.disabled = !el.renameInput.value.trim() || el.renameInput.value.trim() === item.name;
        };
        el.renameConfirm.onclick = async function() {
            const v = el.renameInput.value.trim();
            if (!v || v === item.name) return;
            el.renameConfirm.disabled = true;
            el.renameConfirm.innerHTML = '保存中 <i class="fa fa-spinner fa-spin"></i>';
            try {
                const [owner, repo] = state.currentRepo.split('/');
                const oldPath = item.path;
                const base = oldPath.slice(0, -item.name.length);
                const newPath = base + v;
                if (isDir) {
                    const getAll = async p => {
                        const r = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${p}`, {
                            headers: {
                                Authorization: `token ${state.token}`
                            }
                        });
                        if (!r.ok) return [];
                        let a = [];
                        for (const i of await r.json()) a.push(...(i.type === 'dir' ? await getAll(i.path) : [i]));
                        return a;
                    };
                    const files = await getAll(oldPath);
                    for (const f of files) {
                        const to = f.path.replace(oldPath, newPath);
                        const d = await (await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${f.path}`, {
                            headers: {
                                Authorization: `token ${state.token}`
                            }
                        })).json();
                        await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${to}`, {
                            method: 'PUT',
                            headers: {
                                Authorization: `token ${state.token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                message: `Move ${f.name} to ${newPath}`,
                                content: d.content || '',
                                sha: d.sha
                            })
                        });
                    }
                    const filesToDelete = [...files].sort((a, b) => b.path.length - a.path.length);
                    for (const f of filesToDelete) {
                        await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${f.path}`, {
                            method: 'DELETE',
                            headers: {
                                Authorization: `token ${state.token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                message: `Delete old file ${f.name}`,
                                sha: f.sha
                            })
                        });
                    }
                    const resOldFolder = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${oldPath}`, {
                        headers: {
                            Authorization: `token ${state.token}`
                        }
                    });
                    if (resOldFolder.ok) {
                        const oldFolderContent = await resOldFolder.json();
                        if (Array.isArray(oldFolderContent) && oldFolderContent.length > 0) {
                            for (const f of oldFolderContent) {
                                if (f.type === 'file') {
                                    await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${f.path}`, {
                                        method: 'DELETE',
                                        headers: {
                                            Authorization: `token ${state.token}`,
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({
                                            message: `Delete old folder stub ${f.name}`,
                                            sha: f.sha
                                        })
                                    });
                                }
                            }
                        }
                    }
                } else {
                    const d = await (await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${oldPath}`, {
                        headers: {
                            Authorization: `token ${state.token}`
                        }
                    })).json();
                    await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${newPath}`, {
                        method: 'PUT',
                        headers: {
                            Authorization: `token ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `Rename to ${v}`,
                            content: d.content,
                            sha: d.sha
                        })
                    });
                    await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${oldPath}`, {
                        method: 'DELETE',
                        headers: {
                            Authorization: `token ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `Delete old file`,
                            sha: d.sha
                        })
                    });
                }
                showToast(`重命名成功: ${v}`);
                el.renameModal.classList.add('hidden');
                fetchFiles(true);
            } catch (e) {
                showToast(`失败: ${e.message}`);
                el.renameConfirm.disabled = false;
                el.renameConfirm.innerHTML = '确认';
            }
        };
    }
    function showCreateFolderModal() {
        el.createFolderInput.value = '';
        el.createFolderModal.classList.remove('hidden');
        el.createFolderConfirm.disabled = true;
        el.createFolderConfirm.onclick = async function() {
            const name = el.createFolderInput.value.trim();
            if (!name) return;
            el.createFolderConfirm.disabled = true;
            el.createFolderConfirm.innerHTML = '创建中 <i class="fa fa-spinner fa-spin"></i>';
            try {
                const [owner, repo] = state.currentRepo.split('/');
                const path = state.currentPath ? `${state.currentPath}${name}` : name;
                await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}/.gitkeep`, {
                    method: 'PUT',
                    headers: {
                        Authorization: `token ${state.token}`,
                        'Content-Type': 'application/json',
                        'User-Agent': 'Mozilla/5.0'
                    },
                    body: JSON.stringify({
                        message: `create folder ${name}`,
                        content: ''
                    })
                });
                el.createFolderConfirm.disabled = false;
                el.createFolderConfirm.innerHTML = '确认';
                showToast(`已创建文件夹: ${name}`);
                el.createFolderModal.classList.add('hidden');
                fetchFiles(true);
            } catch (e) {
                showToast(`失败: ${e.message}`);
                el.createFolderConfirm.disabled = false;
                el.createFolderConfirm.innerHTML = '确认';
            }
        };
    }
    function showCreateFileModal() {
        if (!state.currentRepo) {
            showToast('请先选择仓库');
            return;
        }
        el.createFileNameInput.value = '';
        el.createFileContentInput.value = '';
        el.createFileModal.classList.remove('hidden');
        el.createFileConfirm.disabled = true;
        el.createFileConfirm.onclick = async function() {
            const name = el.createFileNameInput.value.trim();
            const content = el.createFileContentInput.value;
            if (!name) return;
            el.createFileConfirm.disabled = true;
            el.createFileConfirm.innerHTML = '创建中 <i class="fa fa-spinner fa-spin"></i>';
            try {
                const [owner, repo] = state.currentRepo.split('/');
                const path = state.currentPath ? `${state.currentPath}${name}` : name;
                const encodedContent = btoa(unescape(encodeURIComponent(content)));
                const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                    method: 'PUT',
                    headers: {
                        Authorization: `token ${state.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `create file ${name}`,
                        content: encodedContent
                    })
                });
                if (!res.ok) throw new Error('创建失败');
                showToast(`已创建文件: ${name}`);
                el.createFileModal.classList.add('hidden');
                fetchFiles(true);
            } catch (e) {
                showToast(`失败: ${e.message}`);
                el.createFileConfirm.disabled = false;
                el.createFileConfirm.innerHTML = '确认';
            }
        };
    }
    function showRenameRepoModal(repo) {
        showModal(`
            <div class="modal-form-container">
                <h3><span class="modal-title-text">重命名仓库: ${repo.name}</span><button class="btn-icon-sm" onclick="hideModal()" title="关闭"><i class="fa fa-times"></i></button></h3>
                <input id="newRepoName" value="${repo.name}">
                <textarea id="newRepoDesc">${repo.description || ''}</textarea>
                <div class="modal-buttons">
                    <button id="cancelRenameRepo" class="btn btn-cancel">取消</button>
                    <button id="confirmRenameRepo" class="btn btn-primary" disabled>确认</button>
                </div>
            </div>
        `);
        const nameInput = document.getElementById('newRepoName');
        const descInput = document.getElementById('newRepoDesc');
        const confirmBtn = document.getElementById('confirmRenameRepo');
        const updateButtonState = () => {
            const newName = nameInput.value.trim();
            const newDesc = descInput.value.trim();
            const nameChanged = newName !== repo.name;
            const descChanged = newDesc !== (repo.description || '');
            const isModified = nameChanged || descChanged;
            confirmBtn.disabled = !isModified;
            confirmBtn.classList.toggle('disabled', !isModified);
        };
        nameInput.oninput = updateButtonState;
        descInput.oninput = updateButtonState;
        confirmBtn.onclick = async () => {
            const newName = nameInput.value.trim();
            const newDesc = descInput.value.trim();
            if (newName === repo.name && newDesc === (repo.description || '')) return;
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '处理中 <i class="fa fa-spinner fa-spin"></i>';
            try {
                const res = await fetch(`https://api.github.com/repos/${repo.full_name}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${state.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: newName,
                        description: newDesc
                    })
                });
                if (!res.ok) throw new Error((await res.json()).message || '修改失败');
                showToast(`保存成功`);
                hideModal();
                state.repos = [];
                el.repoList.innerHTML = '';
                fetchRepos();
            } catch (e) {
                showToast(`修改失败: ${e.message}`);
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '确认';
            }
        };
        document.getElementById('cancelRenameRepo').onclick = hideModal;
    }
    function showDeleteRepoModal(repo) {
        showModal(`
            <div class="modal-form-container">
                <h3><span class="modal-title-text">确认删除仓库</span><button class="btn-icon-sm" onclick="hideModal()" title="关闭"><i class="fa fa-times"></i></button></h3>
                <p>确定要删除仓库 "${repo.name}" 吗？此操作不可撤销！</p>
                <div class="modal-buttons">
                    <button id="cancelDeleteRepo" class="btn btn-cancel">取消</button>
                    <button id="confirmDeleteRepo" class="btn btn-danger">确认删除</button>
                </div>
            </div>
        `);
        const confirmBtn = document.getElementById('confirmDeleteRepo');
        confirmBtn.onclick = async () => {
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '删除中 <i class="fa fa-spinner fa-spin"></i>';
            try {
                const res = await fetch(`https://api.github.com/repos/${repo.full_name}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `token ${state.token}`
                    }
                });
                if (!res.ok) throw new Error((await res.json()).message || '删除失败');
                showToast(`仓库 "${repo.name}" 已删除`);
                hideModal();
                fetchRepos();
            } catch (e) {
                showToast(`删除失败: ${e.message}`);
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '确认删除';
            }
        };
        document.getElementById('cancelDeleteRepo').onclick = hideModal;
    }
    function showDeleteModal(item, isDir) {
        el.deleteTitle.querySelector('.modal-title-text').textContent = '确认删除';
        el.deleteDesc.textContent = isDir ?
            `确定要删除文件夹 "${item.name}" 吗？这将删除该文件夹及其所有内容。` :
            `确定要删除文件 "${item.name}" 吗？此操作不可撤销。`;
        el.deleteModal.classList.remove('hidden');
        el.deleteConfirm.onclick = async function() {
            const confirmBtn = this;
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '处理中 <i class="fa fa-spinner fa-spin"></i>';
            const deleteFile = async (path, sha, name) => {
                const [owner, repo] = state.currentRepo.split('/');
                const res = await fetch(
                    `https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                        method: 'DELETE',
                        headers: {
                            Authorization: `token ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `Delete ${name}`,
                            sha: sha
                        })
                    }
                );
                if (!res.ok) {
                    const errorData = await res.json();
                    if (res.status === 409) {
                        throw new Error(`操作冲突：${errorData.message || '请刷新后重试'}`);
                    } else {
                        throw new Error(errorData.message || `删除失败 (HTTP ${res.status})`);
                    }
                }
            };
            const getAllFiles = async (path) => {
                const [owner, repo] = state.currentRepo.split('/');
                let allFiles = [];
                let page = 1;
                let hasMore = true;
                while (hasMore) {
                    const res = await fetch(
                        `https://api.github.com/repos/${owner}/${repo}/contents/${path}?page=${page}&per_page=100`, {
                            headers: {
                                Authorization: `token ${state.token}`
                            }
                        }
                    );
                    if (!res.ok) return [];
                    const items = await res.json();
                    if (!Array.isArray(items)) return [];
                    if (items.message && res.status === 404) return [];
                    for (const i of items) {
                        if (i.type === 'dir') {
                            const subFiles = await getAllFiles(i.path);
                            allFiles = [...allFiles, ...subFiles];
                        } else {
                            allFiles.push(i);
                        }
                    }
                    const linkHeader = res.headers.get('Link');
                    hasMore = linkHeader && linkHeader.includes('rel="next"');
                    page++;
                }
                return allFiles;
            };
            try {
                const targetPath = item.path;
                const safeName = escapeHtml(item.name);
                if (isDir) {
                    const allFiles = await getAllFiles(targetPath);
                    for (const f of allFiles) {
                        await deleteFile(f.path, f.sha, f.name);
                    }
                    showToast(`文件夹"${safeName}"已删除`);
                } else {
                    await deleteFile(targetPath, item.sha, item.name);
                    showToast(`文件"${safeName}"已删除`);
                }
                el.deleteModal.classList.add('hidden');
                fetchFiles(true);
            } catch (error) {
                showToast(`删除失败: ${error.message}`);
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '确认删除';
            }
        };
    }
    function goUp() {
        history.back();
    }
    
function init() {
    if (state.token) {
        showApp();
        // 使用 replaceState 设置初始状态，它不会在历史记录中创建新条目
        history.replaceState({ repo: null, path: '' }, '', window.location.pathname);
        loadReposFromCache();
        updateProxyUI();
    } else {
        showAuth();
    }
    setupEventListeners();
}
    document.addEventListener('DOMContentLoaded', init);
    function initMediaPreview() {
        const preview = document.getElementById('mediaPreview');
        const img = document.getElementById('mediaPreviewImg');
        const video = document.getElementById('mediaPreviewVideo');
        const audioExts = ['mp3', 'wav', 'ogg', 'flac', 'm4a'];
        let audioManager = {
            audio: null,
            currentUrl: '',
            currentName: '',
            isPlaying: false,
            init() {
                if (!this.audio) {
                    this.audio = new Audio();
                    this.audio.preload = 'none';
                    this.audio.crossOrigin = 'anonymous';
                    this.audio.addEventListener('play', () => {
                        this.isPlaying = true;
                    });
                    this.audio.addEventListener('pause', () => {
                        this.isPlaying = false;
                    });
                    this.audio.addEventListener('ended', () => {
                        this.isPlaying = false;
                        showToast(`播放完成: ${this.currentName}`);
                    });
                    this.audio.addEventListener('error', (e) => {
                        this.isPlaying = false;
                        showToast('播放出错');
                        console.error('Audio error:', e);
                    });
                    document.addEventListener('visibilitychange', () => {
                        if (!document.hidden && this.isPlaying && this.audio.paused) {
                            this.audio.play().catch(() => {});
                        }
                    });
                }
            },
            play(url, name) {
                this.init();
                showToast(`正在播放: ${name}`);
                if (this.currentUrl === url) {
                    if (this.audio.paused) {
                        this.audio.play().catch(() => {
                            showToast('播放失败');
                        });
                    } else {
                        this.audio.pause();
                        showToast(`已暂停: ${name}`);
                    }
                    return;
                }
                this.currentUrl = url;
                this.currentName = name;
                this.audio.src = url;
                const playPromise = this.audio.play();
                if (playPromise !== undefined) {
                    playPromise.catch((error) => {
                        showToast(`需要用户交互才能播放: ${name}`);
                        console.log('Autoplay prevented:', error);
                    });
                }
            }
        };
        preview.onclick = function() {
            preview.classList.add('hidden');
            img.src = '';
            video.src = '';
            img.style.display = 'none';
            video.style.display = 'none';
            video.pause();
        };
        document.getElementById('fileList').addEventListener('click', function(e) {
            if (e.target.classList.contains('multi-select-checkbox')) return;
            if (e.target.closest('.flex.gap-1,button')) return;
            const item = e.target.closest('.file-item');
            if (!item) return;
            const name = item.querySelector('.file-name') ? item.querySelector('.file-name').textContent : '';
            const ext = name.split('.').pop()?.toLowerCase();
            const file = state.files.find(f => f.name === name);
            if (!file || file.type !== 'file') return;
            const raw = file.download_url ? file.download_url : file.html_url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
            const url = getProxiedUrl(raw);
            if (audioExts.includes(ext)) {
                const nameWithoutExt = name.substring(0, name.lastIndexOf('.'));
                audioManager.play(url, nameWithoutExt);
                e.imagePreviewAction = true;
                e.preventDefault();
                e.stopPropagation();
                return;
            }
            if (['png', 'jpg', 'jpeg', 'gif', 'webp', 'bmp', 'svg'].includes(ext)) {
                img.src = url;
                img.style.display = '';
                video.style.display = 'none';
                preview.classList.remove('hidden');
                e.imagePreviewAction = true;
                e.preventDefault();
                e.stopPropagation();
                return;
            }
            if (['mp4', 'webm', 'ogg', 'mov', 'avi', 'mkv'].includes(ext)) {
                video.src = url;
                video.style.display = '';
                img.style.display = 'none';
                preview.classList.remove('hidden');
                e.imagePreviewAction = true;
                e.preventDefault();
                e.stopPropagation();
                video.load();
                return;
            }
        }, true);
    }
    document.addEventListener('DOMContentLoaded', initMediaPreview);
    function showCreateRepoModal() {
        el.createRepoNameInput.value = '';
        el.createRepoDescInput.value = '';
        el.createRepoPrivate.checked = true;
        el.repoNameError.style.display = 'none';
        el.createRepoModal.classList.remove('hidden');
        el.createRepoConfirm.disabled = true;
        function validateRepoName(name) {
            const chineseRegex = /[\u4e00-\u9fa5]/;
            if (chineseRegex.test(name)) {
                return '仓库名称不能包含中文字符';
            }
            const validNameRegex = /^[a-zA-Z0-9._-]+$/;
            
            
            if (name.length > 100) {
                return '仓库名称不能超过100个字符';
            }
            if (name.startsWith('.') || name.endsWith('.')) {
                return '仓库名称不能以点号开头或结尾';
            }
            return null;
        }
        el.createRepoNameInput.oninput = function() {
            const name = el.createRepoNameInput.value.trim();
            const error = validateRepoName(name);
            if (error) {
                el.repoNameError.textContent = error;
                el.repoNameError.style.display = 'block';
                el.createRepoConfirm.disabled = true;
            } else {
                el.repoNameError.style.display = 'none';
                el.createRepoConfirm.disabled = !name;
            }
        };
        el.createRepoConfirm.onclick = async function() {
            const name = el.createRepoNameInput.value.trim();
            const description = el.createRepoDescInput.value.trim();
            const isPrivate = !el.createRepoPrivate.checked;
            const error = validateRepoName(name);
            if (error || !name) return;
            el.createRepoConfirm.disabled = true;
            el.createRepoConfirm.innerHTML = '创建中 <i class="fa fa-spinner fa-spin"></i>';
            try {
                const res = await fetch('https://api.github.com/user/repos', {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${state.token}`,
                        'Content-Type': 'application/json',
                        'User-Agent': 'Mozilla/5.0'
                    },
                    body: JSON.stringify({
                        name: name,
                        description: description || undefined,
                        private: isPrivate,
                        auto_init: true
                    })
                });
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.message || '创建仓库失败');
                }
                await res.json();
                showToast(`仓库 "${name}" 创建成功`);
                el.createRepoModal.classList.add('hidden');
                fetchRepos();
            } catch (e) {
                showToast(`创建失败: ${e.message}`);
                el.createRepoConfirm.disabled = false;
                el.createRepoConfirm.innerHTML = '创建仓库';
            }
        };
    }
    document.addEventListener('DOMContentLoaded', function() {
        history.pushState(null, '', location.href);

// 将其替换为这个【新版本】
window.addEventListener('popstate', (event) => {
    // event.state 中包含了我们之前通过 pushState 存入的状态
    const historyState = event.state || { repo: null, path: '' };

    // 从历史状态中恢复应用的 state
    state.currentRepo = historyState.repo;
    state.currentPath = historyState.path;

    // 根据恢复的 state 重新渲染界面
    if (state.currentRepo) {
        // 如果历史状态是一个仓库，则显示文件列表
        const repoNameOnly = state.currentRepo.split('/')[1];
        el.currentRepo.textContent = repoNameOnly;
        renderPathNav();
        fetchFiles(true); // 使用 true 来强制刷新，确保数据一致性
        toggleView(false); 
    } else {
        // 如果历史状态是仓库列表，则显示仓库列表
        showRepoListView();
    }
});
    });
    (function() {
        const config = {
            minFontSize: 3,
            maxFontSize: 24,
            defaultFontSize: 10,
            storageKey: 'editor-font-size',
            scaleSensitivity: 0.01
        };
        function getSavedFontSize() {
            const saved = localStorage.getItem(config.storageKey);
            return saved ? parseInt(saved) : config.defaultFontSize;
        }
        function saveFontSize(size) {
            localStorage.setItem(config.storageKey, size);
        }
        function createFontSizeDisplay() {
            const display = document.createElement('div');
            display.style.cssText = `position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; padding: 6px 12px; border-radius: 12px; font-size: 12px; font-weight: bold; z-index: 1000; pointer-events: none; opacity: 0; transition: opacity 0.1s; background-color: rgba(0,0,0,0.5);`;
            return display;
        }
        function showFontSizeTooltip(display, size) {
            display.textContent = `${size}px`;
            display.style.opacity = '1';
            clearTimeout(display.hideTimeout);
            display.hideTimeout = setTimeout(() => {
                display.style.opacity = '0';
            }, 1000);
        }
        function initGestureControls() {
            const observer = new MutationObserver((mutations) => {
                const editModal = document.getElementById('editModal');
                const fileContent = document.getElementById('fileContent');
                const editorContainer = document.querySelector('.editor-container');
                if (editModal && fileContent && editorContainer && !fileContent.hasGestureControl) {
                    fileContent.hasGestureControl = true;
                    let currentSize = getSavedFontSize();
                    fileContent.style.fontSize = currentSize + 'px';
                    fileContent.style.lineHeight = (currentSize * 1.5) + 'px';
                    const fontSizeDisplay = createFontSizeDisplay();
                    editorContainer.appendChild(fontSizeDisplay);
                    let initialDistance = 0;
                    let initialFontSize = currentSize;
                    let isPinching = false;
                    function getTouchDistance(touches) {
                        const dx = touches[0].clientX - touches[1].clientX;
                        const dy = touches[0].clientY - touches[1].clientY;
                        return Math.sqrt(dx * dx + dy * dy);
                    }
                    function updateFontSize(size) {
                        size = Math.max(config.minFontSize, Math.min(config.maxFontSize, Math.round(size)));
                        currentSize = size;
                        fileContent.style.fontSize = size + 'px';
                        fileContent.style.lineHeight = (size * 1.5) + 'px';
                        showFontSizeTooltip(fontSizeDisplay, size);
                        saveFontSize(size);
                    }
                    fileContent.addEventListener('touchstart', (e) => {
                        if (e.touches.length === 2) {
                            e.preventDefault();
                            isPinching = true;
                            initialDistance = getTouchDistance(e.touches);
                            initialFontSize = currentSize;
                        }
                    }, {
                        passive: false
                    });
                    fileContent.addEventListener('touchmove', (e) => {
                        if (isPinching && e.touches.length === 2) {
                            e.preventDefault();
                            const currentDistance = getTouchDistance(e.touches);
                            const scale = currentDistance / initialDistance;
                            const newSize = initialFontSize * scale;
                            updateFontSize(newSize);
                        }
                    }, {
                        passive: false
                    });
                    fileContent.addEventListener('touchend', (e) => {
                        if (isPinching) {
                            isPinching = false;
                        }
                    });
                    fileContent.addEventListener('wheel', (e) => {
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            const delta = e.deltaY > 0 ? -1 : 1;
                            const newSize = currentSize + delta;
                            updateFontSize(newSize);
                        }
                    }, {
                        passive: false
                    });
                    fileContent.addEventListener('keydown', (e) => {
                        if ((e.ctrlKey || e.metaKey) && (e.key === '+' || e.key === '=')) {
                            e.preventDefault();
                            updateFontSize(currentSize + 1);
                        } else if ((e.ctrlKey || e.metaKey) && e.key === '-') {
                            e.preventDefault();
                            updateFontSize(currentSize - 1);
                        } else if ((e.ctrlKey || e.metaKey) && e.key === '0') {
                            e.preventDefault();
                            updateFontSize(config.defaultFontSize);
                        }
                    });
                    const editModalObserver = new MutationObserver(() => {
                        if (!editModal.classList.contains('hidden')) {
                            currentSize = getSavedFontSize();
                            fileContent.style.fontSize = currentSize + 'px';
                            fileContent.style.lineHeight = (currentSize * 1.5) + 'px';
                        }
                    });
                    editModalObserver.observe(editModal, {
                        attributes: true,
                        attributeFilter: ['class']
                    });
                    const helpText = document.createElement('div');
                    helpText.style.cssText = `position: absolute; bottom: 28px; right: 20px; color: white; font-size: 12px; opacity: 0.8; z-index: 100;`;
                    helpText.innerHTML = '双指缩放调整字体 | Ctrl+滚轮缩放';
                    editorContainer.appendChild(helpText);
                    setTimeout(() => {
                        helpText.style.transition = 'opacity 0.6s';
                        helpText.style.opacity = '0';
                        setTimeout(() => helpText.remove(), 500);
                    }, 10000);
                }
            });
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        }
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initGestureControls);
        } else {
            initGestureControls();
        }
    })();
    (function() {
        'use strict';
        const config = {
            buttonId: 'toggleMaximizeModal',
            modalId: 'editModal',
            closeButtonId: 'closeEditModal',
            maximizedClass: 'maximized',
            expandIcon: 'fa-expand',
            compressIcon: 'fa-compress',
            buttonTitle: {
                maximize: '最大化',
                restore: '恢复',
            },
        };
        let isMaximized = false;
        let maximizeButton = null;
        let editModal = null;
        let isToggling = false;
        let modalObserver = null;
        function createMaximizeButton() {
            const button = document.createElement('button');
            button.id = config.buttonId;
            button.title = config.buttonTitle.maximize;
            button.innerHTML = `<i class="fa ${config.expandIcon}"></i>`;
            return button;
        }
        function toggleMaximize() {
            if (!editModal || !maximizeButton || isToggling) return;
            isToggling = true;
            const icon = maximizeButton.querySelector('i');
            if (isMaximized) {
                editModal.classList.remove(config.maximizedClass);
                icon.classList.remove(config.compressIcon);
                icon.classList.add(config.expandIcon);
                maximizeButton.title = config.buttonTitle.maximize;
                isMaximized = false;
                try {
                    if (typeof window.adjustEditorDimensions === 'function') {
                        setTimeout(window.adjustEditorDimensions, 100);
                    }
                } catch (e) {
                    console.error('调整编辑器尺寸时出错：', e);
                }
            } else {
                editModal.classList.add(config.maximizedClass);
                icon.classList.remove(config.expandIcon);
                icon.classList.add(config.compressIcon);
                maximizeButton.title = config.buttonTitle.restore;
                isMaximized = true;
            }
            try {
                localStorage.setItem('editor-maximized', isMaximized.toString());
            } catch (e) {
                console.error('保存最大化状态失败：', e);
            }
            setTimeout(() => {
                isToggling = false;
            }, 300);
        }
        function restoreMaximizedState() {
            if (isToggling) return;
            try {
                const savedState = localStorage.getItem('editor-maximized') === 'true';
                if (savedState && editModal && !editModal.classList.contains('hidden') && !isMaximized) {
                    toggleMaximize();
                }
            } catch (e) {
                console.error('恢复最大化状态失败：', e);
            }
        }
        function resetMaximizedState() {
            if (isToggling) return;
            if (isMaximized) {
                isMaximized = true;
                toggleMaximize();
            }
        }
        function initializeButton() {
            if (maximizeButton) return;
            if (!editModal) {
                editModal = document.getElementById(config.modalId);
                if (!editModal) return;
            }
            const modalHeader = editModal.querySelector('.modal-header');
            const closeButton = document.getElementById(config.closeButtonId);
            if (!modalHeader || !closeButton) return;
            let buttonContainer = modalHeader.querySelector('div:last-child');
            if (!buttonContainer || buttonContainer.style.display !== 'flex') {
                buttonContainer = document.createElement('div');
                buttonContainer.style.cssText = 'display: flex; gap: 0.4rem;';
                if (closeButton.parentNode === modalHeader) {
                    modalHeader.removeChild(closeButton);
                }
                buttonContainer.appendChild(closeButton);
                modalHeader.appendChild(buttonContainer);
            }
            if (document.getElementById(config.buttonId)) {
                maximizeButton = document.getElementById(config.buttonId);
            } else {
                maximizeButton = createMaximizeButton();
                buttonContainer.insertBefore(maximizeButton, closeButton);
            }
            maximizeButton.removeEventListener('click', toggleMaximize);
            maximizeButton.addEventListener('click', toggleMaximize);
            if (!modalObserver) {
                modalObserver = new MutationObserver((mutations) => {
                    for (let mutation of mutations) {
                        if (mutation.attributeName === 'class') {
                            if (editModal.classList.contains('hidden')) {
                                resetMaximizedState();
                            } else {
                                setTimeout(restoreMaximizedState, 100);
                            }
                        }
                    }
                });
                modalObserver.observe(editModal, {
                    attributes: true,
                    attributeFilter: ['class'],
                });
            }
        }
        function init() {
            const observer = new MutationObserver(() => {
                if (!maximizeButton || !document.getElementById(config.buttonId) || !document.getElementById(config.modalId)) {
                    initializeButton();
                }
            });
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
            initializeButton();
            document.addEventListener('keydown', (e) => {
                if (editModal && !editModal.classList.contains('hidden')) {
                    if (e.key === 'F11' || (e.ctrlKey && e.shiftKey && e.key === 'M')) {
                        e.preventDefault();
                        toggleMaximize();
                    }
                }
            });
        }
        init();
    })();
    function openProxySettingsModal() {
        updateProxySettingsUI();
        renderProxyList();
        el.proxySettingsModal.classList.remove('hidden');
        if (!document.getElementById('importBtn')) {
            const btn = document.createElement('button');
            btn.id = 'importBtn';
            btn.className = 'btn-icon';
            btn.title = '导入代理';
            btn.innerHTML = '<i class="fa fa-download"></i>';
            btn.onclick = () => importProxies(true);
            document.querySelector('#proxySettingsModal .modal-buttons').insertBefore(btn, el.proxyAddBtn);
        }
    }
    function closeProxySettingsModal() {
        el.proxySettingsModal.classList.add('hidden');
    }
    function updateProxySettingsUI() {
        el.proxyGlobalEnableToggle.classList.toggle('active', state.proxyGlobalEnable);
        el.proxyGlobalEnableToggle.title = state.proxyGlobalEnable ? '全局代理已启用' : '全局代理已禁用';
    }
    async function testProxyConnectivity(proxyDetails) {
        let testRawUrl = 'https://raw.githubusercontent.com/rjdsq/rjdsq.github.io/main/proxy/proxy.txt';
        let proxiedTestUrl = '';
        const proxyInputUrl = (proxyDetails.url || '').trim();
        const proxyDomain = getDomainFromUrl(proxyInputUrl);
        if (!proxyInputUrl) {
            return {
                ok: false,
                ms: null,
                err: 'URL为空',
                type: proxyDetails.type
            };
        }
        if (proxyDetails.type === 'prefix') {
            let base = proxyInputUrl;
            if (!base.endsWith('/')) {
                base += '/';
            }
            proxiedTestUrl = base + testRawUrl;
        } else if (proxyDetails.type === 'raw_domain_replace') {
            proxiedTestUrl = testRawUrl.replace(/^(https?:\/\/raw\.)githubusercontent\.com(\/.*)$/i, `$1${proxyDomain}$2`);
            if (!proxiedTestUrl.startsWith('http')) {
                proxiedTestUrl = 'https://' + proxiedTestUrl;
            }
        } else {
            return {
                ok: false,
                ms: null,
                err: '未知测试类型',
                type: proxyDetails.type
            };
        }
        const start = performance.now();
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 8000);
            const r = await fetch(proxiedTestUrl, {
                method: 'GET',
                cache: 'no-store',
                signal: controller.signal
            });
            clearTimeout(timeoutId);
            if (!r.ok) {
                const errorText = await r.text().catch(() => null);
                console.error(`Proxy test failed for ${proxyDetails.url} (${proxyDetails.type}): HTTP ${r.status}, Body: ${errorText}`);
                return {
                    ok: false,
                    ms: null,
                    err: '连接失败 (404)',
                    type: proxyDetails.type
                };
            }
            await r.text();
            return {
                ok: true,
                ms: Math.round(performance.now() - start),
                err: null,
                type: proxyDetails.type
            };
        } catch (e) {
            let errorMsg = '连接失败 (404)';
            if (e.name === 'AbortError') {
                errorMsg = '连接失败 (超时)';
            } else if (e.message.includes('Failed to fetch')) {
                errorMsg = '连接失败 (网络错误)';
            }
            console.error(`Proxy test exception for ${proxyDetails.url} (${proxyDetails.type}): ${e.message}`, e);
            return {
                ok: false,
                ms: null,
                err: errorMsg,
                type: proxyDetails.type
            };
        }
    }
    async function determineBestProxyTypeAndTest(proxyUrl) {
        const results = await Promise.all([
            testProxyConnectivity({
                url: proxyUrl,
                type: 'prefix'
            }),
            testProxyConnectivity({
                url: proxyUrl,
                type: 'raw_domain_replace'
            })
        ]);
        let bestResult = {
            ok: false,
            ms: null,
            err: '所有模式均失败',
            type: null
        };
        let prefixResult = results[0];
        let rawDomainResult = results[1];
        if (prefixResult.ok && rawDomainResult.ok) {
            if (prefixResult.ms < rawDomainResult.ms) {
                bestResult = prefixResult;
            } else {
                bestResult = rawDomainResult;
            }
        } else if (prefixResult.ok) {
            bestResult = prefixResult;
        } else if (rawDomainResult.ok) {
            bestResult = rawDomainResult;
        } else {
            bestResult = prefixResult;
        }
        return bestResult;
    }
    function renderProxyList() {
        el.proxyListContainer.innerHTML = '';
        if (state.proxies.length === 0) {
            el.proxyListEmpty.classList.remove('hidden');
            el.proxyTestAllBtn.disabled = true;
            el.proxyClearAllBtn.disabled = true;
            el.proxyTestAllBtn.classList.add('disabled');
            el.proxyClearAllBtn.classList.add('disabled');
        } else {
            el.proxyListEmpty.classList.add('hidden');
            el.proxyTestAllBtn.disabled = false;
            el.proxyClearAllBtn.disabled = false;
            el.proxyTestAllBtn.classList.remove('disabled');
            el.proxyClearAllBtn.classList.remove('disabled');
        }
        state.proxies.forEach((proxy, index) => {
            const proxyItem = document.createElement('div');
            proxyItem.className = `proxy-item ${index === state.activeProxyIndex ? 'active' : ''}`;
            let latencyClass = 'text-gray-400';
            let latencyText = '未测试';
            if (proxy.status === 'testing') {
                latencyText = '测试中';
                latencyClass = '';
            } else if (proxy.status === 'ok') {
                if (proxy.latency <= 500) {
                    latencyClass = 'text-green-500';
                    latencyText = `${proxy.latency} ms (优)`;
                } else if (proxy.latency <= 2000) {
                    latencyText = `${proxy.latency} ms (中)`;
                    latencyClass = 'text-orange-400';
                } else {
                    latencyText = `${proxy.latency} ms (差)`;
                    latencyClass = 'text-red-400';
                }
            } else if (proxy.status === 'fail') {
                latencyClass = 'text-red-400';
                latencyText = `连接失败 (404)`;
            }
            let typeText = '未知类型';
            if (proxy.type === 'prefix') {
                typeText = '前缀代理';
            } else if (proxy.type === 'raw_domain_replace') {
                typeText = 'Raw域名替换';
            } else if (proxy.status === 'testing') {
                typeText = '测试中...';
            } else if (proxy.status === 'fail') {
                typeText = '类型未确定';
            }
            proxyItem.addEventListener('click', (e) => {
                if (e.target.closest('.edit-proxy-btn') || e.target.closest('.delete-proxy-btn')) {
                    return;
                }
                if (index === state.activeProxyIndex) {
                    return;
                }
                setActiveProxy(index);
            });
            proxyItem.innerHTML = `
                    <div class="proxy-info">
                        <div class="proxy-url" title="${proxy.url}">${proxy.url}</div>
                        <div class="proxy-latency ${latencyClass}">${latencyText} ${proxy.status === 'testing' ? '<span class="spinner-small"></span>' : ''}</div>
                        <div class="proxy-type" style="font-size:0.7rem; color:#6b7280; margin-top:0.2rem;">类型: ${typeText}</div>
                    </div>
                    <div class="proxy-actions">
                        <button class="btn-icon-sm edit-proxy-btn" data-index="${index}" title="编辑">
                            <i class="fa fa-pencil"></i>
                        </button>
                        <button class="btn-icon-sm delete-proxy-btn danger" data-index="${index}" title="删除">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                `;
            el.proxyListContainer.appendChild(proxyItem);
        });
        el.proxyListContainer.querySelectorAll('.edit-proxy-btn').forEach(button => {
            button.onclick = (e) => openAddEditProxyModal(parseInt(e.currentTarget.dataset.index));
        });
        el.proxyListContainer.querySelectorAll('.delete-proxy-btn').forEach(button => {
            button.onclick = (e) => showConfirmDeleteProxyModal(parseInt(e.currentTarget.dataset.index));
        });
        saveProxyConfig();
    }
    function saveProxyConfig() {
        localStorage.setItem('proxies', JSON.stringify(state.proxies));
        localStorage.setItem('active_proxy_index', JSON.stringify(state.activeProxyIndex));
        localStorage.setItem('proxy_global_enable', JSON.stringify(state.proxyGlobalEnable));
        updateProxyUI();
    }
    function openAddEditProxyModal(index = null) {
        state.editingProxyIndex = index;
        el.addEditProxyModal.classList.remove('hidden');
        el.addEditProxyUrlInput.value = '';
        el.addEditProxySaveBtn.innerHTML = '保存';
        el.autoDetectedProxyType.textContent = '保存时将自动测试并确定';
        el.addEditProxyError.style.display = 'none';
        const titleTextSpan = el.addEditProxyTitle.querySelector('.modal-title-text');
        if (index !== null && state.proxies[index]) {
            const proxy = state.proxies[index];
            titleTextSpan.textContent = '编辑代理';
            el.addEditProxyUrlInput.value = proxy.url;
            if (proxy.type) {
                 el.autoDetectedProxyType.textContent = proxy.type === 'prefix' ? '前缀代理' : 'Raw域名替换';
            }
        } else {
            titleTextSpan.textContent = '添加代理';
        }
        validateAddEditProxyInput();
    }
    function closeAddEditProxyModal() {
        el.addEditProxyModal.classList.add('hidden');
        state.editingProxyIndex = null;
        el.addEditProxySaveBtn.disabled = false;
        el.addEditProxySaveBtn.innerHTML = '保存';
    }
    function validateAddEditProxyInput() {
        const url = el.addEditProxyUrlInput.value.trim();
        let isValid = true;
        let errorMessage = '';
        if (!url) {
            isValid = false;
        } else if (!url.startsWith('http://') && !url.startsWith('https://')) {
            errorMessage = 'URL 必须以 http:// 或 https:// 开头';
            isValid = false;
        } else {
            const isDuplicate = state.proxies.some((p, idx) =>
                p.url === url && idx !== state.editingProxyIndex
            );
            if (isDuplicate) {
                errorMessage = '该代理 URL 已存在';
                isValid = false;
            }
        }
        if (errorMessage) {
            el.addEditProxyError.textContent = errorMessage;
            el.addEditProxyError.style.display = 'block';
        } else {
            el.addEditProxyError.style.display = 'none';
        }
        el.addEditProxySaveBtn.disabled = !isValid;
        return isValid;
    }
    function showConfirmDeleteProxyModal(index) {
        const proxy = state.proxies[index];
        el.confirmDeleteProxyTitle.querySelector('.modal-title-text').textContent = '确认删除代理';
        el.confirmDeleteProxyMessage.innerHTML = `确定要删除代理 <strong>"${escapeHtml(proxy.url)}"</strong> 吗？此操作不可撤销。`;
        el.confirmDeleteProxyModal.classList.remove('hidden');
        el.confirmDeleteProxyConfirmBtn.onclick = null;
        el.confirmDeleteProxyCancelBtn.onclick = null;
        el.confirmDeleteProxyConfirmBtn.onclick = async () => {
            el.confirmDeleteProxyConfirmBtn.disabled = true;
            el.confirmDeleteProxyConfirmBtn.innerHTML = `删除中 <span class="spinner-small"></span>`;
            try {
                await deleteProxy(index);
                hideConfirmDeleteProxyModal();
            } finally {
                el.confirmDeleteProxyConfirmBtn.disabled = false;
                el.confirmDeleteProxyConfirmBtn.innerHTML = '确认删除';
            }
        };
        el.confirmDeleteProxyCancelBtn.onclick = hideConfirmDeleteProxyModal;
    }
    function hideConfirmDeleteProxyModal() {
        el.confirmDeleteProxyModal.classList.add('hidden');
    }
    function showConfirmClearAllProxiesModal() {
        el.confirmClearAllProxiesModal.classList.remove('hidden');
        el.clearAllProxiesConfirmBtn.disabled = false;
        el.clearAllProxiesConfirmBtn.innerHTML = '确认清空';
    }
    function hideConfirmClearAllProxiesModal() {
        el.confirmClearAllProxiesModal.classList.add('hidden');
    }
    async function clearAllProxiesConfirmed() {
        el.clearAllProxiesConfirmBtn.disabled = true;
        el.clearAllProxiesConfirmBtn.innerHTML = `清空中 <span class="spinner-small"></span>`;
        state.proxies = [{
            url: "https://gh-proxy.com/",
            latency: null,
            status: null,
            err: null,
            type: null
        }];
        state.activeProxyIndex = 0;
        showToast('所有自定义代理已清空，仅保留默认代理。');
        hideConfirmClearAllProxiesModal();
        renderProxyList();
        await testSingleProxy(0);
    }
    async function deleteProxy(index) {
        state.proxies.splice(index, 1);
        if (state.activeProxyIndex === index) {
            state.activeProxyIndex = state.proxies.length > 0 ? 0 : -1;
        } else if (state.activeProxyIndex > index) {
            state.activeProxyIndex--;
        }
        showToast('代理已删除');
        renderProxyList();
    }
    function setActiveProxy(index) {
        if (index < 0 || index >= state.proxies.length) return;
        if (state.activeProxyIndex === index) {
            return;
        }
        state.activeProxyIndex = index;
        showToast(`已切换全局代理`);
        renderProxyList();
        if (state.currentRepo) {
            fetchFiles(true);
        }
    }
    async function testSingleProxy(index) {
        if (index < 0 || index >= state.proxies.length) return;
        const proxy = state.proxies[index];
        proxy.status = 'testing';
        proxy.latency = null;
        proxy.err = null;
        proxy.type = null;
        renderProxyList();
        const result = await determineBestProxyTypeAndTest(proxy.url);
        proxy.latency = result.ms;
        proxy.status = result.ok ? (result.ms <= 2000 ? 'ok' : 'fail') : 'fail';
        proxy.err = result.err;
        proxy.type = result.type;
        
        renderProxyList();
    }
    async function testAllProxies() {
       
        if (state.proxies.length === 0) {
            showToast('没有代理可供测试');
            return;
        }
        el.proxyTestAllBtn.disabled = true;
        el.proxyTestAllSpinner.classList.remove('hidden');
        state.proxies.forEach(proxy => {
            proxy.status = 'testing';
            proxy.latency = null;
            proxy.err = null;
            proxy.type = null;
        });
        renderProxyList();
        const testPromises = state.proxies.map(async (proxy, index) => {
            const result = await determineBestProxyTypeAndTest(proxy.url);
            state.proxies[index].latency = result.ms;
            state.proxies[index].status = result.ok ? (result.ms <= 2000 ? 'ok' : 'fail') : 'fail';
            state.proxies[index].err = result.err;
            state.proxies[index].type = result.type;

            renderProxyList();
        });
        await Promise.allSettled(testPromises);
        el.proxyTestAllBtn.disabled = false;
        el.proxyTestAllSpinner.classList.add('hidden');
        showToast('所有代理测试完成，若开启了vpn请关闭！');
        renderProxyList();
    }
    async function clearCache() {
        localStorage.removeItem('cached_repos');
        localStorage.removeItem('repos_cache_time');
        state.fileCache.clear();
        showToast('缓存已清除');
        if (state.currentRepo) {
            await fetchFiles(true);
        } else {
            await fetchRepos();
        }
        el.mainMenuPopup.classList.add('hidden');
    }
    async function importProxies(manual) {

    
        if(manual) showToast('导入远程代理中…');
        try {
            const res = await fetch('https://raw.githubusercontent.com/rjdsq/rjdsq.github.io/main/proxy/proxy.txt', {
                cache: 'no-store'
            });
            if (!res.ok) throw `状态码: ${res.status}`;
            const list = (await res.text()).split('\n')
                .map(l => l.trim())
                .filter(l => l && l.startsWith('http'))
                .filter(u => !state.proxies.some(p => p.url.replace(/\/$/, '') === u.replace(/\/$/, '')));
            if (list.length) {
                state.proxies.push(...list.map(url => ({
                    url,
                    latency: null,
                    status: null,
                    err: null,
                    type: null
                })));
                state.activeProxyIndex = state.activeProxyIndex < 0 ? 0 : state.activeProxyIndex;
                saveProxyConfig();
                renderProxyList();
                list.forEach((_, i) => testSingleProxy(state.proxies.length - list.length + i));
                if(manual) showToast(`新增 ${list.length} 个代理`);
            } else {
                if(manual) showToast('无新代理');
            }
        } catch (e) {
            if(manual) showToast(`导入失败: ${e}`);
        }
    }
    
document.documentElement.style.userSelect = 'none';
    
</script>

</body>
</html>
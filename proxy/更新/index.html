<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub 管理面板</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        :root {
            --primary-color: #5983f3;
            --background-color: #f4f5f7;
            --card-background: #ffffff;
            --text-color: #333;
            --subtle-text-color: #6c757d;
            --border-color: #dee2e6;
            --shadow-color: rgba(0, 0, 0, 0.06);
            --border-radius: 8px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 13px; } /* 减小基础字号 */
        body { font-family: 'Noto Sans SC', sans-serif; background: var(--background-color); color: var(--text-color); min-height: 100vh; }
        .hidden { display: none !important; }

        /* 登录页 */
        #login-wrapper { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 15px; }
        .login-container { width: 100%; max-width: 320px; padding: 25px; background: var(--card-background); border-radius: var(--border-radius); box-shadow: 0 4px 20px var(--shadow-color); text-align: center; }
        .login-container h1 { font-size: 1.2rem; font-weight: 500; margin-bottom: 5px; }
        .login-container p { font-size: 0.9rem; color: var(--subtle-text-color); margin-bottom: 20px; }
        .input-group input { width: 100%; padding: 8px; border: 1px solid var(--border-color); background: #f8f9fa; border-radius: 5px; font-size: 0.95rem; }
        .action-button { width: 100%; padding: 9px; margin-top: 15px; border: none; border-radius: 5px; background: var(--primary-color); color: white; font-size: 1rem; font-weight: 500; cursor: pointer; }
        #status-message { margin-top: 12px; font-size: 0.85rem; color: #d35400; min-height: 18px; }

        /* 主面板 */
        #dashboard-page { width: 100%; max-width: 580px; margin: 30px auto 100px auto; padding: 0 10px; }
        .card { background: var(--card-background); border-radius: var(--border-radius); box-shadow: 0 4px 20px var(--shadow-color); margin-bottom: 12px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; cursor: pointer; transition: background-color 0.2s ease; border-radius: var(--border-radius); }
        .card-header:hover { background-color: #f8f9fa; }
        .card-header h2 { font-size: 1rem; font-weight: 500; }
        .card-body { display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.3s ease-out; }
        .card-body > div { overflow: hidden; }
        .card-body.expanded { grid-template-rows: 1fr; }
        .card-content { padding: 0px 15px 15px 15px; border-top: 1px solid #f1f3f5; }
        
        .form-group { display: flex; align-items: center; justify-content: space-between; padding: 6px 0; font-size: 0.9rem; }
        .form-group label { color: var(--subtle-text-color); }
        .form-group-column { display: flex; flex-direction: column; gap: 8px; }
        .form-group-column label { font-size: 0.85rem; color: var(--subtle-text-color); margin-bottom: -4px;}
        .styled-input, .styled-textarea { width: 100%; padding: 6px 9px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 0.9rem; font-family: inherit; background: #f8f9fa; }
        .styled-textarea { resize: vertical; min-height: 40px; }
        .chevron { transition: transform 0.2s ease; font-size: 0.8rem; }
        .card-header.expanded .chevron { transform: rotate(90deg); }

        /* 底部操作栏 */
        .action-bar { position: fixed; bottom: 0; left: 0; right: 0; display: flex; justify-content: flex-end; align-items: center; gap: 8px; padding: 8px 15px; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(8px); border-top: 1px solid var(--border-color); z-index: 1000; }
        .btn { padding: 6px 12px; border: none; border-radius: 5px; font-size: 0.9rem; cursor: pointer; font-weight: 500; }
        .btn:disabled { background: #e9ecef !important; color: #adb5bd !important; cursor: not-allowed; }
        .primary-btn { background: var(--primary-color); color: white; }
        .secondary-btn { background: white; color: var(--text-color); border: 1px solid var(--border-color); }
        .toggle-switch { position: relative; display: inline-block; width: 36px; height: 20px; }
        .toggle-switch input { display: none; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #28a745; }
        input:checked + .slider:before { transform: translateX(16px); }
    </style>
</head>
<body>

    <div id="login-wrapper">
        <div class="login-container">
            <h1>GitHub 管理面板</h1>
            <p>输入您的 Personal Access Token</p>
            <div class="input-group"> <input type="password" id="github-token" placeholder="ghp_..."> </div>
            <button class="action-button" id="load-config-button">连接并加载</button>
            <div id="status-message"></div>
        </div>
    </div>

    <main id="dashboard-page" class="hidden">
        <div class="card">
            <div class="card-content" style="border-top: none; padding-top: 10px;">
                <div class="form-group"><label>强制更新</label><label class="toggle-switch"><input type="checkbox" id="force-update"><span class="slider"></span></label></div>
                <div class="form-group"><label>公告开启</label><label class="toggle-switch"><input type="checkbox" id="announcement-enabled"><span class="slider"></span></label></div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">
                <h2>公告内容</h2>
                <span class="chevron">▶</span>
            </div>
            <div class="card-body">
                <div><div class="card-content form-group-column" id="announcements-container"></div></div>
            </div>
        </div>
        <div id="version-list"></div>
        <div class="action-bar">
           <button class="btn secondary-btn" id="save-updates-button" disabled>保存更新</button>
           <button class="btn primary-btn" id="add-version-button" disabled>新增版本</button>
       </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const REPO_OWNER = "rjdsq";
            const REPO_NAME = "rjdsq.github.io";
            const FILE_PATH = "proxy/更新/config.json";

            const loginWrapper = document.getElementById('login-wrapper');
            const dashboardPage = document.getElementById('dashboard-page');
            const loadConfigBtn = document.getElementById('load-config-button');
            const statusMessage = document.getElementById('status-message');
            const githubTokenInput = document.getElementById('github-token');
            const addVersionButton = document.getElementById('add-version-button');
            const saveButton = document.getElementById('save-updates-button');
            let fileSHA = null;
            const API_BASE = 'https://api.github.com';

            function setStatus(message, isError = false) { statusMessage.textContent = message; statusMessage.style.color = isError ? '#d35400' : '#2ecc71'; }

            dashboardPage.addEventListener('click', (event) => {
                const header = event.target.closest('.card-header');
                if (!header) return;
                const body = header.nextElementSibling;
                const isExpanded = header.classList.toggle('expanded');
                if (body && body.classList.contains('card-body')) {
                    body.classList.toggle('expanded', isExpanded);
                }
            });

            async function loadConfig() {
                const token = githubTokenInput.value;
                if (!token) { setStatus('请输入 Personal Access Token。', true); return; }
                loadConfigBtn.disabled = true; loadConfigBtn.textContent = '加载中...'; setStatus('正在连接...', false);
                try {
                    const response = await fetch(`${API_BASE}/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, { headers: { 'Authorization': `token ${token}` } });
                    if (!response.ok) throw new Error(`${response.status}: ${response.statusText}`);
                    const data = await response.json();
                    fileSHA = data.sha;
                    const config = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                    populateUI(config);
                    loginWrapper.classList.add('hidden'); dashboardPage.classList.remove('hidden');
                    saveButton.disabled = false; addVersionButton.disabled = false;
                } catch (error) {
                    setStatus(`加载失败: ${error.message}`, true);
                    loadConfigBtn.disabled = false; loadConfigBtn.textContent = '连接并加载';
                }
            }
            
            function populateUI(config) {
                document.getElementById('force-update').checked = config.forceUpdate;
                document.getElementById('announcement-enabled').checked = config.announcementEnabled;
                const announcementsContainer = document.getElementById('announcements-container');
                announcementsContainer.innerHTML = '';
                config.announcements.forEach(text => { announcementsContainer.innerHTML += `<textarea class="styled-textarea">${text}</textarea>`; });
                while (announcementsContainer.childElementCount < 3) { announcementsContainer.innerHTML += `<textarea class="styled-textarea" placeholder="新公告"></textarea>`; }
                const versionList = document.getElementById('version-list');
                versionList.innerHTML = '';
                config.versionHistory.forEach((v, index) => { versionList.innerHTML += createVersionCardHTML(v, index === 0); });
            }

            function collectDataFromUI() {
                const announcements = Array.from(document.querySelectorAll('#announcements-container textarea')).map(t => t.value);
                const versionHistory = Array.from(document.querySelectorAll('.version-card-content')).map(card => ({
                    version: card.querySelector('[data-field="version"]').value, releaseDate: card.querySelector('[data-field="releaseDate"]').value,
                    optimizedFunctions: card.querySelector('[data-field="optimizedFunctions"]').value, newFunctions: card.querySelector('[data-field="newFunctions"]').value,
                    downloadUrl: card.querySelector('[data-field="downloadUrl"]').value,
                }));
                const latestVersion = versionHistory.length > 0 ? versionHistory[0].version : "1.0";
                return { latestVersion, forceUpdate: document.getElementById('force-update').checked, announcementEnabled: document.getElementById('announcement-enabled').checked, announcements, versionHistory };
            }
            
            async function saveConfig() {
                const token = githubTokenInput.value;
                saveButton.disabled = true; saveButton.textContent = '保存中...';
                try {
                    const updatedConfig = collectDataFromUI();
                    const content = btoa(unescape(encodeURIComponent(JSON.stringify(updatedConfig, null, 2))));
                    const response = await fetch(`${API_BASE}/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                        method: 'PUT', headers: { 'Authorization': `token ${token}` },
                        body: JSON.stringify({ message: `[Admin Panel] Update config.json`, content: content, sha: fileSHA })
                    });
                    if (!response.ok) throw new Error(`${response.status}: ${response.statusText}`);
                    fileSHA = (await response.json()).content.sha;
                    alert('配置已成功更新！');
                } catch(error) {
                    alert(`保存出错: ${error.message}`);
                } finally {
                    saveButton.disabled = false; saveButton.textContent = '保存更新';
                }
            }
            
            function addNewVersionCard() {
                const firstVersionInput = document.querySelector('.version-card-content [data-field="version"]');
                const [major = 1, minor = 0] = firstVersionInput ? firstVersionInput.value.split('.').map(Number) : [];
                const newVersion = `${major}.${(minor || 0) + 1}`;
                document.querySelectorAll('.card-header.expanded').forEach(header => header.click());
                const today = new Date(); const formattedDate = `${today.getFullYear()}/${today.getMonth() + 1}/${today.getDate()}`;
                const newVersionData = { version: newVersion, releaseDate: formattedDate, optimizedFunctions: "", newFunctions: "", downloadUrl: "" };
                document.getElementById('version-list').insertAdjacentHTML('afterbegin', createVersionCardHTML(newVersionData, true));
            }
            
            function createVersionCardHTML(v, isExpanded = false) {
                const expandedClass = isExpanded ? 'expanded' : '';
                return `
                <div class="card version-card">
                    <div class="card-header ${expandedClass}">
                        <h2>版本: ${v.version} <span style="font-size: 0.8rem; color: var(--subtle-text-color); font-weight: 400;">(${v.releaseDate})</span></h2>
                        <span class="chevron">▶</span>
                    </div>
                    <div class="card-body ${expandedClass}">
                        <div>
                            <div class="card-content form-group-column version-card-content">
                                <div style="display: flex; gap: 8px;">
                                    <div style="flex: 1;"><label>版本号</label><input type="text" class="styled-input" data-field="version" value="${v.version}"></div>
                                    <div style="flex: 1;"><label>发布日期</label><input type="text" class="styled-input" data-field="releaseDate" value="${v.releaseDate}"></div>
                                </div>
                                <label>优化功能</label><textarea class="styled-textarea" data-field="optimizedFunctions">${v.optimizedFunctions}</textarea>
                                <label>新增功能</label><textarea class="styled-textarea" data-field="newFunctions">${v.newFunctions}</textarea>
                                <label>下载地址</label><input type="text" class="styled-input" data-field="downloadUrl" value="${v.downloadUrl}">
                            </div>
                        </div>
                    </div>
                </div>`;
            }

            loadConfigBtn.addEventListener('click', loadConfig);
            saveButton.addEventListener('click', saveConfig);
            addVersionButton.addEventListener('click', addNewVersionCard);
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub 管理面板</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        :root {
            --primary-gradient: linear-gradient(45deg, #f86cfc, #5983f3);
            --secondary-gradient: linear-gradient(45deg, #81e7f1, #30c7ec);
            --background-gradient: linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%);
            --card-background: rgba(255, 255, 255, 0.7);
            --text-color: #2c3e50;
            --subtle-text-color: #7f8c8d;
            --border-color: rgba(200, 200, 200, 0.5);
            --shadow-color: rgba(100, 100, 150, 0.1);
            --border-radius: 10px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans SC', sans-serif; background: var(--background-gradient); color: var(--text-color); display: flex; align-items: center; justify-content: center; min-height: 100vh; padding-bottom: 100px; }
        .hidden { display: none !important; }

        /* 登录与配置 */
        .login-container { width: 100%; max-width: 360px; padding: 25px; background: var(--card-background); border-radius: var(--border-radius); box-shadow: 0 8px 32px 0 var(--shadow-color); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.18); text-align: center; }
        .login-container h1 { font-size: 20px; font-weight: 500; margin-bottom: 20px; }
        .input-group { margin-bottom: 12px; text-align: left; }
        .input-group label { font-size: 12px; color: var(--subtle-text-color); display: block; margin-bottom: 4px; }
        .input-group input { width: 100%; padding: 8px; border: 1px solid var(--border-color); background: rgba(255,255,255,0.5); border-radius: 6px; font-size: 14px; outline: none; transition: all 0.3s; }
        .input-group input:focus { border-color: #5983f3; box-shadow: 0 0 0 3px rgba(89, 131, 243, 0.2); }
        .action-button { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 6px; background: var(--primary-gradient); color: white; font-size: 15px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .action-button:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(100, 100, 150, 0.2); }
        .action-button:disabled { background: #ccc; cursor: not-allowed; }
        #status-message { margin-top: 15px; font-size: 13px; color: #d35400; min-height: 20px; }

        /* 主面板 */
        #dashboard-page { width: 100%; max-width: 750px; padding: 20px 15px; }
        .config-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .config-row > .card { flex: 1; }
        .card { background: var(--card-background); border-radius: var(--border-radius); padding: 15px; box-shadow: 0 8px 32px 0 var(--shadow-color); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.18); }
        .card h2 { font-size: 14px; font-weight: 500; margin-bottom: 12px; }
        .form-group { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; font-size: 13px; }
        .form-group label { color: var(--subtle-text-color); }
        .form-group-column { display: flex; flex-direction: column; gap: 8px; }
        .styled-input, .styled-textarea { width: 100%; padding: 6px 8px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 13px; font-family: 'Noto Sans SC', sans-serif; background: rgba(255,255,255,0.4); transition: all 0.3s; }
        .styled-textarea { resize: vertical; min-height: 35px; }
        .version-card { border-left: 3px solid transparent; border-image: var(--secondary-gradient) 1; margin-bottom: 12px; animation: fadeIn 0.5s; }
        .version-card .card:hover { border-color: #5983f3; }
        .version-card.new { border-image: linear-gradient(to top, #2ed573, #7bed9f) 1; }
        .toggle-switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .toggle-switch input { display: none; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 22px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background: var(--secondary-gradient); }
        input:checked + .slider:before { transform: translateX(18px); }

        /* 底部操作栏 */
        .action-bar { position: fixed; bottom: 0; left: 0; right: 0; display: flex; justify-content: flex-end; align-items: center; gap: 10px; padding: 12px 25px; background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(12px); border-top: 1px solid rgba(255, 255, 255, 0.18); }
        .btn { display: flex; align-items: center; justify-content: center; gap: 6px; padding: 8px 12px; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; transition: all 0.3s; font-weight: 500; }
        .btn:disabled { background: #ccc !important; color: #888 !important; cursor: not-allowed; transform: none; box-shadow: none;}
        .primary-btn { background: var(--primary-gradient); color: white; }
        .secondary-btn { background: var(--card-background); color: var(--text-color); border: 1px solid var(--border-color); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="login-page">
        <div class="login-container">
            <h1>GitHub 配置面板</h1>
            <div class="input-group">
                <label for="github-token">Personal Access Token</label>
                <input type="password" id="github-token" placeholder="ghp_...">
            </div>
            <div class="input-group">
                <label for="repo-owner">仓库所有者 (用户名)</label>
                <input type="text" id="repo-owner" placeholder="e.g., your-username">
            </div>
             <div class="input-group">
                <label for="repo-name">仓库名称</label>
                <input type="text" id="repo-name" placeholder="e.g., your-repo-name">
            </div>
            <div class="input-group">
                <label for="file-path">配置文件路径</label>
                <input type="text" id="file-path" value="config.json">
            </div>
            <button class="action-button" id="load-config-button">连接并加载配置</button>
            <div id="status-message"></div>
        </div>
    </div>

    <main id="dashboard-page" class="hidden">
        <div class="config-row">
            <div class="card">
                <h2>全局配置</h2>
                <div class="form-group">
                    <label for="latest-version">最新版本</label>
                    <input type="text" id="latest-version" class="styled-input" style="width: 60px; text-align: center;">
                </div>
                <div class="form-group">
                    <label>强制更新</label>
                    <label class="toggle-switch"><input type="checkbox" id="force-update"><span class="slider"></span></label>
                </div>
                <div class="form-group">
                    <label>公告开启</label>
                    <label class="toggle-switch"><input type="checkbox" id="announcement-enabled"><span class="slider"></span></label>
                </div>
            </div>
            <div class="card">
                <h2>公告内容</h2>
                 <div id="announcements-container" class="form-group-column">
                    <textarea class="styled-textarea" data-announcement-index="0"></textarea>
                    <textarea class="styled-textarea" data-announcement-index="1"></textarea>
                    <textarea class="styled-textarea" data-announcement-index="2"></textarea>
                </div>
            </div>
        </div>
        
        <div class="version-history card">
            <h2>版本历史</h2>
            <div id="version-list"></div>
        </div>
        
        <div class="action-bar">
           <button class="btn secondary-btn" id="save-updates-button" disabled>
               <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
               保存更新
           </button>
           <button class="btn primary-btn" id="add-version-button" disabled>
               <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
               新增版本
           </button>
       </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loginPage = document.getElementById('login-page');
            const dashboardPage = document.getElementById('dashboard-page');
            const loadConfigBtn = document.getElementById('load-config-button');
            const statusMessage = document.getElementById('status-message');
            
            const githubTokenInput = document.getElementById('github-token');
            const repoOwnerInput = document.getElementById('repo-owner');
            const repoNameInput = document.getElementById('repo-name');
            const filePathInput = document.getElementById('file-path');
            
            const addVersionButton = document.getElementById('add-version-button');
            const saveButton = document.getElementById('save-updates-button');
            
            let fileSHA = null;
            let currentConfig = {};

            const API_BASE = 'https://api.github.com';

            function setStatus(message, isError = false) {
                statusMessage.textContent = message;
                statusMessage.style.color = isError ? '#e74c3c' : '#2ecc71';
            }

            function setButtonsState(button, isLoading, defaultText) {
                if (isLoading) {
                    button.disabled = true;
                    button.textContent = '处理中...';
                } else {
                    button.disabled = false;
                    button.innerHTML = defaultText;
                }
            }

            async function loadConfig() {
                const token = githubTokenInput.value;
                const owner = repoOwnerInput.value;
                const repo = repoNameInput.value;
                const path = filePathInput.value;

                if (!token || !owner || !repo || !path) {
                    setStatus('所有字段均为必填项。', true);
                    return;
                }

                setButtonsState(loadConfigBtn, true);
                setStatus('正在加载配置...', false);

                try {
                    const response = await fetch(`${API_BASE}/repos/${owner}/${repo}/contents/${path}`, {
                        headers: { 'Authorization': `token ${token}` }
                    });

                    if (!response.ok) throw new Error(`无法获取文件: ${response.statusText}`);

                    const data = await response.json();
                    fileSHA = data.sha;
                    const content = atob(data.content);
                    currentConfig = JSON.parse(content);
                    
                    populateUI(currentConfig);

                    loginPage.classList.add('hidden');
                    dashboardPage.classList.remove('hidden');
                    saveButton.disabled = false;
                    addVersionButton.disabled = false;

                } catch (error) {
                    setStatus(`加载失败: ${error.message}`, true);
                    setButtonsState(loadConfigBtn, false, '连接并加载配置');
                }
            }
            
            function populateUI(config) {
                document.getElementById('latest-version').value = config.latestVersion;
                document.getElementById('force-update').checked = config.forceUpdate;
                document.getElementById('announcement-enabled').checked = config.announcementEnabled;

                const announcementInputs = document.querySelectorAll('#announcements-container textarea');
                announcementInputs.forEach((textarea, index) => {
                    textarea.value = config.announcements[index] || '';
                });

                const versionList = document.getElementById('version-list');
                versionList.innerHTML = '';
                config.versionHistory.forEach(v => {
                    versionList.innerHTML += createVersionCardHTML(v);
                });
            }

            function collectDataFromUI() {
                const announcements = [];
                document.querySelectorAll('#announcements-container textarea').forEach(textarea => {
                    announcements.push(textarea.value);
                });

                const versionHistory = [];
                document.querySelectorAll('.version-card-content').forEach(card => {
                    versionHistory.push({
                        version: card.querySelector('[data-field="version"]').value,
                        releaseDate: card.querySelector('[data-field="releaseDate"]').value,
                        optimizedFunctions: card.querySelector('[data-field="optimizedFunctions"]').value,
                        newFunctions: card.querySelector('[data-field="newFunctions"]').value,
                        downloadUrl: card.querySelector('[data-field="downloadUrl"]').value,
                    });
                });
                
                return {
                    latestVersion: document.getElementById('latest-version').value,
                    forceUpdate: document.getElementById('force-update').checked,
                    announcementEnabled: document.getElementById('announcement-enabled').checked,
                    announcements,
                    versionHistory
                };
            }
            
            async function saveConfig() {
                const token = githubTokenInput.value;
                const owner = repoOwnerInput.value;
                const repo = repoNameInput.value;
                const path = filePathInput.value;

                const defaultBtnText = saveButton.innerHTML;
                setButtonsState(saveButton, true, defaultBtnText);
                
                try {
                    const updatedConfig = collectDataFromUI();
                    const content = btoa(JSON.stringify(updatedConfig, null, 2));

                    const response = await fetch(`${API_BASE}/repos/${owner}/${repo}/contents/${path}`, {
                        method: 'PUT',
                        headers: { 'Authorization': `token ${token}` },
                        body: JSON.stringify({
                            message: `[Admin Panel] Update config.json`,
                            content: content,
                            sha: fileSHA
                        })
                    });

                    if (!response.ok) throw new Error(`保存失败: ${response.statusText}`);

                    const data = await response.json();
                    fileSHA = data.content.sha; // Update SHA for next save
                    alert('配置已成功更新到 GitHub！');

                } catch(error) {
                    alert(`保存出错: ${error.message}`);
                } finally {
                    setButtonsState(saveButton, false, defaultBtnText);
                }
            }
            
            function addNewVersionCard() {
                const latestVersionInput = document.getElementById('latest-version');
                const currentVersion = latestVersionInput.value;
                const versionParts = currentVersion.split('.').map(Number);
                versionParts[versionParts.length - 1] = (versionParts[versionParts.length - 1] || 0) + 1;
                const newVersion = versionParts.join('.');
                latestVersionInput.value = newVersion;
                
                const today = new Date();
                const formattedDate = `${today.getFullYear()}/${today.getMonth() + 1}/${today.getDate()}`;
                
                const newVersionData = {
                    version: newVersion,
                    releaseDate: formattedDate,
                    optimizedFunctions: "", newFunctions: "", downloadUrl: ""
                };
                
                const versionList = document.getElementById('version-list');
                const newCardHTML = createVersionCardHTML(newVersionData, true);
                versionList.insertAdjacentHTML('afterbegin', newCardHTML);
            }
            
            function createVersionCardHTML(versionData, isNew = false) {
                return `
                <div class="version-card ${isNew ? 'new' : ''}">
                    <div class="card version-card-content" style="backdrop-filter: none; background: rgba(255,255,255,0.4)">
                        <div class="form-group-column">
                            <div style="display: flex; gap: 10px;">
                                <div style="flex: 1;"><label>版本号</label><input type="text" class="styled-input" data-field="version" value="${versionData.version}"></div>
                                <div style="flex: 1;"><label>发布日期</label><input type="text" class="styled-input" data-field="releaseDate" value="${versionData.releaseDate}"></div>
                            </div>
                            <label>优化功能</label><textarea class="styled-input" data-field="optimizedFunctions">${versionData.optimizedFunctions}</textarea>
                            <label>新增功能</label><textarea class="styled-input" data-field="newFunctions">${versionData.newFunctions}</textarea>
                            <label>下载地址</label><input type="text" class="styled-input" data-field="downloadUrl" value="${versionData.downloadUrl}">
                        </div>
                    </div>
                </div>`;
            }

            loadConfigBtn.addEventListener('click', loadConfig);
            saveButton.addEventListener('click', saveConfig);
            addVersionButton.addEventListener('click', addNewVersionCard);
        });
    </script>
</body>
</html>
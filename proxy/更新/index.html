<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub 管理面板</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        :root {
            --primary-color: #5983f3;
            --primary-gradient: linear-gradient(45deg, #7c4dff, #5983f3);
            --secondary-gradient: linear-gradient(45deg, #29b6f6, #81e7f1);
            --background-gradient: linear-gradient(120deg, #f8f9fa 0%, #e9ecef 100%);
            --card-background: rgba(255, 255, 255, 0.9);
            --text-color: #343a40;
            --subtle-text-color: #6c757d;
            --border-color: rgba(0, 0, 0, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.05);
            --border-radius: 8px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 12px; }
        body { font-family: 'Noto Sans SC', sans-serif; background: var(--background-gradient); color: var(--text-color); min-height: 100vh; }
        .hidden { display: none !important; }

        /* 登录页 */
        #login-wrapper { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 15px; }
        .login-container { width: 100%; max-width: 320px; padding: 25px; background: var(--card-background); border-radius: var(--border-radius); box-shadow: 0 5px 25px var(--shadow-color); backdrop-filter: blur(8px); text-align: center; }
        .login-container h1 { font-size: 1.2rem; font-weight: 500; margin-bottom: 5px; }
        .login-container p { font-size: 0.9rem; color: var(--subtle-text-color); margin-bottom: 20px; }
        .input-group input { width: 100%; padding: 8px; border: 1px solid var(--border-color); background: rgba(255,255,255,0.7); border-radius: 5px; font-size: 0.95rem; }
        .action-button { width: 100%; padding: 9px; margin-top: 15px; border: none; border-radius: 5px; background: var(--primary-gradient); color: white; font-size: 1rem; font-weight: 500; cursor: pointer; }
        #status-message { margin-top: 12px; font-size: 0.85rem; color: #d35400; min-height: 18px; }

        /* 主面板 */
        #dashboard-page { width: 100%; max-width: 520px; margin: 30px auto 100px auto; padding: 0 10px; }
        .card { background: var(--card-background); border-radius: var(--border-radius); box-shadow: 0 5px 25px var(--shadow-color); backdrop-filter: blur(8px); margin-bottom: 10px; padding: 12px; }
        .card h2 { font-size: 0.95rem; font-weight: 500; }
        .form-group { display: flex; align-items: center; justify-content: space-between; padding: 3px 0; font-size: 0.9rem; }
        .form-group label { color: var(--subtle-text-color); }
        .form-group-column { display: flex; flex-direction: column; gap: 6px; }
        .form-group-column label { font-size: 0.8rem; color: var(--subtle-text-color); margin-bottom: -2px;}
        .styled-input, .styled-textarea { width: 100%; padding: 5px 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.9rem; font-family: inherit; background: rgba(240,245,255,0.5); }
        .styled-textarea { resize: vertical; min-height: 35px; }
        
        /* 折叠 */
        .collapsible-header { cursor: pointer; outline: none; -webkit-tap-highlight-color: transparent; display: flex; justify-content: space-between; align-items: center; }
        .chevron { transition: transform 0.2s ease; font-size: 0.7rem; }
        .collapsible-header.expanded .chevron { transform: rotate(90deg); }
        .collapsible-content { display: grid; grid-template-rows: 0fr; opacity: 0; transition: grid-template-rows 0.3s ease-out, opacity 0.2s ease-out; }
        .collapsible-content > div { overflow: hidden; }
        .collapsible-content.expanded { grid-template-rows: 1fr; opacity: 1; }
        .collapsible-content-inner { padding-top: 12px; }
        .version-card { padding: 0; border-left: 3px solid var(--subtle-text-color); transition: border-color 0.3s ease; }
        .version-card.expanded { border-color: var(--primary-color); }
        .version-card .collapsible-header { padding: 10px 12px; }
        
        /* 底部操作栏 */
        .action-bar { position: fixed; bottom: 0; left: 0; right: 0; display: flex; justify-content: flex-end; align-items: center; gap: 8px; padding: 8px 15px; background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border-top: 1px solid rgba(0, 0, 0, 0.05); z-index: 1000; }
        .btn { display: flex; align-items: center; justify-content: center; gap: 5px; padding: 6px 10px; border: none; border-radius: 5px; font-size: 0.85rem; cursor: pointer; font-weight: 500; }
        .btn:disabled { background: #ccc !important; color: #888 !important; cursor: not-allowed; }
        .primary-btn { background: var(--primary-gradient); color: white; }
        .secondary-btn { background: white; color: var(--text-color); border: 1px solid var(--border-color); }
        .toggle-switch { position: relative; display: inline-block; width: 34px; height: 18px; }
        .toggle-switch input { display: none; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 18px; }
        .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background: var(--secondary-gradient); }
        input:checked + .slider:before { transform: translateX(16px); }
    </style>
</head>
<body>

    <div id="login-wrapper">
        <div class="login-container">
            <h1>GitHub 管理面板</h1>
            <p>输入您的 Personal Access Token</p>
            <div class="input-group"> <input type="password" id="github-token" placeholder="ghp_..."> </div>
            <button class="action-button" id="load-config-button">连接并加载</button>
            <div id="status-message"></div>
        </div>
    </div>

    <main id="dashboard-page" class="hidden">
        <div class="card">
             <h2>全局配置</h2>
             <div class="form-group"><label>强制更新</label><label class="toggle-switch"><input type="checkbox" id="force-update"><span class="slider"></span></label></div>
             <div class="form-group"><label>公告开启</label><label class="toggle-switch"><input type="checkbox" id="announcement-enabled"><span class="slider"></span></label></div>
        </div>
        <div class="card">
            <div class="collapsible-header">
                <h2>公告内容</h2>
                <span class="chevron">▶</span>
            </div>
            <div class="collapsible-content">
                <div class="collapsible-content-inner"><div id="announcements-container" class="form-group-column"></div></div>
            </div>
        </div>
        <div id="version-list"></div>
        <div class="action-bar">
           <button class="btn secondary-btn" id="save-updates-button" disabled>保存更新</button>
           <button class="btn primary-btn" id="add-version-button" disabled>新增版本</button>
       </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const REPO_OWNER = "rjdsq";
            const REPO_NAME = "rjdsq.github.io";
            const FILE_PATH = "proxy/更新/config.json";

            const loginWrapper = document.getElementById('login-wrapper');
            const dashboardPage = document.getElementById('dashboard-page');
            const loadConfigBtn = document.getElementById('load-config-button');
            const statusMessage = document.getElementById('status-message');
            const githubTokenInput = document.getElementById('github-token');
            const addVersionButton = document.getElementById('add-version-button');
            const saveButton = document.getElementById('save-updates-button');
            let fileSHA = null;
            const API_BASE = 'https://api.github.com';

            function setStatus(message, isError = false) { statusMessage.textContent = message; statusMessage.style.color = isError ? '#e74c3c' : '#2ecc71'; }

            dashboardPage.addEventListener('click', (event) => {
                const header = event.target.closest('.collapsible-header');
                if (!header) return;
                const card = header.closest('.card');
                const content = header.nextElementSibling;
                const isExpanded = header.classList.toggle('expanded');
                content.classList.toggle('expanded', isExpanded);
                if (card) card.classList.toggle('expanded', isExpanded);
            });

            async function loadConfig() {
                const token = githubTokenInput.value;
                if (!token) { setStatus('请输入 Personal Access Token。', true); return; }
                loadConfigBtn.disabled = true; loadConfigBtn.textContent = '加载中...'; setStatus('正在连接...', false);
                try {
                    const response = await fetch(`${API_BASE}/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, { headers: { 'Authorization': `token ${token}` } });
                    if (!response.ok) throw new Error(`${response.status}: ${response.statusText}`);
                    const data = await response.json();
                    fileSHA = data.sha;
                    const config = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                    populateUI(config);
                    loginWrapper.classList.add('hidden'); dashboardPage.classList.remove('hidden');
                    saveButton.disabled = false; addVersionButton.disabled = false;
                } catch (error) {
                    setStatus(`加载失败: ${error.message}`, true);
                    loadConfigBtn.disabled = false; loadConfigBtn.textContent = '连接并加载';
                }
            }
            
            function populateUI(config) {
                document.getElementById('force-update').checked = config.forceUpdate;
                document.getElementById('announcement-enabled').checked = config.announcementEnabled;
                const announcementsContainer = document.getElementById('announcements-container');
                announcementsContainer.innerHTML = '';
                config.announcements.forEach(text => { announcementsContainer.innerHTML += `<textarea class="styled-textarea">${text}</textarea>`; });
                while (announcementsContainer.childElementCount < 3) { announcementsContainer.innerHTML += `<textarea class="styled-textarea" placeholder="新公告"></textarea>`; }
                const versionList = document.getElementById('version-list');
                versionList.innerHTML = '';
                config.versionHistory.forEach((v, index) => { versionList.innerHTML += createVersionCardHTML(v, index === 0); });
            }

            function collectDataFromUI() {
                const announcements = Array.from(document.querySelectorAll('#announcements-container textarea')).map(t => t.value);
                const versionHistory = Array.from(document.querySelectorAll('.version-card-content')).map(card => ({
                    version: card.querySelector('[data-field="version"]').value, releaseDate: card.querySelector('[data-field="releaseDate"]').value,
                    optimizedFunctions: card.querySelector('[data-field="optimizedFunctions"]').value, newFunctions: card.querySelector('[data-field="newFunctions"]').value,
                    downloadUrl: card.querySelector('[data-field="downloadUrl"]').value,
                }));
                const latestVersion = versionHistory.length > 0 ? versionHistory[0].version : "1.0";
                return { latestVersion, forceUpdate: document.getElementById('force-update').checked, announcementEnabled: document.getElementById('announcement-enabled').checked, announcements, versionHistory };
            }
            
            async function saveConfig() {
                const token = githubTokenInput.value;
                saveButton.disabled = true; saveButton.textContent = '保存中...';
                try {
                    const updatedConfig = collectDataFromUI();
                    const content = btoa(unescape(encodeURIComponent(JSON.stringify(updatedConfig, null, 2))));
                    const response = await fetch(`${API_BASE}/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                        method: 'PUT', headers: { 'Authorization': `token ${token}` },
                        body: JSON.stringify({ message: `[Admin Panel] Update config.json`, content: content, sha: fileSHA })
                    });
                    if (!response.ok) throw new Error(`${response.status}: ${response.statusText}`);
                    fileSHA = (await response.json()).content.sha;
                    alert('配置已成功更新！');
                } catch(error) {
                    alert(`保存出错: ${error.message}`);
                } finally {
                    saveButton.disabled = false; saveButton.textContent = '保存更新';
                }
            }
            
            function addNewVersionCard() {
                const firstVersionInput = document.querySelector('#version-list [data-field="version"]');
                const [major = 1, minor = 0] = firstVersionInput ? firstVersionInput.value.split('.').map(Number) : [];
                const newVersion = `${major}.${(minor || 0) + 1}`;
                document.querySelectorAll('.collapsible-header.expanded').forEach(el => el.click());
                const today = new Date(); const formattedDate = `${today.getFullYear()}/${today.getMonth() + 1}/${today.getDate()}`;
                const newVersionData = { version: newVersion, releaseDate: formattedDate, optimizedFunctions: "", newFunctions: "", downloadUrl: "" };
                document.getElementById('version-list').insertAdjacentHTML('afterbegin', createVersionCardHTML(newVersionData, true));
            }
            
            function createVersionCardHTML(v, isExpanded = false) {
                const expandedClass = isExpanded ? 'expanded' : '';
                return `
                <div class="card version-card ${expandedClass}">
                    <div class="collapsible-header ${expandedClass}">
                        <h2>版本: ${v.version} <span style="font-size: 0.8rem; color: var(--subtle-text-color); font-weight: 400;">(${v.releaseDate})</span></h2>
                        <span class="chevron">▶</span>
                    </div>
                    <div class="collapsible-content ${expandedClass}">
                       <div class="collapsible-content-inner">
                            <div class="form-group-column version-card-content">
                                <div style="display: flex; gap: 8px;">
                                    <div style="flex: 1;"><label>版本号</label><input type="text" class="styled-input" data-field="version" value="${v.version}"></div>
                                    <div style="flex: 1;"><label>发布日期</label><input type="text" class="styled-input" data-field="releaseDate" value="${v.releaseDate}"></div>
                                </div>
                                <label>优化功能</label><textarea class="styled-textarea" data-field="optimizedFunctions">${v.optimizedFunctions}</textarea>
                                <label>新增功能</label><textarea class="styled-textarea" data-field="newFunctions">${v.newFunctions}</textarea>
                                <label>下载地址</label><input type="text" class="styled-input" data-field="downloadUrl" value="${v.downloadUrl}">
                            </div>
                       </div>
                    </div>
                </div>`;
            }

            loadConfigBtn.addEventListener('click', loadConfig);
            saveButton.addEventListener('click', saveConfig);
            addVersionButton.addEventListener('click', addNewVersionCard);
        });
    </script>
</body>
</html>
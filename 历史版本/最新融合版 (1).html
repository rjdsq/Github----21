<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub文件管理器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<style>
/* 基础样式 */
body {
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
    background-color: #030712;
    color: #f3f4f6;
    min-height: 100vh;
    overflow-x: hidden;
}

/* 登录界面样式 */
#authScreen {
    height: 100vh;
    display: flex;
    flex-direction: column;
    padding: 1.5rem;
    justify-content: center;
    gap: 1.5rem;
}

.auth-header {
    text-align: center;
    margin-bottom: 2.5rem;
}

.auth-header i {
    font-size: 3rem;
    color: #9ca3af;
    margin-bottom: 1rem;
}

.auth-header h1 {
    font-size: 1.875rem;
    font-weight: bold;
}

.auth-form {
    box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3), -5px -5px 10px rgba(75, 85, 99, 0.1);
    background-color: #111827;
    border-radius: 0.75rem;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

#tokenInput {
    box-shadow: inset 3px 3px 6px rgba(0, 0, 0, 0.3), inset -3px -3px 6px rgba(75, 85, 99, 0.1);
    background-color: #030712;
    border-radius: 0.5rem;
    padding: 0.75rem;
    outline: none;
    color: #f3f4f6;
    border: none;
}

#authBtn {
    box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3), -5px -5px 10px rgba(75, 85, 99, 0.1);
    background-color: #6b7280;
    border-radius: 0.5rem;
    padding: 0.75rem;
    font-weight: 500;
    border: none;
    color: white;
    cursor: pointer;
    transition: background-color 0.2s;
}

#authBtn:hover {
    background-color: #4b5563;
}

/* 主应用界面样式 */
#app {
    display: none;
    flex-direction: column;
    height: 100vh;
}

header {
    background-color: rgba(17, 24, 39, 0.8);
    backdrop-filter: blur(10px);
    box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3), -5px -5px 10px rgba(75, 85, 99, 0.1);
    padding: 0.5rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.header-left i {
    color: #9ca3af;
}

#currentRepo {
    font-weight: bold;
    font-size: 0.875rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

#mainMenuBtn {
    padding: 0.5rem;
    border-radius: 9999px;
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    transition: background-color 0.2s;
}

#mainMenuBtn:hover {
    background-color: rgba(107, 114, 128, 0.2);
}

/* 路径导航 */
#pathNavContainer {
    background-color: rgba(17, 24, 39, 0.8);
    backdrop-filter: blur(10px);
    padding: 0.25rem 0;
    overflow-x: auto;
    white-space: nowrap;
    display: none;
}

#pathNav {
    display: flex;
    gap: 0.25rem;
    font-size: 0.75rem;
}

#pathNav span {
    cursor: pointer;
}

#pathNav span:hover {
    color: #d1d5db;
}

/* 主内容区 */
main {
    flex: 1;
    overflow-y: auto;
}

#repoList, #fileList {
    padding: 0.75rem;
}

.loading-spinner {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100%;
    padding: 2.5rem 0;
}

.spinner {
    animation: spin 1s linear infinite;
    border-radius: 9999px;
    height: 2.5rem;
    width: 2.5rem;
    border-top: 2px solid #9ca3af;
    border-bottom: 2px solid #9ca3af;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

/* 底部操作栏 */
footer {
    background-color: rgba(17, 24, 39, 0.8);
    backdrop-filter: blur(10px);
    box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3), -5px -5px 10px rgba(75, 85, 99, 0.1);
    padding: 1.25rem 1rem;
    display: flex;
    justify-content: space-around;
}

footer button {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 0.5rem;
    width: 25%;
    background: none;
    border: none;
    color: white;
    cursor: pointer;
}

footer button i {
    font-size: 1.25rem;
}

/* 编辑文件模态框 */
#editModal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 50;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 1.75rem;
}

.modal-content {
    box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3), -5px -5px 10px rgba(75, 85, 99, 0.1);
    background-color: #111827;
    border-radius: 0.75rem;
    display: flex;
    flex-direction: column;
    width: 100%;
    max-width: 80rem;
    min-height: 70vh;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-left: 0.75rem;
    height: 1.5rem;
}

.modal-header h5 {
    font-size: 0.75rem;
    font-weight: bold;
}

#closeEditModal {
    padding: 0.5rem;
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    border-radius: 9999px;
}

#closeEditModal:hover {
    background-color: rgba(107, 114, 128, 0.2);
}

#editStatus {
    padding: 0.75rem;
    margin: 0.1rem 0;
    border-radius: 0.375rem;
}

.editor-container {
    flex: 1;
    overflow: hidden;
    position: relative;
}

#editorOverlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: rgba(17, 24, 39, 0.7);
    z-index: 10;
    border-radius: 0.375rem;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
}

#editorOverlay.show {
    opacity: 1;
    pointer-events: auto;
}

#saveNotification {
    position: absolute;
    top: 2.5rem;
    right: 2.5rem;
    background-color: rgba(15, 81, 50, 0.9);
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 14px;
    z-index: 5;
    opacity: 0;
    transform: translateY(-20px);
    transition: opacity 0.3s ease, transform 0.3s ease;
}

#saveNotification.show {
    opacity: 1;
    transform: translateY(0);
}

#fileContent {
    box-shadow: inset 3px 3px 6px rgba(0, 0, 0, 0.3), inset -3px -3px 6px rgba(75, 85, 99, 0.1);
    background-color: #030712;
    width: 100%;
    height: 100%;
    padding: 0.75rem;
    outline: none;
    min-height: 70vh;
    font-size: 0.75rem;
    border-top: 1px solid #374151;
    border-bottom: 1px solid #374151;
    color: white;
    resize: none;
    border: none;
}

.modal-footer {
    display: flex;
    gap: 0.75rem;
    padding: 0.75rem;
}

.modal-footer button {
    flex: 1;
    padding: 0.75rem;
    border-radius: 0.5rem;
    border: none;
    cursor: pointer;
}

#cancelEdit {
    background-color: #111827;
    color: white;
}

#saveEdit {
    background-color: #111827;
    color: white;
}

/* 文件上传面板 */
#uploadPanel {
    position: fixed;
    bottom: 5rem;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(17, 24, 39, 0.8);
    backdrop-filter: blur(10px);
    box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3), -5px -5px 10px rgba(75, 85, 99, 0.1);
    border-radius: 0.5rem;
    padding: 1rem;
    width: 91.666667%;
    max-width: 28rem;
    display: none;
    z-index: 40;
}

#uploadPanel h3 {
    font-weight: 500;
    margin-bottom: 0.75rem;
}

#uploadItems {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    max-height: 10rem;
    overflow-y: auto;
}

/* 通用模态框 */
#modalOverlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 50;
    display: none;
    align-items: center;
    justify-content: center;
}

#modalOverlay .modal-content {
    box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3), -5px -5px 10px rgba(75, 85, 99, 0.1);
    background-color: #111827;
    border-radius: 0.75rem;
    padding: 1.25rem;
    width: 91.666667%;
    max-width: 28rem;
}

/* 右键菜单 */
#contextMenu {
    position: fixed;
    background-color: rgba(17, 24, 39, 0.8);
    backdrop-filter: blur(10px);
    box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3), -5px -5px 10px rgba(75, 85, 99, 0.1);
    border-radius: 0.5rem;
    z-index: 50;
    display: none;
    width: 12rem;
}

#contextMenuItems {
    padding: 0.25rem 0;
}

#contextMenuItems a {
    display: block;
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    color: white;
    text-decoration: none;
}

#contextMenuItems a:hover {
    background-color: rgba(107, 114, 128, 0.2);
}

#contextMenuItems a i {
    margin-right: 0.5rem;
}

/* Toast提示 */
#toast {
    position: fixed;
    bottom: 5rem;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(17, 24, 39, 0.8);
    backdrop-filter: blur(10px);
    box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3), -5px -5px 10px rgba(75, 85, 99, 0.1);
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    display: none;
    z-index: 30;
}

/* 隐藏的文件上传input */
.hidden {
    display: none;
}

/* 主菜单弹出框 */
#mainMenuPopup {
    position: fixed;
    top: 4rem;
    right: 1rem;
    z-index: 50;
    background-color: #111827;
    border-radius: 0.5rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    border: 1px solid #374151;
    display: none;
    min-width: 5rem;
    text-align: center;
    font-size: 0.75rem;
}

#mainMenuPopup button {
    width: 100%;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: none;
    border: none;
    color: white;
    text-align: left;
    cursor: pointer;
}

#mainMenuPopup button:hover {
    background-color: #222;
}

/* 文件列表项样式 */
.file-item {
    box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3), -5px -5px 10px rgba(75, 85, 99, 0.1);
    background-color: #111827;
    border-radius: 0.5rem;
    padding: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: background-color 0.2s;
}

.file-item:hover {
    background-color: rgba(107, 114, 128, 0.1);
}

.file-icon {
    width: 2.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.5rem;
    background-color: rgba(17, 24, 39, 0.5);
}

.file-info {
    flex: 1;
    min-width: 0;
}

.file-name {
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.file-meta {
    font-size: 0.75rem;
    color: #9ca3af;
    margin-top: 0.25rem;
}

/* 多选操作栏 */
#multiActionBar {
    width: 100%;
    position: fixed;
    bottom: 4.5rem;
    padding: 0;
    left: 0;
    right: 0;
    display: flex;
    align-items: center;
    justify-content: space-around;
    background-color: rgba(17, 24, 39, 0.8);
    backdrop-filter: blur(10px);
    padding: 0.5rem 0;
    z-index: 20;
}

#multiActionBar button {
    width: 14%;
    height: 2.5rem;
    margin: 0.5rem;
    border: none;
    border-radius: 0.5rem;
    background: linear-gradient(90deg, #0ea5e9, #6366f1);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}

#selectedCount {
    color: white;
    font-weight: bold;
    font-size: 0.875rem;
    margin: 0 0.5rem;
    text-align: right;
    margin-right: 15%;
}

/* 多选复选框 */
.multi-select-checkbox {
    margin-right: 0.5rem;
}

/* 空状态 */
.empty-state {
    text-align: center;
    padding: 2.5rem 0;
    color: #9ca3af;
}

.empty-state i {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
}

/* 媒体预览 */
#mediaPreview {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.9);
    z-index: 60;
    display: none;
    align-items: center;
    justify-content: center;
}

#mediaPreview img, #mediaPreview video {
    max-width: 80%;
    max-height: 80vh;
    object-fit: contain;
}

/* 音频播放器 */
.audio-player {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background-color: rgba(17, 24, 39, 0.8);
    padding: 1rem;
    z-index: 40;
    display: none;
}

/* 响应式调整 */
@media (max-width: 640px) {
    footer button {
        width: 20%;
    }
    
    #multiActionBar button {
        width: 18%;
    }
}
</style>

<body>
    <!-- 登录界面 -->
    <div id="authScreen">
        <div class="auth-header">
            <i class="fa fa-github"></i>
            <h1>GitHub文件管理器</h1>
        </div>
        <div class="auth-form">
            <input type="text" id="tokenInput" placeholder="输入GitHub访问令牌">
            <button id="authBtn">登录</button>
        </div>
    </div>

    <!-- 主应用界面 -->
    <div id="app">
        <header>
            <div class="header-left">
                <i class="fa fa-github"></i>
                <h1 id="currentRepo">选择仓库</h1>
            </div>
            <div>
                <button id="mainMenuBtn" title="菜单">
                    <i class="fa fa-github"></i>
                </button>
            </div>
        </header>

        <!-- 路径导航 -->
        <div id="pathNavContainer">
            <div id="pathNav"></div>
        </div>

        <!-- 主内容区 -->
        <main>
            <div id="repoList">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
            </div>
            <div id="fileList">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
            </div>
        </main>

        <!-- 底部操作栏 -->
        <footer>
            <button id="backBtn" title="返回上级">
                <i class="fa fa-arrow-up"></i>
            </button>
            <button id="newFolderBtn" title="新建文件夹">
                <i class="fa fa-folder"></i>
            </button>
            <button id="newFileBtn" title="新建文件">
                <i class="fa fa-file-o"></i>
            </button>
            <button id="uploadBtn" title="上传文件">
                <i class="fa fa-upload"></i>
            </button>
        </footer>

        <!-- 编辑文件模态框 -->
        <div id="editModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="editFileName">编辑文件</h5>
                    <button id="closeEditModal">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <div id="editStatus"></div>
                <div class="editor-container">
                    <div id="editorOverlay">
                        <div class="spinner-container">
                            <i class="fa fa-spinner fa-spin"></i>
                        </div>
                    </div>
                    <div id="saveNotification">
                        <i class="fa fa-check"></i> 保存成功
                    </div>
                    <textarea id="fileContent"></textarea>
                </div>
                <div class="modal-footer">
                    <button id="cancelEdit">取消</button>
                    <button id="saveEdit">保存修改</button>
                </div>
            </div>
        </div>

        <!-- 文件上传面板 -->
        <div id="uploadPanel">
            <h3>文件上传中</h3>
            <div id="uploadItems"></div>
        </div>

        <!-- 通用模态框 -->
        <div id="modalOverlay">
            <div class="modal-content">
                <div id="modalContent"></div>
            </div>
        </div>

        <!-- 右键菜单 -->
        <div id="contextMenu">
            <div id="contextMenuItems"></div>
        </div>

        <!-- Toast提示 -->
        <div id="toast">
            <span id="toastMessage"></span>
        </div>

        <!-- 隐藏的文件上传input -->
        <input type="file" id="fileUploadInput" multiple class="hidden">

        <!-- 主菜单弹出框 -->
        <div id="mainMenuPopup">
            <button id="menuLogout">
                <i class="fa fa-sign-out"></i> 退出登录
            </button>
            <button id="menuRepoList">
                <i class="fa fa-list"></i> 仓库列表
            </button>
            <button id="menuRefresh">
                <i class="fa fa-refresh"></i> 刷新页面
            </button>
        </div>
    </div>

    <script>
    // 状态管理
const state = {
    token: localStorage.getItem('gh_token') || null,
    currentRepo: null,
    currentPath: '',
    files: [],
    repos: [],
    selectedFile: null,
    selectedRepo: null,
    uploadQueue: [],
    editingFile: null,
    fileSha: '',
    originalContent: '',
    proxyUrl: 'https://gh-proxy.com/',
    navHistory: ['root']
};

// DOM元素引用
const el = {
    authScreen: document.getElementById('authScreen'),
    app: document.getElementById('app'),
    tokenInput: document.getElementById('tokenInput'),
    authBtn: document.getElementById('authBtn'),
    fileList: document.getElementById('fileList'),
    repoList: document.getElementById('repoList'),
    pathNav: document.getElementById('pathNav'),
    pathNavContainer: document.getElementById('pathNavContainer'),
    currentRepo: document.getElementById('currentRepo'),
    backBtn: document.getElementById('backBtn'),
    newFolderBtn: document.getElementById('newFolderBtn'),
    uploadBtn: document.getElementById('uploadBtn'),
    modalOverlay: document.getElementById('modalOverlay'),
    modalContent: document.getElementById('modalContent'),
    contextMenu: document.getElementById('contextMenu'),
    contextMenuItems: document.getElementById('contextMenuItems'),
    toast: document.getElementById('toast'),
    toastMessage: document.getElementById('toastMessage'),
    uploadPanel: document.getElementById('uploadPanel'),
    uploadItems: document.getElementById('uploadItems'),
    editModal: document.getElementById('editModal'),
    editFileName: document.getElementById('editFileName'),
    fileContent: document.getElementById('fileContent'),
    closeEditModal: document.getElementById('closeEditModal'),
    cancelEdit: document.getElementById('cancelEdit'),
    saveEdit: document.getElementById('saveEdit'),
    editStatus: document.getElementById('editStatus'),
    editorOverlay: document.getElementById('editorOverlay'),
    saveNotification: document.getElementById('saveNotification'),
    fileUploadInput: document.getElementById('fileUploadInput'),
    mainMenuPopup: document.getElementById('mainMenuPopup'),
    menuLogout: document.getElementById('menuLogout'),
    menuRepoList: document.getElementById('menuRepoList'),
    menuRefresh: document.getElementById('menuRefresh'),
    newFileBtn: document.getElementById('newFileBtn'),
    mainMenuBtn: document.getElementById('mainMenuBtn')
};

// 工具函数
function getFileIcon(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    const icons = {
        js: 'fa-code',
        html: 'fa-html5',
        css: 'fa-css3',
        json: 'fa-file-code-o',
        md: 'fa-file-text-o',
        png: 'fa-file-image-o',
        jpg: 'fa-file-image-o',
        jpeg: 'fa-file-image-o',
        gif: 'fa-file-image-o',
        pdf: 'fa-file-pdf-o',
        zip: 'fa-file-zip-o',
        git: 'fa-git'
    };
    return icons[ext] || 'fa-file-o';
}

function formatSize(bytes) {
    if (!bytes) return '0 B';
    const k = 1024, sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function formatRelativeTime(date) {
    const diffMs = new Date() - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);
    if (diffMins < 1) return '刚刚';
    if (diffMins < 60) return `${diffMins}分钟前`;
    if (diffHours < 24) return `${diffHours}小时前`;
    if (diffDays < 30) return `${diffDays}天前`;
    return date.toLocaleDateString();
}

function escapeHtml(unsafe) {
    return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;")
        .replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
}

// 视图控制
function toggleView(showRepoList) {
    if (showRepoList) {
        el.repoList.classList.remove('hidden');
        el.fileList.classList.add('hidden');
        el.pathNavContainer.classList.add('hidden');
        el.currentRepo.textContent = '选择仓库';
    } else {
        el.repoList.classList.add('hidden');
        el.fileList.classList.remove('hidden');
        el.pathNavContainer.classList.remove('hidden');
    }
}

function showAuth() {
    el.authScreen.classList.remove('hidden');
    el.app.classList.add('hidden');
}

function showApp() {
    el.authScreen.classList.add('hidden');
    el.app.classList.remove('hidden');
}

function showModal(content) {
    el.modalContent.innerHTML = content;
    el.modalOverlay.classList.remove('hidden');
    el.modalOverlay.classList.add('flex');
}

function hideModal() {
    el.modalOverlay.classList.add('hidden');
    el.modalOverlay.classList.remove('flex');
}

function showToast(message) {
    el.toastMessage.textContent = message;
    el.toast.classList.remove('hidden');
    setTimeout(() => el.toast.classList.add('hidden'), 3000);
}

function showSaveNotification() {
    el.saveNotification.classList.add('show');
    setTimeout(() => el.saveNotification.classList.remove('show'), 3000);
}

// 仓库管理
async function fetchRepos() {
    try {
        state.repos = [];
        el.repoList.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
        const res = await fetch('https://api.github.com/user/repos?timestamp=' + Date.now(), {
            headers: { Authorization: `token ${state.token}`, 'User-Agent': 'Mozilla/5.0' }
        });
        if (!res.ok) throw new Error('获取仓库失败');
        state.repos = await res.json();
        renderRepoList();
        showRepoListView();
    } catch (err) {
        showToast('加载仓库失败');
        console.error(err);
    }
}

function renderRepoList() {
    el.repoList.innerHTML = state.repos.length === 0
        ? '<div class="empty-state"><i class="fa fa-github"></i><p>没有找到仓库</p></div>'
        : '';
    
    state.repos.forEach(repo => {
        const item = document.createElement('div');
        item.className = 'file-item';
        item.innerHTML = `
            <div class="file-icon"><i class="fa fa-github"></i></div>
            <div class="file-info">
                <p class="file-name">${repo.name}</p>
                <p class="file-meta">
                    ${repo.private ? '私有仓库' : '公开仓库'}
                    ${(repo.size || repo.updated_at) ? ' · ' : ''}
                    ${repo.size ? formatSize(repo.size * 1024) : ''}
                    ${repo.size && repo.updated_at ? ' · ' : ''}
                    ${formatRelativeTime(new Date(repo.updated_at))}
                </p>
                <p class="file-meta">${repo.description || ''}</p>
            </div>
        `;
        
        item.addEventListener('click', () => {
            state.currentRepo = repo.full_name;
            state.currentPath = '';
            el.currentRepo.textContent = repo.name;
            renderPathNav();
            fetchFiles();
            toggleView(false);
        });
        
        // 长按事件
        let pressTimer;
        ['touchstart', 'mousedown'].forEach(event => {
            item.addEventListener(event, (e) => {
                pressTimer = setTimeout(() => { 
                    e.preventDefault(); 
                    state.selectedRepo = repo; 
                    showRepoContextMenu(e, repo); 
                }, 500);
            });
        });
        
        ['touchend', 'touchcancel', 'mouseup', 'mouseleave'].forEach(event => {
            item.addEventListener(event, () => clearTimeout(pressTimer));
        });
        
        el.repoList.appendChild(item);
    });
}

function showRepoListView() {
    el.repoList.classList.remove('hidden');
    el.fileList.classList.add('hidden');
    el.pathNavContainer.classList.add('hidden');
    el.currentRepo.textContent = '选择仓库';
    state.currentRepo = null;
    state.currentPath = '';
}

// 文件管理
async function fetchFiles() {
    if (!state.currentRepo) return;
    el.fileList.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
    try {
        const timestamp = Date.now();
        const res = await fetch(`https://api.github.com/repos/${state.currentRepo}/contents/${state.currentPath}?t=${timestamp}`, {
            headers: { Authorization: `token ${state.token}`, 'User-Agent': 'Mozilla/5.0' },
            cache: 'no-store'
        });
        if (!res.ok) {
            if (res.status === 404) { state.files = []; renderFileList(); return; }
            throw new Error('加载文件失败');
        }
        const data = await res.json();
        if (data.message) throw new Error(data.message);
        state.files = Array.isArray(data) ? data : [];
        state.files.sort((a, b) =>
            a.type === 'dir' && b.type !== 'dir' ? -1 :
            a.type !== 'dir' && b.type === 'dir' ? 1 :
            a.name.localeCompare(b.name)
        );
        
        // 获取每个文件的最后修改时间
        await Promise.all(state.files.map(async (file) => {
            try {
                const [owner, repo] = state.currentRepo.split('/');
                const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/commits?path=${file.path}&per_page=1`, {
                    headers: { Authorization: `token ${state.token}`, 'User-Agent': 'Mozilla/5.0' }
                });
                const commits = await res.json();
                if (Array.isArray(commits) && commits.length > 0) {
                    file.last_modified = commits[0].commit.committer.date;
                }
            } catch (e) {
                file.last_modified = null;
            }
        }));
        
        renderFileList();
    } catch (err) {
        if (err.message.includes('404')) { state.files = []; renderFileList(); return; }
        showToast('加载文件失败: ' + err.message);
        console.error(err);
    }
}

function renderFileList() {
    el.fileList.innerHTML = state.files.length === 0
        ? '<div class="empty-state"><i class="fa fa-github"></i><p>仓库为空</p></div>'
        : '';
    
    state.files.forEach((file, index) => {
        const isDir = file.type === 'dir';
        const icon = isDir ? 'fa-folder' : getFileIcon(file.name);
        const item = document.createElement('div');
        item.className = 'file-item';
        item.innerHTML = `
            <div class="file-icon"><i class="fa ${icon}"></i></div>
            <div class="file-info">
                <p class="file-name">${file.name}</p>
                <p class="file-meta">
                    ${isDir ? '文件夹' : formatSize(file.size)} · 
                    ${file.last_modified ? formatRelativeTime(new Date(file.last_modified)) : '加载中'}
                </p>
            </div>
        `;
        
        item.addEventListener('click', (e) => {
            if (e.imagePreviewAction) return;
            isDir ? navigateToDir(file.name) : editFile(file);
        });
        
        // 长按事件
        let pressTimer;
        ['touchstart', 'mousedown'].forEach(event => {
            item.addEventListener(event, (e) => {
                pressTimer = setTimeout(() => { 
                    e.preventDefault(); 
                    showContextMenu(e, file); 
                }, 700);
            });
        });
        
        ['touchend', 'touchcancel', 'mouseup', 'mouseleave'].forEach(event => {
            item.addEventListener(event, () => clearTimeout(pressTimer));
        });
        
        el.fileList.appendChild(item);
    });
}

// 路径导航
function renderPathNav() {
    el.pathNav.innerHTML = '';
    const parts = state.currentPath.split('/').filter(p => p);
    let currentPath = '';
    addPathItem('/', '');
    parts.forEach((part) => {
        currentPath += part + '/';
        addPathItem(part, currentPath);
    });
}

function addPathItem(name, path) {
    const item = document.createElement('span');
    item.className = 'path-item';
    item.textContent = name;
    item.dataset.path = path;
    item.addEventListener('click', () => {
        el.fileList.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
        navigateToPath(path);
    });
    el.pathNav.appendChild(item);
    if (name !== '/') el.pathNav.appendChild(document.createTextNode(' / '));
}

function navigateToDir(dirName) {
    const newPath = state.currentPath ? `${state.currentPath}${dirName}/` : `${dirName}/`;
    state.navHistory.push(newPath);
    state.currentPath = newPath;
    renderPathNav();
    fetchFiles();
}

function navigateToPath(path) {
    state.navHistory.push(path);
    state.currentPath = path;
    renderPathNav();
    fetchFiles();
}

// 事件监听
function setupEventListeners() {
    // 认证相关
    el.authBtn.addEventListener('click', () => {
        const token = el.tokenInput.value.trim();
        if (token) {
            localStorage.setItem('gh_token', token);
            state.token = token;
            showApp();
            fetchRepos();
        } else {
            showToast('请输入令牌');
        }
    });
    
    // 主菜单按钮
    el.mainMenuBtn.onclick = (e) => {
        e.stopPropagation();
        hideContextMenu();
        el.mainMenuPopup.classList.toggle('hidden');
    };
    
    // 点击别处关闭主菜单
    document.addEventListener('click', function(e) {
        if (!el.mainMenuPopup.classList.contains('hidden')) {
            if (!el.mainMenuPopup.contains(e.target) && e.target !== el.mainMenuBtn) {
                el.mainMenuPopup.classList.add('hidden');
            }
        }
    });
    
    // 菜单项事件
    el.menuRepoList.onclick = () => {
        el.mainMenuPopup.classList.add('hidden');
        showRepoListView();
    };
    
    el.menuRefresh.onclick = () => {
        el.mainMenuPopup.classList.add('hidden');
        if (!state.currentRepo) fetchRepos();
        else fetchFiles();
    };
    
    el.menuLogout.onclick = () => {
        el.mainMenuPopup.classList.add('hidden');
        localStorage.removeItem('gh_token');
        state.token = null;
        state.repos = [];
        state.currentRepo = null;
        showAuth();
    };
    
    // 编辑相关
    el.saveEdit.addEventListener('click', saveEditedFile);
    
    // 点击或滑动任意位置关闭上下文菜单
    document.addEventListener('click', hideContextMenu);
    document.addEventListener('touchstart', (e) => {
        if (!el.contextMenu.contains(e.target)) hideContextMenu();
    });
    
    document.addEventListener('touchmove', (e) => {
        if (!el.contextMenu.contains(e.target)) hideContextMenu();
    });
    
    // 点击空白处关闭模态框
    el.modalOverlay.addEventListener('click', (e) => {
        if (e.target === el.modalOverlay) hideModal();
    });
    
    // 返回按钮
    el.backBtn.onclick = goUp;
    
    // 新建文件夹
    el.newFolderBtn.onclick = createFolder;
    
    // 新建文件
    el.newFileBtn.onclick = createFile;
    
    // 上传文件
    el.uploadBtn.onclick = handleUploadClick;
    el.fileUploadInput.addEventListener('change', handleFilesSelected);
}

// 编辑器功能
function showEditModal() {
    el.editModal.classList.remove('hidden');
    el.editModal.classList.add('flex');
    el.editorOverlay.classList.add('show');
    setTimeout(adjustEditorDimensions, 10);
    
    // 重新绑定事件
    el.closeEditModal.onclick = hideEditModal;
    el.cancelEdit.onclick = hideEditModal;
}

function hideEditModal() {
    el.editModal.classList.add('hidden');
    el.editModal.classList.remove('flex');
    state.editingFile = state.fileSha = state.originalContent = '';
    el.saveEdit.className = 'save-btn';
}

function showEditStatus(text, type) {
    el.editStatus.textContent = text;
    el.editStatus.className = `edit-status ${type}`;
}

function adjustEditorDimensions() {
    const viewportHeight = window.innerHeight;
    const targetEditorHeight = viewportHeight * 0.6;
    const modal = el.editModal.querySelector('.modal-content');
    const otherElementsHeight =
        modal.querySelector('.modal-header').offsetHeight +
        el.editStatus.offsetHeight +
        modal.querySelector('.modal-footer').offsetHeight + 30;
    modal.style.height = `${targetEditorHeight + otherElementsHeight}px`;
    el.fileContent.style.height = `${targetEditorHeight}px`;
    el.fileContent.focus();
}

async function editFile(file) {
    state.editingFile = file;
    el.editFileName.textContent = `${file.name}`;
    el.fileContent.value = '';
    showEditStatus('', '');
    showEditModal();
    
    try {
        const [owner, repo] = state.currentRepo.split('/');
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${file.path}`, {
            headers: { 'Authorization': `token ${state.token}`, 'User-Agent': 'Mozilla/5.0' }
        });
        
        if (!res.ok) {
            const err = await res.json();
            el.editorOverlay.classList.remove('show');
            showEditStatus(`加载失败：${err.message}`, 'error');
            return;
        }
        
        const data = await res.json();
        const content = decodeURIComponent(escape(atob(data.content)));
        el.fileContent.value = content;
        state.originalContent = content;
        state.fileSha = data.sha;
        el.editorOverlay.classList.remove('show');
        el.fileContent.addEventListener('input', checkContentChanges);
    } catch (e) {
        el.editorOverlay.classList.remove('show');
        showEditStatus(`错误：${e.message}`, 'error');
        console.error(e);
    }
}

function checkContentChanges() {
    const isModified = el.fileContent.value !== state.originalContent;
    el.saveEdit.className = isModified ? 'save-btn modified' : 'save-btn';
}

async function saveEditedFile() {
    if (!state.editingFile || !state.fileSha) return;
    const currentContent = el.fileContent.value;
    if (currentContent === state.originalContent) {
        showToast('未检测到修改');
        return;
    }
    
    el.editorOverlay.classList.add('show');
    
    try {
        const [owner, repo] = state.currentRepo.split('/');
        const encodedContent = btoa(unescape(encodeURIComponent(currentContent)));
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${state.editingFile.path}`, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${state.token}`,
                'Content-Type': 'application/json',
                'User-Agent': 'Mozilla/5.0'
            },
            body: JSON.stringify({
                message: `Update ${state.editingFile.name} via web editor`,
                content: encodedContent,
                sha: state.fileSha
            })
        });
        
        if (!res.ok) {
            const err = await res.json();
            el.editorOverlay.classList.remove('show');
            showEditStatus(`保存失败：${err.message}`, 'error');
            return;
        }
        
        const result = await res.json();
        state.fileSha = result.content.sha;
        state.originalContent = currentContent;
        el.editorOverlay.classList.remove('show');
        showToast('文件已保存');
        showSaveNotification();
        fetchFiles();
        el.saveEdit.className = 'save-btn';
    } catch (e) {
        el.editorOverlay.classList.remove('show');
        showEditStatus(`错误：${e.message}`, 'error');
        console.error(e);
    }
}

// 文件下载/复制/重命名/删除
async function downloadFile(item) {
    if (item.type === 'dir') return;
    
    try {
        showToast(`准备下载 ${item.name}`);
        const rawUrl = item.html_url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
        const url = `${state.proxyUrl}${rawUrl}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`下载失败 (${response.status})`);
        const blob = await response.blob();
        const objectUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = objectUrl;
        a.download = item.name;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(objectUrl);
        }, 500);
        showToast(`开始下载 ${item.name}`);
    } catch (e) {
        showToast(`下载出错: ${e.message}`);
        console.error(e);
    }
}

function copyLink(file) {
    const rawUrl = file.download_url || file.html_url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
    navigator.clipboard.writeText(rawUrl).then(() => {
        showToast('Raw 链接已复制');
    }).catch(e => {
        showToast('复制失败');
        console.error(e);
    });
}

function copyProxyLink(file) {
    if (!file.download_url) return showToast('无代理链接可用');
    const proxyUrl = `${state.proxyUrl}${file.download_url}`;
    navigator.clipboard.writeText(proxyUrl).then(() => {
        showToast('代理链接已复制');
    }).catch(e => {
        showToast('复制失败');
        console.error(e);
    });
}

// 上下文菜单
function positionContextMenu(e) {
    const rect = e.target.closest('.file-item').getBoundingClientRect();
    const menuWidth = 192, windowWidth = window.innerWidth, windowHeight = window.innerHeight;
    let leftPos = rect.right + menuWidth + 10 <= windowWidth ? rect.right + 10
        : rect.left - menuWidth - 10 >= 0 ? rect.left - menuWidth - 10
        : Math.max(10, Math.min(windowWidth - menuWidth - 10, (rect.left + rect.right - menuWidth) / 2));
    let topPos = rect.top;
    const estimatedMenuHeight = 40 * 8;
    if (topPos + estimatedMenuHeight > windowHeight) {
        topPos = Math.max(20, windowHeight - estimatedMenuHeight - 40);
    }
    return { top: topPos, left: leftPos };
}

function showContextMenu(e, file) {
    state.selectedFile = file;
    const position = positionContextMenu(e);
    const menu = el.contextMenu;
    menu.style.top = `${position.top}px`;
    menu.style.left = `${position.left}px`;
    menu.style.opacity = '0';
    menu.style.transform = 'scale(0.8)';
    menu.classList.remove('hidden');
    menu.style.display = 'block';
    
    let start = null, duration = 150;
    function animate(timestamp) {
        if (!start) start = timestamp;
        const progress = Math.min((timestamp - start) / duration, 1);
        menu.style.opacity = progress.toString();
        menu.style.transform = `scale(${0.8 + 0.2 * progress})`;
        if (progress < 1) requestAnimationFrame(animate);
    }
    requestAnimationFrame(animate);
    renderContextMenuItems(file);
}

function showRepoContextMenu(e, repo) {
    state.selectedRepo = repo;
    const position = positionContextMenu(e);
    const menu = el.contextMenu;
    menu.style.top = `${position.top}px`;
    menu.style.left = `${position.left}px`;
    menu.style.opacity = '0';
    menu.style.transform = 'scale(0.8)';
    menu.classList.remove('hidden');
    menu.style.display = 'block';
    
    let start = null, duration = 150;
    function animate(timestamp) {
        if (!start) start = timestamp;
        const progress = Math.min((timestamp - start) / duration, 1);
        menu.style.opacity = progress.toString();
        menu.style.transform = `scale(${0.8 + 0.2 * progress})`;
        if (progress < 1) requestAnimationFrame(animate);
    }
    requestAnimationFrame(animate);
    renderRepoContextMenuItems(repo);
}

function renderRepoContextMenuItems(repo) {
    el.contextMenuItems.innerHTML = '';
    [
        ['downloadRepo', 'fa-download', '下载ZIP (代理)'],
        ['renameRepo', 'fa-pencil', '重命名'],
        ['deleteRepo', 'fa-trash', '删除', 'text-red-400']
    ].forEach(([action, icon, text, className = '']) => {
        const item = document.createElement('a');
        item.className = `context-menu-item ${className}`;
        item.dataset.action = action;
        item.innerHTML = `<i class="fa ${icon} mr-2"></i>${text}`;
        item.addEventListener('click', () => {
            handleRepoContextMenuAction(action, state.selectedRepo);
            hideContextMenu();
        });
        el.contextMenuItems.appendChild(item);
    });
}

function renderContextMenuItems(file) {
    el.contextMenuItems.innerHTML = '';
    const isDir = file.type === 'dir';
    const items = isDir
        ? [
           ['rename', 'fa-pencil', '重命名'],
           ['delete', 'fa-trash', '删除', 'text-red-400']]
        : [['download', 'fa-download', '下载'],
           ['copyLink', 'fa-link', '复制链接'],
           ['copyProxy', 'fa-share', '代理链接'],
           ['edit', 'fa-edit', '编辑'],
           ['rename', 'fa-pencil', '重命名'],
           ['delete', 'fa-trash', '删除', 'text-red-400']];
    
    items.forEach(([action, icon, text, className = '']) => {
        const item = document.createElement('a');
        item.className = `context-menu-item ${className}`;
        item.dataset.action = action;
        item.innerHTML = `<i class="fa ${icon} mr-2"></i>${text}`;
        item.addEventListener('click', () => {
            handleContextMenuAction(action, state.selectedFile);
            hideContextMenu();
        });
        el.contextMenuItems.appendChild(item);
    });
}

const hideContextMenu = () => {
    const menu = el.contextMenu;
    if (menu.classList.contains('hidden') && menu.style.display === 'none') return;
    
    let start = null, duration = 150;
    function animate(timestamp) {
        if (!start) start = timestamp;
        const progress = Math.min((timestamp - start) / duration, 1);
        menu.style.opacity = (1 - progress).toString();
        menu.style.transform = `scale(${1 - 0.2 * progress})`;
        if (progress < 1) requestAnimationFrame(animate);
        else {
            menu.classList.add('hidden');
            menu.style.display = 'none';
            state.selectedFile = null;
            state.selectedRepo = null;
        }
    }
    requestAnimationFrame(animate);
};

function handleContextMenuAction(action, file) {
    switch (action) {
        case 'download': downloadFile(file); break;
        case 'copyLink': copyLink(file); break;
        case 'copyProxy': copyProxyLink(file); break;
        case 'edit': editFile(file); break;
        case 'rename': renameItem(file); break;
        case 'delete': deleteItem(file); break;
    }
}

function handleRepoContextMenuAction(action, repo) {
    switch (action) {
        case 'downloadRepo': downloadRepoAsZip(repo); break;
        case 'renameRepo': renameRepo(repo); break;
        case 'deleteRepo': deleteRepo(repo); break;
    }
}

function downloadRepoAsZip(repo) {
    const zipUrl = `${state.proxyUrl}https://github.com/${repo.full_name}/archive/refs/heads/${repo.default_branch || 'main'}.zip`;
    const a = document.createElement('a');
    a.href = zipUrl;
    a.download = `${repo.name}.zip`;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    setTimeout(() => document.body.removeChild(a), 500);
    showToast(`正在下载 ${repo.name}.zip`);
}

// 上传功能
function handleUploadClick() {
    if (!state || !state.currentRepo) {
        showToast('请先选择仓库');
        return;
    }
    el.fileUploadInput.value = '';
    el.fileUploadInput.click();
}

function handleFilesSelected(e) {
    const files = Array.from(e.target.files || []);
    if (files.length === 0) return;
    el.uploadPanel.classList.remove('hidden');
    el.uploadItems.innerHTML = '';
    
    files.forEach((file, index) => {
        const uploadItem = document.createElement('div');
        uploadItem.className = 'upload-item';
        uploadItem.innerHTML = `
            <div class="upload-info">
                <span class="upload-name">${file.name}</span>
                <span class="upload-size">${formatSize(file.size)}</span>
            </div>
            <div class="upload-progress-container">
                <div class="upload-progress" data-index="${index}"></div>
            </div>
            <div class="upload-status" data-index="${index}">等待上传...</div>
        `;
        el.uploadItems.appendChild(uploadItem);
    });
    
    uploadFilesInSequence(files, 0);
    e.target.value = '';
}

function uploadFilesInSequence(files, index) {
    if (index >= files.length) {
        setTimeout(() => {
            el.uploadPanel.classList.add('hidden');
            fetchFiles();
        }, 2000);
        return;
    }
    
    const file = files[index];
    const statusElement = document.querySelector(`.upload-status[data-index="${index}"]`);
    if (statusElement) statusElement.textContent = '准备上传...';
    
    uploadSingleFile(file, index)
        .then(() => uploadFilesInSequence(files, index + 1))
        .catch(() => uploadFilesInSequence(files, index + 1));
}

async function uploadSingleFile(file, index) {
    return new Promise((resolve, reject) => {
        const progressBar = document.querySelector(`.upload-progress[data-index="${index}"]`);
        const statusElement = document.querySelector(`.upload-status[data-index="${index}"]`);
        
        if (progressBar) progressBar.style.width = '5%';
        if (statusElement) statusElement.textContent = '正在处理文件...';
        
        const reader = new FileReader();
        reader.readAsArrayBuffer(file);
        
        reader.onload = async (e) => {
            try {
                if (statusElement) statusElement.textContent = '正在编码内容...';
                const base64String = arrayBufferToBase64(e.target.result);
                if (progressBar) progressBar.style.width = '30%';
                
                if (!state || !state.currentRepo) throw new Error('未选择仓库');
                const fileName = file.name;
                const filePath = state.currentPath ? `${state.currentPath}${fileName}` : fileName;
                const [owner, repo] = state.currentRepo.split('/');
                
                if (statusElement) statusElement.textContent = '正在上传...';
                
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${state.token}`,
                        'Content-Type': 'application/json',
                        'User-Agent': 'Mozilla/5.0'
                    },
                    body: JSON.stringify({
                        message: `Upload ${fileName}`,
                        content: base64String
                    }),
                    signal: AbortSignal.timeout(60000)
                });
                
                if (progressBar) progressBar.style.width = '100%';
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `上传失败: HTTP ${response.status}`);
                }
                
                if (statusElement) {
                    statusElement.textContent = '上传成功';
                    statusElement.className = 'upload-status success';
                }
                
                showToast(`文件 "${fileName}" 上传成功`);
                resolve();
            } catch (error) {
                if (statusElement) {
                    statusElement.textContent = `失败: ${error.message.substring(0, 20)}...`;
                    statusElement.className = 'upload-status error';
                }
                showToast(`文件 "${file.name}" 上传失败`);
                reject(error);
            }
        };
        
        reader.onerror = () => {
            if (statusElement) {
                statusElement.textContent = '文件读取失败';
                statusElement.className = 'upload-status error';
            }
            showToast(`无法读取文件: ${file.name}`);
            reject(new Error('文件读取失败'));
        };
    });
}

function arrayBufferToBase64(buffer) {
    let binary = '';
    const bytes = new Uint8Array(buffer);
    const len = bytes.byteLength;
    for (let i = 0; i < len; i++) {
        binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary);
}

// 新建文件夹
function createFolder() {
    const inRepo = !!state.currentRepo;
    showModal(`
        <div class="modal-form">
            <h3>${inRepo ? '新建文件夹' : '新建仓库'}</h3>
            <input id="newName" placeholder="${inRepo ? '输入文件夹名称' : '输入英文仓库名称'}">
            ${!inRepo ? `
                <textarea id="repoDesc" placeholder="输入仓库描述"></textarea>
                <div class="checkbox-container">
                    <input type="checkbox" id="isPublic" checked>
                    <label for="isPublic">公开仓库</label>
                </div>
            ` : ''}
            <div class="modal-buttons">
                <button id="cancelCreate">取消</button>
                <button id="confirmCreate" disabled>确认</button>
            </div>
        </div>
    `);
    
    const nameInput = document.getElementById('newName');
    const confirmBtn = document.getElementById('confirmCreate');
    const descInput = !inRepo ? document.getElementById('repoDesc') : null;
    const publicCheckbox = !inRepo ? document.getElementById('isPublic') : null;
    
    const updateButtonState = () => {
        const name = nameInput.value.trim();
        const nameValid = name !== '';
        confirmBtn.disabled = !nameValid;
        confirmBtn.className = nameValid ? 'primary' : 'disabled';
    };
    
    nameInput.oninput = updateButtonState;
    if (!inRepo) descInput.oninput = updateButtonState;
    
    confirmBtn.onclick = async () => {
        const name = nameInput.value.trim();
        if (!name) return;
        
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '创建中 <i class="fa fa-spinner fa-spin"></i>';
        
        try {
            if (inRepo) {
                const [owner, repo] = state.currentRepo.split('/');
                const path = state.currentPath ? `${state.currentPath}/${name}` : name;
                await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}/.gitkeep`, {
                    method: 'PUT',
                    headers: { Authorization: `token ${state.token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: `create folder ${name}`, content: '' })
                });
                showToast(`已创建文件夹: ${name}`);
                hideModal();
                fetchFiles();
            } else {
                const description = descInput.value.trim();
                const isPublic = publicCheckbox.checked;
                
                const res = await fetch(`https://api.github.com/user/repos`, {
                    method: 'POST',
                    headers: { Authorization: `token ${state.token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        name,
                        description: description,
                        private: !isPublic
                    })
                });

                if (!res.ok) throw new Error('创建仓库失败');
                showToast(`已创建仓库: ${name}`);
                hideModal();
                fetchRepos();
            }
        } catch (e) {
            showToast(`失败: ${e.message}`);
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '创建';
        }
    };
    
    document.getElementById('cancelCreate').onclick = hideModal;
}

// 新建文件
function createFile() {
    if (!state.currentRepo) {
        showToast('请先选择仓库');
        return;
    }
    
    showModal(`
        <div class="modal-form">
            <h3>新建文件</h3>
            <input id="newFileName" placeholder="输入文件名，如 example.txt">
            <textarea id="newFileContent" placeholder="文件内容（可选）"></textarea>
            <div class="modal-buttons">
                <button id="cancelCreateFile">取消</button>
                <button id="confirmCreateFile" disabled>确认</button>
            </div>
        </div>
    `);
    
    const nameInput = document.getElementById('newFileName');
    const contentInput = document.getElementById('newFileContent');
    const confirmBtn = document.getElementById('confirmCreateFile');
    
    nameInput.oninput = () => {
        const name = nameInput.value.trim();
        const valid = !!name && !name.endsWith('/');
        confirmBtn.disabled = !valid;
        confirmBtn.className = valid ? 'primary' : 'disabled';
    };
    
    confirmBtn.onclick = async () => {
        const name = nameInput.value.trim();
        const content = contentInput.value;
        if (!name) return;
        
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '创建中 <i class="fa fa-spinner fa-spin"></i>';
        
        try {
            const [owner, repo] = state.currentRepo.split('/');
            const path = state.currentPath ? `${state.currentPath}${name}` : name;
            const encodedContent = btoa(unescape(encodeURIComponent(content)));
            const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                method: 'PUT',
                headers: {
                    Authorization: `token ${state.token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: `create file ${name}`,
                    content: encodedContent
                })
            });
            
            if (!res.ok) throw new Error('创建失败');
            showToast(`已创建文件: ${name}`);
            hideModal();
            fetchFiles();
        } catch (e) {
            showToast(`失败: ${e.message}`);
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '确认';
        }
    };
    
    document.getElementById('cancelCreateFile').onclick = hideModal;
}

// 重命名仓库
function renameRepo(repo) {
    showModal(`
        <div class="modal-form">
            <h3>重命名仓库: ${repo.name}</h3>
            <input id="newRepoName" value="${repo.name}">
            <textarea id="newRepoDesc">${repo.description || ''}</textarea>
            <div class="modal-buttons">
                <button id="cancelRenameRepo">取消</button>
                <button id="confirmRenameRepo" disabled>确认</button>
            </div>
        </div>
    `);
    
    const nameInput = document.getElementById('newRepoName');
    const descInput = document.getElementById('newRepoDesc');
    const confirmBtn = document.getElementById('confirmRenameRepo');
    
    const updateButtonState = () => {
        const newName = nameInput.value.trim();
        const newDesc = descInput.value.trim();
        const nameChanged = newName !== repo.name;
        const descChanged = newDesc !== (repo.description || '');
        const isModified = nameChanged || descChanged;
        
        confirmBtn.disabled = !isModified;
        confirmBtn.className = isModified ? 'primary' : 'disabled';
    };
    
    nameInput.oninput = updateButtonState;
    descInput.oninput = updateButtonState;
    
    confirmBtn.onclick = async () => {
        const newName = nameInput.value.trim();
        const newDesc = descInput.value.trim();
        if (newName === repo.name && newDesc === (repo.description || '')) return;
        
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '处理中 <i class="fa fa-spinner fa-spin"></i>';
        
        try {
            const res = await fetch(`https://api.github.com/repos/${repo.full_name}`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `token ${state.token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name: newName, description: newDesc })
            });

            if (!res.ok) throw new Error((await res.json()).message || '修改失败');
            
            showToast(`仓库信息已更新`);
            hideModal();
            state.repos = [];
            el.repoList.innerHTML = '';
            fetchRepos();
        } catch (e) {
            showToast(`修改失败: ${e.message}`);
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '确认';
        }
    };
    
    document.getElementById('cancelRenameRepo').onclick = hideModal;
}

// 删除仓库
function deleteRepo(repo) {
    showModal(`
        <div class="modal-form">
            <h3>确认删除仓库</h3>
            <p>确定要删除仓库 "${repo.name}" 吗？此操作不可撤销！</p>
            <div class="modal-buttons">
                <button id="cancelDeleteRepo">取消</button>
                <button id="confirmDeleteRepo" class="danger">确认删除</button>
            </div>
        </div>
    `);
    
    const confirmBtn = document.getElementById('confirmDeleteRepo');
    confirmBtn.onclick = async () => {
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '删除中 <i class="fa fa-spinner fa-spin"></i>';
        
        try {
            const res = await fetch(`https://api.github.com/repos/${repo.full_name}`, {
                method: 'DELETE',
                headers: { 'Authorization': `token ${state.token}` }
            });
            
            if (!res.ok) throw new Error((await res.json()).message || '删除失败');
            
            showToast(`仓库 "${repo.name}" 已删除`);
            hideModal();
            fetchRepos();
        } catch (e) {
            showToast(`删除失败: ${e.message}`);
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '确认删除';
        }
    };
    
    document.getElementById('cancelDeleteRepo').onclick = hideModal;
}

// 重命名文件/文件夹
async function renameItem(item) {
    const isDir = item.type === 'dir';
    const binExt = ['.mp3','.mp4','.jpg','.jpeg','.png','.gif','.zip','.rar','.7z','.exe','.pdf','.webp','.flac','.wav','.apk'];
    const isBin = n => binExt.some(e => n.toLowerCase().endsWith(e));
    
    if (!isDir && isBin(item.name)) return showToast('禁止重命名二进制文件');
    
    showModal(`
        <div class="modal-form">
            <h3>重命名 ${isDir ? '文件夹' : '文件'}: ${item.name}</h3>
            <input id="newName" value="${item.name}">
            <div class="modal-buttons">
                <button id="cancelRename">取消</button>
                <button id="confirmRename" disabled>确认</button>
            </div>
        </div>
    `);
    
    const nameInput = document.getElementById('newName');
    const confirmBtn = document.getElementById('confirmRename');
    
    nameInput.oninput = () => {
        const v = nameInput.value.trim();
        const ok = v && v !== item.name;
        confirmBtn.disabled = !ok;
        confirmBtn.className = ok ? 'primary' : 'disabled';
    };
    
    confirmBtn.onclick = async () => {
        const v = nameInput.value.trim();
        if (!v || v === item.name) return;
        
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '保存中 <i class="fa fa-spinner fa-spin"></i>';
        
        try {
            const [owner, repo] = state.currentRepo.split('/');
            const oldPath = item.path;
            const base = oldPath.slice(0, -item.name.length);
            const newPath = base + v;
            
            if (isDir) {
                const getAll = async p => {
                    const r = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${p}`, {
                        headers: { Authorization: `token ${state.token}` }
                    });
                    if (!r.ok) return [];
                    let a = [];
                    for (const i of await r.json()) a.push(...(i.type === 'dir' ? await getAll(i.path) : [i]));
                    return a;
                };
                
                const files = await getAll(oldPath);
                
                for (const f of files) {
                    const to = f.path.replace(oldPath, newPath);
                    const d = await (await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${f.path}`, {
                        headers: { Authorization: `token ${state.token}` }
                    })).json();
                    
                    await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${to}`, {
                        method: 'PUT',
                        headers: { Authorization: `token ${state.token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: `Move ${f.name}`,
                            content: d.content || '',
                            sha: d.sha
                        })
                    });
                    
                    await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${f.path}`, {
                        method: 'DELETE',
                        headers: { Authorization: `token ${state.token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: `Delete ${f.name}`,
                            sha: d.sha
                        })
                    });
                }
                
                await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${oldPath}`, {
                    method: 'DELETE',
                    headers: { Authorization: `token ${state.token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: `Delete folder ${item.name}`,
                        sha: item.sha
                    })
                });
            } else {
                const d = await (await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${oldPath}`, {
                    headers: { Authorization: `token ${state.token}` }
                })).json();
                
                await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${newPath}`, {
                    method: 'PUT',
                    headers: { Authorization: `token ${state.token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: `Rename to ${v}`,
                        content: d.content,
                        sha: d.sha
                    })
                });
                
                await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${oldPath}`, {
                    method: 'DELETE',
                    headers: { Authorization: `token ${state.token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: `Delete old file`,
                        sha: d.sha
                    })
                });
            }
            
            showToast(`重命名成功: ${v}`);
            hideModal();
            fetchFiles();
        } catch (e) {
            showToast(`失败: ${e.message}`);
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '确认';
        }
    };
    
    document.getElementById('cancelRename').onclick = hideModal;
}

// 删除文件/文件夹
async function deleteItem(item) {
    const isDir = item.type === 'dir';
    const safeName = escapeHtml(item.name);
    
    const confirmMessage = isDir
        ? `确定要删除文件夹"${safeName}"吗？这将删除该文件夹及其所有内容。`
        : `确定要删除文件"${safeName}"吗？此操作不可撤销。`;

    showModal(`
        <div class="modal-form">
            <h3>确认删除</h3>
            <p>${confirmMessage}</p>
            <div class="modal-buttons">
                <button id="cancelDelete">取消</button>
                <button id="confirmDelete" class="danger">确认删除</button>
            </div>
        </div>
    `);

    const confirmBtn = document.getElementById('confirmDelete');
    const cancelBtn = document.getElementById('cancelDelete');
    
    const deleteFile = async (path, sha, name) => {
        const [owner, repo] = state.currentRepo.split('/');
        const res = await fetch(
            `https://api.github.com/repos/${owner}/${repo}/contents/${path}`,
            {
                method: 'DELETE',
                headers: {
                    Authorization: `token ${state.token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: `Delete ${name}`,
                    sha: sha
                })
            }
        );

        if (!res.ok) {
            const errorData = await res.json();
            if (res.status === 409) {
                throw new Error(`操作冲突：${errorData.message || '请刷新后重试'}`);
            } else {
                throw new Error(errorData.message || `删除失败 (HTTP ${res.status})`);
            }
        }
    };

    const getAllFiles = async (path) => {
        const [owner, repo] = state.currentRepo.split('/');
        let allFiles = [];
        let page = 1;
        let hasMore = true;

        while (hasMore) {
            const res = await fetch(
                `https://api.github.com/repos/${owner}/${repo}/contents/${path}?page=${page}&per_page=100`,
                { headers: { Authorization: `token ${state.token}` } }
            );

            if (!res.ok) return [];
            
            const items = await res.json();
            if (!Array.isArray(items)) return [];
            
            for (const i of items) {
                if (i.type === 'dir') {
                    const subFiles = await getAllFiles(i.path);
                    allFiles = [...allFiles, ...subFiles];
                } else {
                    allFiles.push(i);
                }
            }
            
            const linkHeader = res.headers.get('Link');
            hasMore = linkHeader && linkHeader.includes('rel="next"');
            page++;
        }
        return allFiles;
    };

    confirmBtn.onclick = async () => {
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '处理中 <i class="fa fa-spinner fa-spin"></i>';
        
        try {
            const [owner, repo] = state.currentRepo.split('/');
            const targetPath = item.path;

            if (isDir) {
                const allFiles = await getAllFiles(targetPath);
                for (const f of allFiles) {
                    await deleteFile(f.path, f.sha, f.name);
                }
                showToast(`文件夹"${safeName}"已删除`);
            } else {
                await deleteFile(targetPath, item.sha, item.name);
                showToast(`文件"${safeName}"已删除`);
            }
            
            hideModal();
            fetchFiles();
        } catch (error) {
            showToast(`删除失败: ${error.message}`);
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '确认删除';
        }
    };

    cancelBtn.onclick = hideModal;
}

// 返回上级
function goUp() {
    if (!state.currentRepo) {
        fetchRepos();
        showToast('已重新载入仓库列表');
        return;
    }

    if (!state.currentPath || state.currentPath === '' || state.currentPath === '/') {
        showRepoListView();
        return;
    }

    let parts = state.currentPath.split('/').filter(Boolean);
    parts.pop();
    state.currentPath = parts.length ? parts.join('/') + '/' : '';

    showToast('已返回上一级');
}

// 初始化
function init() {
    state.token ? (showApp(), fetchRepos()) : showAuth();
    setupEventListeners();
}

document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>博客管理后台</title>
    <style>
        :root{--primary-color:#333;--secondary-color:#777;--bg-color:#fff;--accent-color:#007bff;--border-color:#eee;--danger-color:#dc3545}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;line-height:1.6;color:var(--text-color,#333);background-color:var(--bg-color,#fff);margin:0;padding:20px}.container{max-width:800px;margin:0 auto;padding:20px;background-color:rgba(255,255,255,.95);border-radius:8px;box-shadow:0 4px 6px rgba(0,0,0,.1)}.admin-header{border-bottom:2px solid var(--border-color);padding-bottom:20px;margin-bottom:30px;display:flex;justify-content:space-between;align-items:center}.admin-header nav button,.admin-header nav a{margin-left:10px;text-decoration:none;border:1px solid var(--border-color)}.nav-btn{background:#f0f0f0;color:#333}.nav-btn.active{background:var(--accent-color,#007bff);color:#fff;border-color:var(--accent-color,#007bff)}h1,h2,h3{color:var(--primary-color)}a{color:var(--accent-color,#007bff)}input[type=text],input[type=password],textarea{width:100%;padding:10px;margin-bottom:15px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box;font-size:1em}input[type=color]{min-height:40px;padding:5px;width:100%}button{background-color:var(--accent-color,#007bff);color:#fff;padding:10px 15px;border:none;border-radius:4px;cursor:pointer;font-size:1em}button:disabled{background-color:#ccc;cursor:not-allowed}button:hover{opacity:.9}#post-list{list-style:none;padding:0}#post-list li{padding:10px;border-bottom:1px solid var(--border-color);cursor:pointer;display:flex;justify-content:space-between;align-items:center}#post-list li:hover{background-color:#f9f9f9}#new-post-btn{font-size:1.2em;padding:2px 8px;margin-left:10px}.editor-buttons,.setting-item{margin-bottom:20px}.delete-btn{background-color:var(--danger-color);margin-left:10px}#cancel-edit-btn,#clear-bg-image-btn{background-color:var(--secondary-color);margin-left:10px}.setting-item label{display:block;margin-bottom:5px;font-weight:700}
    </style>
</head>
<body>

    <div id="initial-view" class="container">
        <h1>博客管理</h1>
        <p>请输入您的GitHub Personal Access Token开始。</p>
        <input type="password" id="token-input" placeholder="输入具备 repo 权限的Token">
        <button id="start-btn">开始</button>
        <p id="initial-message" style="color:red;"></p>
    </div>

    <div id="admin-panel" class="container" style="display: none;">
        <header class="admin-header">
            <h1>管理后台</h1>
            <nav>
                <button id="nav-posts" class="nav-btn active">文章管理</button>
                <button id="nav-settings" class="nav-btn">网站设置</button>
                <a href="index.html" target="_blank">查看博客 &rarr;</a>
            </nav>
        </header>

        <main id="posts-view">
            <div id="post-list-container">
                <h2>文章列表 <button id="new-post-btn">+</button></h2>
                <ul id="post-list"></ul>
            </div>

            <div id="editor-container" style="display:none;">
                <h3>文章编辑器</h3>
                <input type="hidden" id="post-id">
                <input type="text" id="post-title" placeholder="文章标题">
                <textarea id="post-content" rows="15" placeholder="在这里写下你的内容 (支持Markdown)"></textarea>
                <input type="text" id="post-tags" placeholder="标签, 用英文逗号分隔">
                <label for="image-upload">上传图片到文章:</label>
                <input type="file" id="image-upload" accept="image/*">
                <div class="editor-buttons">
                    <button id="save-post-btn">保存文章</button>
                    <button id="cancel-edit-btn">取消</button>
                    <button id="delete-post-btn" class="delete-btn" style="display:none;">删除文章</button>
                </div>
            </div>
        </main>

        <main id="settings-view" style="display: none;">
            <h2>网站设置</h2>
            <div class="setting-item">
                <label for="setting-title">网站标题</label>
                <input type="text" id="setting-title">
            </div>
            <div class="setting-item">
                <label for="setting-description">网站描述</label>
                <input type="text" id="setting-description">
            </div>
            <div class="setting-item">
                <label for="setting-bg-color">背景颜色</label>
                <input type="color" id="setting-bg-color">
            </div>
            <div class="setting-item">
                <label for="setting-text-color">文字颜色</label>
                <input type="color" id="setting-text-color">
            </div>
            <div class="setting-item">
                <label for="setting-accent-color">链接/强调色</label>
                <input type="color" id="setting-accent-color">
            </div>
            <div class="setting-item">
                <label for="setting-bg-image">上传网站背景图</label>
                <input type="file" id="setting-bg-image" accept="image/*">
                <input type="text" id="setting-bg-image-url" placeholder="背景图URL将显示在这里" readonly>
                 <button id="clear-bg-image-btn">清除背景图</button>
            </div>
             <button id="save-settings-btn">保存网站设置</button>
        </main>
    </div>

    <script>
        const GitHubAPI = {
            BASE_URL: 'https://api.github.com',
            async request(token, endpoint, options = {}) {
                const url = `${this.BASE_URL}${endpoint}`;
                const headers = { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json', ...options.headers };
                const response = await fetch(url, { ...options, headers });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: `HTTP Error: ${response.statusText}` }));
                    throw new Error(errorData.message || 'GitHub API request failed');
                }
                if (response.status === 204 || response.headers.get("Content-Length") === "0") return null;
                return response.json();
            },
            getUser: (token) => GitHubAPI.request(token, '/user'),
            async getFile(token, owner, repo, path) {
                const result = await this.request(token, `/repos/${owner}/${repo}/contents/${path}`);
                if (!result) return null;
                return { content: atob(result.content), sha: result.sha };
            },
            createFile: (token, owner, repo, path, content, message, isBinary = false) => GitHubAPI.request(token, `/repos/${owner}/${repo}/contents/${path}`, {
                method: 'PUT',
                body: JSON.stringify({ message, content: isBinary ? content : btoa(unescape(encodeURIComponent(content))) }),
            }),
            updateFile: (token, owner, repo, path, content, sha, message) => GitHubAPI.request(token, `/repos/${owner}/${repo}/contents/${path}`, {
                method: 'PUT',
                body: JSON.stringify({ message, content: btoa(unescape(encodeURIComponent(content))), sha }),
            }),
        };

        document.addEventListener('DOMContentLoaded', () => {
            const initialView = document.getElementById('initial-view');
            const adminPanel = document.getElementById('admin-panel');
            const mainViews = { posts: document.getElementById('posts-view'), settings: document.getElementById('settings-view') };
            const navButtons = { posts: document.getElementById('nav-posts'), settings: document.getElementById('nav-settings') };
            const editorContainer = document.getElementById('editor-container');
            const postList = document.getElementById('post-list');
            const messageEl = document.getElementById('initial-message');

            let token = null, owner = '', repo = '';
            let posts = [], postsSha = '';
            let config = {}, configSha = '';

            const showMainView = (view) => {
                Object.values(mainViews).forEach(v => v.style.display = 'none');
                Object.values(navButtons).forEach(b => b.classList.remove('active'));
                mainViews[view].style.display = 'block';
                navButtons[view].classList.add('active');
            };
            const setButtonsDisabled = (disabled) => document.querySelectorAll('button').forEach(b => b.disabled = disabled);

            const start = async () => {
                const userToken = document.getElementById('token-input').value;
                if (!userToken) { messageEl.textContent = 'Token 不能为空。'; return; }
                token = userToken;
                setButtonsDisabled(true);
                messageEl.textContent = '正在验证并加载...';

                try {
                    const pathSegments = window.location.pathname.split('/').filter(v => v);
                    repo = pathSegments[0] === 'blog' ? pathSegments[0] : pathSegments[1];
                    const user = await GitHubAPI.getUser(token);
                    owner = user.login;

                    const configData = await GitHubAPI.getFile(token, owner, repo, 'config.json');

                    if (configData) { // Login
                        posts = JSON.parse((await GitHubAPI.getFile(token, owner, repo, 'posts.json')).content);
                        postsSha = (await GitHubAPI.getFile(token, owner, repo, 'posts.json')).sha;
                        config = JSON.parse(configData.content);
                        configSha = configData.sha;
                    } else { // Activation
                        messageEl.textContent = '未检测到配置，正在为您激活系统...';
                        const initialConfig = {
                            repo: { owner: user.login, name: repo },
                            site: { title: `${user.login}的博客`, description: "由单个仓库驱动的博客" },
                            styling: { backgroundColor: "#ffffff", textColor: "#333333", accentColor: "#007bff", backgroundImageUrl: "" }
                        };
                        const [configRes, postsRes] = await Promise.all([
                             GitHubAPI.createFile(token, user.login, repo, 'config.json', JSON.stringify(initialConfig, null, 2), 'feat: initialize config'),
                             GitHubAPI.createFile(token, user.login, repo, 'posts.json', '[]', 'feat: initialize posts'),
                             GitHubAPI.createFile(token, user.login, repo, 'images/.gitkeep', '', 'feat: initialize images directory')
                        ]);
                        config = initialConfig;
                        configSha = configRes.content.sha;
                        posts = [];
                        postsSha = postsRes.content.sha;
                        alert('系统激活成功！');
                    }
                    
                    initialView.style.display = 'none';
                    adminPanel.style.display = 'block';
                    showMainView('posts');
                    renderPostList();
                    populateSettings();

                } catch (error) {
                    messageEl.textContent = `操作失败: ${error.message}`;
                    token = null;
                } finally {
                    setButtonsDisabled(false);
                }
            };
            
            const renderPostList = () => {
                postList.innerHTML = '';
                [...posts].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(post => {
                    const li = document.createElement('li');
                    li.innerHTML = `${post.title}<span>${new Date(post.createdAt).toLocaleDateString()}</span>`;
                    li.onclick = () => openEditor(post.id);
                    postList.appendChild(li);
                });
            };

            const openEditor = (postId = null) => {
                editorContainer.style.display = 'block';
                const post = posts.find(p => p.id === postId);
                document.getElementById('post-id').value = post?.id || '';
                document.getElementById('post-title').value = post?.title || '';
                document.getElementById('post-content').value = post?.content || '';
                document.getElementById('post-tags').value = post?.tags?.join(', ') || '';
                document.getElementById('delete-post-btn').style.display = post ? 'inline-block' : 'none';
            };

            const savePost = async () => {
                const id = document.getElementById('post-id').value;
                const title = document.getElementById('post-title').value.trim();
                const content = document.getElementById('post-content').value.trim();
                if (!title || !content) return alert('标题和内容不能为空！');
                
                setButtonsDisabled(true);
                const tags = document.getElementById('post-tags').value.split(',').map(t => t.trim()).filter(Boolean);
                const postIndex = posts.findIndex(p => p.id === id);

                if (postIndex > -1) {
                    Object.assign(posts[postIndex], { title, content, tags, updatedAt: new Date().toISOString() });
                } else {
                    posts.push({ id: `post_${Date.now()}`, title, content, tags, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() });
                }
                
                try {
                    const res = await GitHubAPI.updateFile(token, owner, repo, 'posts.json', JSON.stringify(posts, null, 2), postsSha, 'docs: update posts');
                    postsSha = res.content.sha;
                    alert('保存成功！');
                    renderPostList();
                    editorContainer.style.display = 'none';
                } catch (error) {
                    alert(`保存失败: ${error.message}`);
                } finally {
                    setButtonsDisabled(false);
                }
            };

            const deletePost = async () => {
                const id = document.getElementById('post-id').value;
                if (!id || !confirm('确定要删除这篇文章吗？')) return;
                setButtonsDisabled(true);
                posts = posts.filter(p => p.id !== id);
                try {
                    const res = await GitHubAPI.updateFile(token, owner, repo, 'posts.json', JSON.stringify(posts, null, 2), postsSha, 'docs: delete post');
                    postsSha = res.content.sha;
                    alert('删除成功！');
                    renderPostList();
                    editorContainer.style.display = 'none';
                } catch (error) {
                    alert(`删除失败: ${error.message}`);
                } finally {
                    setButtonsDisabled(false);
                }
            };
            
            const populateSettings = () => {
                document.getElementById('setting-title').value = config.site.title;
                document.getElementById('setting-description').value = config.site.description;
                document.getElementById('setting-bg-color').value = config.styling.backgroundColor;
                document.getElementById('setting-text-color').value = config.styling.textColor;
                document.getElementById('setting-accent-color').value = config.styling.accentColor;
                document.getElementById('setting-bg-image-url').value = config.styling.backgroundImageUrl;
            };
            
            const saveSettings = async () => {
                setButtonsDisabled(true);
                const newConfig = { ...config };
                newConfig.site.title = document.getElementById('setting-title').value.trim();
                newConfig.site.description = document.getElementById('setting-description').value.trim();
                newConfig.styling.backgroundColor = document.getElementById('setting-bg-color').value;
                newConfig.styling.textColor = document.getElementById('setting-text-color').value;
                newConfig.styling.accentColor = document.getElementById('setting-accent-color').value;
                newConfig.styling.backgroundImageUrl = document.getElementById('setting-bg-image-url').value;
                try {
                    const res = await GitHubAPI.updateFile(token, owner, repo, 'config.json', JSON.stringify(newConfig, null, 2), configSha, 'docs: update config');
                    configSha = res.content.sha;
                    config = newConfig;
                    alert('网站设置已保存！');
                } catch (error) {
                    alert(`设置保存失败: ${error.message}`);
                } finally {
                    setButtonsDisabled(false);
                }
            };
            
            const uploadFile = async (file, isBgImage = false) => {
                if (!file) return;
                setButtonsDisabled(true);
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const content = e.target.result.split(',')[1];
                    const path = `images/${new Date().toISOString().replace(/[-:.]/g, '')}_${file.name}`;
                    try {
                        const result = await GitHubAPI.createFile(token, owner, repo, path, content, 'feat: upload image', true);
                        const url = result.content.download_url;
                        if (isBgImage) {
                            document.getElementById('setting-bg-image-url').value = url;
                        } else {
                            document.getElementById('post-content').value += `\n![${file.name}](${url})\n`;
                        }
                    } catch (error) {
                        alert(`图片上传失败: ${error.message}`);
                    } finally {
                        setButtonsDisabled(false);
                    }
                };
                reader.readAsDataURL(file);
            };
            
            document.getElementById('start-btn').onclick = start;
            navButtons.posts.onclick = () => showMainView('posts');
            navButtons.settings.onclick = () => showMainView('settings');
            document.getElementById('new-post-btn').onclick = () => openEditor();
            document.getElementById('cancel-edit-btn').onclick = () => editorContainer.style.display = 'none';
            document.getElementById('save-post-btn').onclick = savePost;
            document.getElementById('delete-post-btn').onclick = deletePost;
            document.getElementById('save-settings-btn').onclick = saveSettings;
            document.getElementById('image-upload').onchange = (e) => uploadFile(e.target.files[0], false);
            document.getElementById('setting-bg-image').onchange = (e) => uploadFile(e.target.files[0], true);
            document.getElementById('clear-bg-image-btn').onclick = () => { document.getElementById('setting-bg-image-url').value = ''; };
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub文件管理器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
我爱你
</head>
<body class="bg-[#030712] text-[#f3f4f6] min-h-screen overflow-x-hidden">
    <!-- 页面结构保持不变 -->
    <div id="authScreen" class="h-screen flex flex-col p-6 justify-center gap-6">
        <div class="text-center mb-10">
            <i class="fa fa-github text-6xl text-gray-400 mb-4"></i>
            <h1 class="text-3xl font-bold">GitHub文件管理器</h1>
        </div>
        <div class="shadow-[5px_5px_10px_rgba(0,0,0,0.3),-5px_-5px_10px_rgba(75,85,99,0.1)] bg-[#111827] rounded-xl p-6 flex flex-col gap-4">
            <input type="text" id="tokenInput" placeholder="输入GitHub访问令牌" 
                class="box-shadow-[inset_3px_3px_6px_rgba(0,0,0,0.3),inset_-3px_-3px_6px_rgba(75,85,99,0.1)] bg-[#030712] rounded-lg p-3 outline-none text-[#f3f4f6]">
            <button id="authBtn" class="box-shadow-[5px_5px_10px_rgba(0,0,0,0.3),-5px_-5px_10px_rgba(75,85,99,0.1)] bg-[#6b7280] hover:bg-[#4b5563] transition-colors rounded-lg p-3 font-medium">
                登录
            </button>
        </div>
    </div>

    <div id="app" class="hidden flex flex-col h-screen">
        <header class="bg-[rgba(17,24,39,0.8)] backdrop-blur-[10px] -webkit-backdrop-blur-[10px] box-shadow-[5px_5px_10px_rgba(0,0,0,0.3),-5px_-5px_10px_rgba(75,85,99,0.1)] py-3 px-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fa fa-github text-gray-400"></i>
                <h1 class="font-bold text-lg truncate" id="currentRepo">选择仓库</h1>
            </div>
            <div class="flex items-center gap-2">
                <button id="logoutBtn" class="p-2 rounded-full hover:bg-[#6b7280]/20 transition-colors" title="退出登录">
                    <i class="fa fa-sign-out"></i>
                </button>
                <button id="repoBtn" class="p-2 rounded-full hover:bg-[#6b7280]/20 transition-colors" title="仓库列表">
                    <i class="fa fa-github text-xl"></i>
                </button>
            </div>
        </header>

        <div class="bg-[rgba(17,24,39,0.8)] backdrop-blur-[10px] -webkit-backdrop-blur-[10px] py-2 px-4 overflow-x-auto whitespace-nowrap hidden" id="pathNavContainer">
            <div id="pathNav" class="flex gap-1 text-sm"></div>
        </div>

        <main class="flex-1 overflow-y-auto">
            <div id="repoList" class="p-3 space-y-2">
                <div class="flex justify-center items-center h-full py-10">
                    <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-gray-400"></div>
                </div>
            </div>
            <div id="fileList" class="p-3 space-y-2 hidden">
                <div class="flex justify-center items-center h-full py-10">
                    <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-gray-400"></div>
                </div>
            </div>
        </main>

        <footer class="bg-[rgba(17,24,39,0.8)] backdrop-blur-[10px] -webkit-backdrop-blur-[10px] box-shadow-[5px_5px_10px_rgba(0,0,0,0.3),-5px_-5px_10px_rgba(75,85,99,0.1)] py-3 px-4 flex justify-around">
            <button id="backBtn" class="flex flex-col items-center justify-center p-2 w-1/4" title="返回上级">
                <i class="fa fa-arrow-up text-xl"></i>
            </button>
            <button id="newFolderBtn" class="flex flex-col items-center justify-center p-2 w-1/4" title="新建文件夹">
                <i class="fa fa-folder text-xl"></i>
            </button>
            <button id="uploadBtn" class="flex flex-col items-center justify-center p-2 w-1/4" title="上传文件">
                <i class="fa fa-upload text-xl"></i>
            </button>
            <button id="refreshBtn" class="flex flex-col items-center justify-center p-2 w-1/4" title="刷新">
                <i class="fa fa-refresh text-xl"></i>
            </button>
        </footer>
    </div>

    <!-- 编辑模态框 -->
    <div id="editModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="box-shadow-[5px_5px_10px_rgba(0,0,0,0.3),-5px_-5px_10px_rgba(75,85,99,0.1)] bg-[#111827] rounded-xl flex flex-col w-full max-w-5xl min-h-[60vh]">
            <div class="flex justify-between items-center p-3 border-b border-gray-700">
                <h3 class="text-lg font-bold" id="editFileName">编辑文件</h3>
                <button id="closeEditModal" class="p-2 hover:bg-[#6b7280]/20 rounded-full">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="p-3 m-[0.1rem_0] rounded-[0.375rem]" id="editStatus"></div>
            <div class="flex-1 overflow-hidden relative">
                <div id="editorOverlay" class="absolute inset-0 flex items-center justify-center bg-[rgba(17,24,39,0.7)] z-10 rounded-[0.375rem] opacity-0 pointer-events-none transition-opacity-[0.3s_ease]">
                    <div class="text-center"><i class="fa fa-spinner fa-spin text-2xl"></i></div>
                </div>
                <div class="save-notification absolute top-10 right-10 bg-[rgba(15,81,50,0.9)] text-white p-[5px_10px] rounded-4px text-14px z-5 opacity-0 transform -translate-y-20 transition-[opacity_0.3s_ease,transform_0.3s_ease]" id="saveNotification">
                    <i class="fa fa-check mr-1"></i> 保存成功
                </div>
                <textarea id="fileContent" class="box-shadow-[inset_3px_3px_6px_rgba(0,0,0,0.3),inset_-3px_-3px_6px_rgba(75,85,99,0.1)] bg-[#030712] w-full h-full resize-none p-3 outline-none min-h-[60vh]"></textarea>
            </div>
            <div class="flex gap-3 p-3 border-t border-gray-700">
                <button id="cancelEdit" class="flex-1 box-shadow-[5px_5px_10px_rgba(0,0,0,0.3),-5px_-5px_10px_rgba(75,85,99,0.1)] bg-[#111827] hover:bg-[#111827]/70 transition-colors rounded-lg p-3">取消</button>
                <button id="saveEdit" class="flex-1 box-shadow-[5px_5px_10px_rgba(0,0,0,0.3),-5px_-5px_10px_rgba(75,85,99,0.1)] bg-[#6b7280] hover:bg-[#4b5563] transition-colors rounded-lg p-3">保存修改</button>
            </div>
        </div>
    </div>

    <!-- 其他模态框和组件保持不变 -->
    <div id="uploadPanel" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-[rgba(17,24,39,0.8)] backdrop-blur-[10px] -webkit-backdrop-blur-[10px] box-shadow-[5px_5px_10px_rgba(0,0,0,0.3),-5px_-5px_10px_rgba(75,85,99,0.1)] rounded-lg p-4 w-[91.666667%] max-w-md hidden z-40">
        <h3 class="font-medium mb-3">文件上传中</h3>
        <div id="uploadItems" class="space-y-3 max-h-40 overflow-y-auto"></div>
    </div>

    <div id="modalOverlay" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
        <div class="box-shadow-[5px_5px_10px_rgba(0,0,0,0.3),-5px_-5px_10px_rgba(75,85,99,0.1)] bg-[#111827] rounded-xl p-5 w-[91.666667%] max-w-md">
            <div id="modalContent"></div>
        </div>
    </div>

    <div id="contextMenu" class="fixed bg-[rgba(17,24,39,0.8)] backdrop-blur-[10px] -webkit-backdrop-blur-[10px] box-shadow-[5px_5px_10px_rgba(0,0,0,0.3),-5px_-5px_10px_rgba(75,85,99,0.1)] rounded-lg shadow-lg z-50 hidden w-48">
        <div class="py-1" id="contextMenuItems"></div>
    </div>

    <div id="toast" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-[rgba(17,24,39,0.8)] backdrop-blur-[10px] -webkit-backdrop-blur-[10px] box-shadow-[5px_5px_10px_rgba(0,0,0,0.3),-5px_-5px_10px_rgba(75,85,99,0.1)] px-4 py-2 rounded-full hidden z-30">
        <span id="toastMessage"></span>
    </div>

    <input type="file" id="fileUploadInput" multiple class="hidden">

    <!-- 状态管理模块 -->
    <script>
        const state = {
            token: localStorage.getItem('gh_token') || null,
            currentRepo: null,
            currentPath: '',
            files: [],
            repos: [],
            selectedFile: null,
            uploadQueue: [],
            editingFile: null,
            fileSha: '',
            originalContent: '',
            lastRequestTime: 0,
            MIN_INTERVAL: 1000,
            proxyUrl: 'https://gh-proxy.com/'
        };

        const el = Object.fromEntries(
            ['authScreen', 'app', 'tokenInput', 'authBtn', 'fileList', 'repoList', 
             'pathNav', 'pathNavContainer', 'currentRepo', 'logoutBtn', 'newFolderBtn', 
             'uploadBtn', 'refreshBtn', 'repoBtn', 'backBtn', 'modalOverlay', 'modalContent', 
             'contextMenu', 'contextMenuItems', 'toast', 'toastMessage', 'uploadPanel', 
             'uploadItems', 'editModal', 'editFileName', 'fileContent', 'closeEditModal', 
             'cancelEdit', 'saveEdit', 'editStatus', 'editorOverlay', 'saveNotification',
             'fileUploadInput']
            .map(id => [id, document.getElementById(id)])
        );
    </script>


    <!-- 初始化模块 -->
    <script>
        function init() {
            state.token ? (showApp(), fetchRepos()) : showAuth();
            setupEventListeners();
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>

    <!-- 仓库管理模块 -->
    <script>
        // 获取仓库列表
        async function fetchRepos() {
            try {
                el.repoList.innerHTML = '<div class="flex justify justify-center items-center h-full py-10"><div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-gray-400"></div></div>';
                const res = await fetch('https://api.github.com/user/repos', {
                    headers: { Authorization: `token ${state.token}`, 'User-Agent': 'Mozilla/5.0' }
                });
                if (!res.ok) throw new Error('获取仓库失败');
                state.repos = await res.json();
                renderRepoList();
                showRepoListView();
            } catch (err) {
                showToast('加载仓库失败');
                console.error(err);
            }
        }

        // 渲染仓库列表
        function renderRepoList() {
            el.repoList.innerHTML = state.repos.length === 0 
                ? '<div class="text-center py-10 text-gray-400"><i class="fa fa-github text-4xl mb-2"></i><p>没有找到仓库</p></div>'
                : '';

            state.repos.forEach(repo => {
                const item = document.createElement('div');
                item.className = `box-shadow-[5px_5px_10px_rgba(0,0,0,0.3),-5px_-5px_10px_rgba(75,85,99,0.1)] bg-[#111827] rounded-lg p-3 flex items-center gap-3 hover:bg-[#6b7280]/10 transition-colors cursor-pointer ${state.currentRepo === repo.full_name ? 'ring-2 ring-blue-500' : ''}`;
                item.innerHTML = `
                    <div class="w-10 h-10 flex items-center justify-center rounded-8px bg-[#111827]/50"><i class="fa fa-github text-gray-400"></i></div>
                    <div class="flex-1 min-w-0">
                        <p class="font-medium truncate">${repo.name}</p>
                        <p class="text-xs text-gray-400">${repo.full_name}</p>
                        <p class="text-xs text-gray-500 mt-1">更新于 ${formatRelativeTime(new Date(repo.updated_at))}</p>
                    </div>
                `;
                item.addEventListener('click', () => {
                    state.currentRepo = repo.full_name;
                    state.currentPath = '';
                    el.currentRepo.textContent = repo.name;
                    renderPathNav();
                    fetchFiles();
                    showFileListView();
                });
                el.repoList.appendChild(item);
            });
        }
    </script>

   
    <script>
async function fetchFiles() {
    if (!state.currentRepo) return;

    el.fileList.innerHTML = `
        <div class="flex justify-center items-center h-full py-10">
            <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-gray-400"></div>
        </div>
    `;

    try {
        const timestamp = Date.now(); // 防缓存
        const res = await fetch(`https://api.github.com/repos/${state.currentRepo}/contents/${state.currentPath}?t=${timestamp}`, {
            headers: {
                Authorization: `token ${state.token}`,
                'User-Agent': 'Mozilla/5.0'
            },
            cache: 'no-store' // 防止浏览器缓存
        });

        if (!res.ok) {
            showToast('加载文件失败');
            return;
        }

        state.files = await res.json();
        state.files.sort((a, b) =>
            a.type === 'dir' && b.type !== 'dir' ? -1 :
            a.type !== 'dir' && b.type === 'dir' ? 1 :
            a.name.localeCompare(b.name)
        );
        renderFileList();
    } catch (err) {
        showToast('加载文件失败');
        console.error(err);
    }
}
</script>


    <script>
        // 渲染文件列表
        function renderFileList() {
            el.fileList.innerHTML = state.files.length === 0
                ? '<div class="text-center py-10 text-gray-400"><i class="fa fa-folder-open-o text-4xl mb-2"></i><p>文件夹为空</p></div>'
                : '';

            state.files.forEach(file => {
                const isDir = file.type === 'dir';
                const icon = isDir ? 'fa-folder text-yellow-500' : getFileIcon(file.name);
                const item = document.createElement('div');
                item.className = 'box-shadow-[5px_5px_10px_rgba(0,0,0,0.3),-5px_-5px_10px_rgba(75,85,99,0.1)] bg-[#111827] rounded-lg p-3 flex items-center gap-3 hover:bg-[#6b7280]/10 transition-colors cursor-pointer';
                item.innerHTML = `
                    <div class="w-10 h-10 flex items-center justify-center rounded-8px bg-[#111827]/50"><i class="fa ${icon}"></i></div>
                    <div class="flex-1 min-w-0">
                        <p class="font-medium truncate">${file.name}</p>
                        <p class="text-xs text-gray-400">
                            ${isDir ? '文件夹' : formatSize(file.size)} · ${formatRelativeTime(new Date(file.updated_at))}
                        </p>
                    </div>
                `;
                item.addEventListener('click', () => isDir ? navigateToDir(file.name) : editFile(file));
                
                let pressTimer;
                ['touchstart', 'mousedown'].forEach(event => {
                    item.addEventListener(event, (e) => {
                        pressTimer = setTimeout(() => { e.preventDefault(); showContextMenu(e, file); }, 500);
                    });
                });
                ['touchend', 'touchcancel', 'mouseup', 'mouseleave'].forEach(event => {
                    item.addEventListener(event, () => clearTimeout(pressTimer));
                });
                
                el.fileList.appendChild(item);
            });
        }
        
    </script>

    <!-- 路径导航模块 -->
    <script>
        // 渲染路径导航
        function renderPathNav() {
            el.pathNav.innerHTML = '';
            const parts = state.currentPath.split('/').filter(p => p);
            let currentPath = '';
            addPathItem('/', '');
            parts.forEach((part, i) => {
                currentPath += part + '/';
                addPathItem(part, currentPath);
            });
        }

        function addPathItem(name, path) {
            const item = document.createElement('span');
            item.className = 'cursor-pointer hover:text-gray-300';
            item.textContent = name;
            item.dataset.path = path;
            item.addEventListener('click', () => {
                el.fileList.innerHTML = '<div class="flex justify-center items-center h-full py-10"><div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-gray-400"></div></div>';
                navigateToPath(path);
            });
            el.pathNav.appendChild(item);
            if (name !== '/') el.pathNav.appendChild(document.createTextNode(' / '));
        }

        // 导航函数
        const navigateToDir = dirName => {
            state.currentPath = state.currentPath ? `${state.currentPath}${dirName}/` : `${dirName}/`;
            renderPathNav();
            fetchFiles();
        };

        const navigateToPath = path => {
            state.currentPath = path;
            renderPathNav();
            fetchFiles();
        };

        function goUp() {
            if (!state.currentRepo) return;
            if (!state.currentPath) {
                showRepoListView();
                return;
            }
            const parts = state.currentPath.split('/').filter(p => p);
            parts.pop();
            state.currentPath = parts.length ? parts.join('/') + '/' : '';
            renderPathNav();
            el.fileList.innerHTML = '<div class="flex justify-center items-center h-full py-10"><div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-gray-400"></div></div>';
            fetchFiles();
            showToast('已返回上一级');
        }
    </script>

    <!-- 工具函数模块 -->
    <script>
        // 文件图标获取
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                js: 'fa-code text-yellow-500',
                html: 'fa-html5 text-orange-500',
                css: 'fa-css3 text-blue-500',
                json: 'fa-file-code-o text-gray-400',
                md: 'fa-file-text-o text-blue-400',
                png: 'fa-file-image-o text-green-400',
                jpg: 'fa-file-image-o text-green-400',
                jpeg: 'fa-file-image-o text-green-400',
                gif: 'fa-file-image-o text-green-400',
                pdf: 'fa-file-pdf-o text-red-500',
                zip: 'fa-file-zip-o text-yellow-600',
                git: 'fa-git text-red-600'
            };
            return icons[ext] || 'fa-file-o text-gray-400';
        }

        // 格式化工具函数
        function formatSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatRelativeTime(date) {
            const diffMs = new Date() - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            if (diffMins < 1) return '刚刚';
            if (diffMins < 60) return `${diffMins}分钟前`;
            if (diffHours < 24) return `${diffHours}小时前`;
            if (diffDays < 30) return `${diffDays}天前`;
            return date.toLocaleDateString();
        }
    </script>

    <!-- 上下文菜单模块 -->
    <script>
        // 上下文菜单
        function showContextMenu(e, file) {
            state.selectedFile = file;
            const rect = e.target.closest('div[class*="box-shadow"]').getBoundingClientRect();
            el.contextMenu.style.top = `${rect.top}px`;
            el.contextMenu.style.left = `${Math.max(10, rect.right - 192 - 10)}px`;
            el.contextMenu.classList.remove('hidden');
            renderContextMenuItems(file);
        }

        function renderContextMenuItems(file) {
            el.contextMenuItems.innerHTML = '';
            const isDir = file.type === 'dir';
            const items = isDir 
                ? [['download', 'fa-download', '下载 (ZIP)'], 
                   ['rename', 'fa-pencil', '重命名'], 
                   ['delete', 'fa-trash', '删除', 'text-red-400']]
                : [['download', 'fa-download', '下载'], 
                   ['copyLink', 'fa-link', '复制链接'], 
                   ['copyProxy', 'fa-share', '代理链接'], 
                   ['edit', 'fa-edit', '编辑'], 
                   ['rename', 'fa-pencil', '重命名'], 
                   ['delete', 'fa-trash', '删除', 'text-red-400']];
            
            items.forEach(([action, icon, text, className = '']) => {
                const item = document.createElement('a');
                item.className = `block px-4 py-2 text-sm hover:bg-[#6b7280]/20 ${className}`;
                item.dataset.action = action;
                item.innerHTML = `<i class="fa ${icon} mr-2"></i>${text}`;
                item.addEventListener('click', () => {
                    handleContextMenuAction(action, state.selectedFile);
                    hideContextMenu();
                });
                el.contextMenuItems.appendChild(item);
            });
        }

        const hideContextMenu = () => (el.contextMenu.classList.add('hidden'), state.selectedFile = null);
        
        // 上下文菜单动作处理
        function handleContextMenuAction(action, file) {
            switch(action) {
                case 'download':
                    downloadFile(file);
                    break;
                case 'copyLink':
                    copyLink(file);
                    break;
                case 'copyProxy':
                    copyProxyLink(file);
                    break;
                case 'edit':
                    editFile(file);
                    break;
                case 'rename':
                    renameItem(file);
                    break;
                case 'delete':
                    deleteItem(file);
                    break;
            }
        }
    </script>



    <!-- 视图控制模块 -->
    <script>
        // 视图控制模块
// 视图切换函数
function showRepoListView() {
    el.repoList.classList.remove('hidden');
    el.fileList.classList.add('hidden');
    el.pathNavContainer.classList.add('hidden');
    el.currentRepo.textContent = '选择仓库';
}

function showFileListView() {
    el.repoList.classList.add('hidden');
    el.fileList.classList.remove('hidden');
    el.pathNavContainer.classList.remove('hidden');
}


// 编辑器覆盖层控制
const showEditorOverlay = () => el.editorOverlay.classList.add('opacity-100', 'pointer-events-auto');
const hideEditorOverlay = () => el.editorOverlay.classList.remove('opacity-100', 'pointer-events-auto');

// 保存通知
function showSaveNotification() {
    el.saveNotification.classList.add('opacity-100', 'translate-y-0');
    setTimeout(() => el.saveNotification.classList.remove('opacity-100', 'translate-y-0'), 3000);
}

// 初始化视图
const showAuth = () => (el.authScreen.classList.remove('hidden'), el.app.classList.add('hidden'));
const showApp = () => (el.authScreen.classList.add('hidden'), el.app.classList.remove('hidden'));

// 模态框和提示模块
// 模态框控制
const showModal = content => (el.modalContent.innerHTML = content, el.modalOverlay.classList.remove('hidden'), el.modalOverlay.classList.add('flex'));
const hideModal = () => (el.modalOverlay.classList.add('hidden'), el.modalOverlay.classList.remove('flex'));

// 提示框控制
const showToast = message => (el.toastMessage.textContent = message, el.toast.classList.remove('hidden'), setTimeout(() => el.toast.classList.add('hidden'), 3000));

// 文件编辑模块
// 从0.1.html复刻的编辑功能代码，适配1.html
function initEditorFeatures() {
    // 编辑模态框控制
    function showEditModal() {
        el.editModal.classList.remove('hidden');
        el.editModal.classList.add('flex');
        showEditorOverlay();
        setTimeout(adjustEditorDimensions, 10);
    }

    function hideEditModal() {
        el.editModal.classList.add('hidden');
        el.editModal.classList.remove('flex');
        state.editingFile = state.fileSha = state.originalContent = '';
        el.saveEdit.className = 'flex-1 box-shadow-[5px_5px_10px_rgba(0,0,0,0.3),-5px_-5px_10px_rgba(75,85,99,0.1)] bg-[#6b7280] hover:bg-[#4b5563] transition-colors rounded-lg p-3';
    }

    // 编辑状态显示
    function showEditStatus(text, type) {
        el.editStatus.textContent = text;
        el.editStatus.className = `p-3 m-[0.1rem_0] rounded-[0.375rem] ${type}`;
    }

    // 速率限制检查
    function checkRateLimit() {
        const now = Date.now();
        if (now - state.lastRequestTime < state.MIN_INTERVAL) {
            showEditStatus(`请稍等 ${Math.ceil((state.MIN_INTERVAL - (now - state.lastRequestTime))/1000)} 秒再操作`, 'bg-[#f8d7da] text-[#842029]');
            return false;
        }
        state.lastRequestTime = now;
        return true;
    }

    // 调整编辑器尺寸
    function adjustEditorDimensions() {
        const viewportHeight = window.innerHeight;
        const targetEditorHeight = viewportHeight * 0.6;
        const modal = el.editModal.querySelector('.min-h-[70vh]');
        
        const otherElementsHeight = 
            modal.querySelector('div.flex.justify-between').offsetHeight + 
            el.editStatus.offsetHeight + 
            modal.querySelector('div.flex.gap-3').offsetHeight + 30;
            
        modal.style.height = `${targetEditorHeight + otherElementsHeight}px`;
        el.fileContent.style.height = `${targetEditorHeight}px`;
        el.fileContent.focus();
    }

    // 覆盖层控制
    function showEditorOverlay() {
        el.editorOverlay.classList.add('opacity-100', 'pointer-events-auto');
    }
    
    function hideEditorOverlay() {
        el.editorOverlay.classList.remove('opacity-100', 'pointer-events-auto');
    }

    // 保存通知
    function showSaveNotification() {
        el.saveNotification.classList.add('opacity-100', 'translate-y-0');
        setTimeout(() => {
            el.saveNotification.classList.remove('opacity-100', 'translate-y-0');
        }, 3000);
    }

    // 编辑文件核心功能
    async function editFile(file) {
        state.editingFile = file;
        el.editFileName.textContent = `编辑 ${file.name}`;
        el.fileContent.value = '';
        showEditStatus('', '');
        showEditModal();
        
        if (!checkRateLimit()) return;
        
        try {
            const [owner, repo] = state.currentRepo.split('/');
            const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${file.path}`, { 
                headers: { 
                    'Authorization': `token ${state.token}`, 
                    'User-Agent': 'Mozilla/5.0' 
                } 
            });
            
            if (!res.ok) {
                const err = await res.json();
                hideEditorOverlay();
                showEditStatus(`加载失败：${err.message}`, 'bg-[#f8d7da] text-[#842029]');
                return;
            }
            
            const data = await res.json();
            const content = decodeURIComponent(escape(atob(data.content)));
            el.fileContent.value = content;
            state.originalContent = content;
            state.fileSha = data.sha;
            hideEditorOverlay();
            el.fileContent.addEventListener('input', checkContentChanges);
        } catch (e) {
            hideEditorOverlay();
            showEditStatus(`错误：${e.message}`, 'bg-[#f8d7da] text-[#842029]');
            console.error(e);
        }
    }

    // 内容变更检测
    function checkContentChanges() {
        const isModified = el.fileContent.value !== state.originalContent;
        el.saveEdit.className = `flex-1 box-shadow-[5px_5px_10px_rgba(0,0,0,0.3),-5px_-5px_10px_rgba(75,85,99,0.1)] ${isModified ? 'bg-[#3b82f6] hover:bg-blue-600' : 'bg-[#6b7280] hover:bg-[#4b5563]'} transition-colors rounded-lg p-3`;
    }

    // 保存编辑内容
    async function saveEditedFile() {
        if (!state.editingFile || !state.fileSha || !checkRateLimit()) return;
        
        const currentContent = el.fileContent.value;
        if (currentContent === state.originalContent) {
            showToast('未检测到修改');
            return;
        }
        
        showEditorOverlay();
        try {
            const [owner, repo] = state.currentRepo.split('/');
            const encodedContent = btoa(unescape(encodeURIComponent(currentContent)));
            const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${state.editingFile.path}`, {
                method: 'PUT',
                headers: { 
                    'Authorization': `token ${state.token}`, 
                    'Content-Type': 'application/json',
                    'User-Agent': 'Mozilla/5.0'
                },
                body: JSON.stringify({ 
                    message: `Update ${state.editingFile.name} via web editor`, 
                    content: encodedContent, 
                    sha: state.fileSha 
                })
            });
            
            if (!res.ok) {
                const err = await res.json();
                hideEditorOverlay();
                showEditStatus(`保存失败：${err.message}`, 'bg-[#f8d7da] text-[#842029]');
                return;
            }
            
            const result = await res.json();
            state.fileSha = result.content.sha;
            state.originalContent = currentContent;
            hideEditorOverlay();
            showToast('文件已保存');
            showSaveNotification();
            fetchFiles();
            el.saveEdit.className = 'flex-1 box-shadow-[5px_5px_10px_rgba(0,0,0,0.3),-5px_-5px_10px_rgba(75,85,99,0.1)] bg-[#6b7280] hover:bg-[#4b5563] transition-colors rounded-lg p-3';
        } catch (e) {
            hideEditorOverlay();
            showEditStatus(`错误：${e.message}`, 'bg-[#f8d7da] text-[#842029]');
            console.error(e);
        }
    }

    // 事件绑定
    el.closeEditModal.addEventListener('click', hideEditModal);
    el.cancelEdit.addEventListener('click', hideEditModal);
    el.saveEdit.addEventListener('click', saveEditedFile);
    
    window.addEventListener('resize', () => {
        if (!el.editModal.classList.contains('hidden')) {
            adjustEditorDimensions();
        }
    });

    // 覆盖原有的editFile函数引用
    window.editFile = editFile;
}

// 初始化编辑功能
initEditorFeatures();
    </script>

    <!-- 文件下载模块 -->
    <script>
// 统一处理文件和文件夹下载（保留原文件名和后缀）
async function downloadFile(item) {
    if (!checkRateLimit()) return;
    try {
        showToast(`正在准备 ${item.name} 的下载`);
        let url, downloadName;

        // 提取原始文件名（含后缀）
        downloadName = item.name; // 直接使用item.name确保文件名和后缀完整

        if (item.type === 'dir') {
            // 文件夹下载：通过代理获取ZIP包，保留文件夹名+zip后缀
            const [owner, repo] = state.currentRepo.split('/');
            const encodedPath = encodeURIComponent(item.path);
            url = `${state.proxyUrl}https://github.com/${owner}/${repo}/archive/refs/heads/main.zip?path=${encodedPath}`;
        } else {
            // 文件下载：使用GitHub Raw链接（带代理）
            const rawUrl = item.html_url
                .replace('github.com', 'raw.githubusercontent.com')
                .replace('/blob/', '/');
            url = `${state.proxyUrl}${rawUrl}`;
        }

        // 验证链接有效性
        if (!url || !url.startsWith('http')) {
            throw new Error('下载链接无效');
        }

        // 需特殊处理的文本文件类型（强制下载而非预览）
        const textFileExtensions = ['html', 'htm', 'txt', 'css', 'js', 'json', 'md', 'xml', 'csv'];
        const fileExt = downloadName.split('.').pop()?.toLowerCase();
        const isTextFile = textFileExtensions.includes(fileExt) && item.type !== 'dir';

        if (isTextFile) {
            // 文本文件：通过Fetch获取内容后创建Blob，强制下载（保留原文件名）
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`无法获取文件内容 (${response.status})`);
            }
            
            // 根据文件类型设置正确的MIME类型（不影响文件名）
            const mimeType = getMimeType(fileExt);
            const blob = await response.blob();
            const objectUrl = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = objectUrl;
            a.download = downloadName; // 关键：强制使用原始文件名（含后缀）
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();

            // 清理资源
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(objectUrl);
            }, 500);
        } else {
            // 非文本文件/文件夹：直接使用原链接下载（保留原文件名）
            const a = document.createElement('a');
            a.href = url;
            a.download = downloadName; // 直接使用原始文件名
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();

            setTimeout(() => {
                document.body.removeChild(a);
            }, 500);
        }

        showToast(`已开始下载 ${downloadName}`);
    } catch (e) {
        showToast(`下载失败: ${e.message || '请检查网络或代理设置'}`);
        console.error('下载错误:', e);
    }
}

// 辅助函数：获取文件MIME类型（不影响文件名，仅用于正确解析文件内容）
function getMimeType(ext) {
    const mimeMap = {
        html: 'text/html',
        htm: 'text/html',
        txt: 'text/plain',
        css: 'text/css',
        js: 'application/javascript',
        json: 'application/json',
        md: 'text/markdown',
        xml: 'application/xml',
        csv: 'text/csv'
    };
    return mimeMap[ext] || 'application/octet-stream';
}

// 速率限制检查函数
function checkRateLimit() {
    const now = Date.now();
    if (now - state.lastRequestTime < state.MIN_INTERVAL) {
        const waitTime = Math.ceil((state.MIN_INTERVAL - (now - state.lastRequestTime)) / 1000);
        showToast(`请稍等 ${waitTime} 秒再操作`);
        return false;
    }
    state.lastRequestTime = now;
    return true;
}

</script >



<script >

        
// 复制 GitHub raw 链接功能
function copyLink(file) {
    // 构造 raw 链接
    const rawUrl = file.download_url || file.html_url
        .replace('github.com', 'raw.githubusercontent.com')
        .replace('/blob/', '/');

    navigator.clipboard.writeText(rawUrl).then(() => {
        showToast('Raw 链接已复制');
    }).catch(e => {
        showToast('复制失败');
        console.error(e);
    });
}


        // 复制代理链接功能
        function copyProxyLink(file) {
            if (!file.download_url) return showToast('无代理链接可用');
            const proxyUrl = `${state.proxyUrl}${file.download_url}`;
            navigator.clipboard.writeText(proxyUrl).then(() => {
                showToast('代理链接已复制');
            }).catch(e => {
                showToast('复制失败');
                console.error(e);
            });
        }
    </script>
    
    


<script>
//重命名模块
async function renameItem(item) {
    const isDir = item.type === 'dir';
    
    showModal(`
        <h3 class="font-bold mb-4">重命名 ${isDir ? '文件夹' : '文件'}: ${item.name}</h3>
        <input type="text" id="newName" value="${item.name}" 
            class="w-full p-3 rounded bg-[#030712] text-white outline-none mb-4"
            placeholder="输入新名称">
        <div class="flex gap-3">
            <button id="cancelRename" class="flex-1 p-3 bg-gray-700 rounded hover:bg-gray-600 transition-colors">取消</button>
            <button id="confirmRename" class="flex-1 p-3 bg-gray-600 text-gray-400 rounded cursor-not-allowed" disabled>
                确认
            </button>
        </div>
        ${isDir ? '<p class="text-yellow-500 text-sm mt-2">注意：重命名文件夹可能需要更长时间</p>' : ''}
    `);

    const input = document.getElementById('newName');
    const confirmBtn = document.getElementById('confirmRename');

    input.addEventListener('input', () => {
        const isValid = input.value.trim() && input.value.trim() !== item.name;
        confirmBtn.disabled = !isValid;
        confirmBtn.className = isValid 
            ? 'flex-1 p-3 bg-blue-600 hover:bg-blue-500 text-white rounded cursor-pointer'
            : 'flex-1 p-3 bg-gray-600 text-gray-400 rounded cursor-not-allowed';
    });

    confirmBtn.onclick = async () => {
        const newName = input.value.trim();
        if (!newName || newName === item.name) return;

        confirmBtn.disabled = true;
        confirmBtn.innerHTML = `保存中<i class="fa fa-spinner fa-spin ml-2"></</i>`;

        try {
            const [owner, repo] = state.currentRepo.split('/');
            const oldPath = item.path;
            const oldPathWithSlash = oldPath.endsWith('/') ? oldPath : `${oldPath}/`;
            const newPath = oldPath.replace(item.name, newName);
            const newPathWithSlash = newPath.endsWith('/') ? newPath : `${newPath}/`;

            if (isDir) {
                const getAllFiles = async (path) => {
                    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                        headers: { Authorization: `token ${state.token}` }
                    });
                    if (!res.ok) throw new Error(`获取 ${path} 内容失败`);
                    
                    const items = await res.json();
                    if (!Array.isArray(items)) return [];

                    let files = [];
                    for (const item of items) {
                        if (item.type === 'dir') {
                            const subFiles = await getAllFiles(item.path);
                            files = [...files, ...subFiles];
                        } else {
                            files.push(item);
                        }
                    }
                    return files;
                };

                const allFiles = await getAllFiles(oldPath);
                if (allFiles.length === 0) {
                    await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${newPath}`, {
                        method: 'PUT',
                        headers: { 
                            'Authorization': `token ${state.token}`,
                            'Content-Type': 'application/json' 
                        },
                        body: JSON.stringify({
                            message: `Create empty folder ${newName}`,
                            content: ''
                        })
                    });
                } else {
                    for (const file of allFiles) {
                        const fileNewPath = file.path.startsWith(oldPathWithSlash)
                            ? file.path.replace(oldPathWithSlash, newPathWithSlash)
                            : file.path.replace(oldPath, newPath);

                        const getRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${file.path}`, {
                            headers: { Authorization: `token ${state.token}` }
                        });
                        if (!getRes.ok) throw new Error(`获取文件 ${file.name} 失败`);

                        const fileData = await getRes.json();

                        const putRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${fileNewPath}`, {
                            method: 'PUT',
                            headers: { 
                                'Authorization': `token ${state.token}`,
                                'Content-Type': 'application/json' 
                            },
                            body: JSON.stringify({
                                message: `Move ${file.name} for folder rename`,
                                content: fileData.content,
                                sha: fileData.sha
                            })
                        });
                        if (!putRes.ok) throw new Error(`移动文件 ${file.name} 失败`);

                        await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${file.path}`, {
                            method: 'DELETE',
                            headers: { 
                                'Authorization': `token ${state.token}`,
                                'Content-Type': 'application/json' 
                            },
                            body: JSON.stringify({
                                message: `Delete ${file.name} after move`,
                                sha: fileData.sha
                            })
                        });
                    }
                }

                await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${oldPath}`, {
                    method: 'DELETE',
                    headers: { 
                        'Authorization': `token ${state.token}`,
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({
                        message: `Delete old folder ${item.name}`,
                        sha: item.sha
                    })
                });
            } else {
                const getRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${oldPath}`, {
                    headers: { Authorization: `token ${state.token}` }
                });
                if (!getRes.ok) throw new Error('获取文件失败');

                const fileData = await getRes.json();

                const putRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${newPath}`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `token ${state.token}`,
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({
                        message: `Rename ${item.name} to ${newName}`,
                        content: fileData.content,
                        sha: fileData.sha
                    })
                });
                if (!putRes.ok) throw new Error('重命名失败');

                await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${oldPath}`, {
                    method: 'DELETE',
                    headers: { 
                        'Authorization': `token ${state.token}`,
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({
                        message: `Delete ${item.name} after rename`,
                        sha: fileData.sha
                    })
                });
            }

            showToast(`重命名成功: ${newName}`);
            hideModal();
            fetchFiles();
        } catch (error) {
            console.error('重命名错误:', error);
            showToast(`失败: ${error.message}`);
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = `确认`;
        }
    };

    document.getElementById('cancelRename').onclick = hideModal;
}
</script>


<script >
// 删除项目（文件/文件夹）
async function deleteItem(item) {
    const isDir = item.type === 'dir';
    const confirmMessage = isDir
      ? `确定要删除文件夹"${item.name}"吗？这将删除该文件夹及其所有内容。`
       : `确定要删除文件"${item.name}"吗？此操作不可撤销。`;

    showModal(`
        <h3 class="font-bold mb-4">确认删除</h3>
        <p class="mb-4 text-gray-300">${confirmMessage}</p>
        <div class="flex gap-3">
            <button id="cancelDelete" class="flex-1 p-3 bg-gray-700 rounded hover:bg-gray-600 transition-colors">取消</button>
            <button id="confirmDelete" class="flex-1 p-3 bg-red-600 hover:bg-red-500 text-white rounded">
                确认删除
            </button>
        </div>
    `);

    const confirmBtn = document.getElementById('confirmDelete');
    const cancelBtn = document.getElementById('cancelDelete');

    confirmBtn.onclick = async () => {
        confirmBtn.disabled = true;
        // 显示处理中和旋转动画
        confirmBtn.innerHTML = `处理中 <i class="fa fa-spinner fa-spin ml-2"></i>`;

        try {
            const [owner, repo] = state.currentRepo.split('/');
            const targetPath = item.path;

            if (isDir) {
                // 获取文件夹内所有文件（包括子文件夹）
                const getAllFiles = async (path) => {
                    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                        headers: { Authorization: `token ${state.token}` }
                    });
                    if (!res.ok) throw new Error(`获取 ${path} 内容失败`);

                    const items = await res.json();
                    if (!Array.isArray(items)) return [];

                    let files = [];
                    for (const item of items) {
                        if (item.type === 'dir') {
                            const subFiles = await getAllFiles(item.path);
                            files = [...files, ...subFiles];
                        } else {
                            files.push(item);
                        }
                    }
                    return files;
                };

                const allFiles = await getAllFiles(targetPath);
                // 先删除所有子文件
                for (const file of allFiles) {
                    const delRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${file.path}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `token ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `Delete ${file.name} (from folder deletion)`,
                            sha: file.sha
                        })
                    });
                    if (!delRes.ok) throw new Error(`删除文件 ${file.name} 失败`);
                }
            }

            // 删除目标（文件或空文件夹）
            const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${targetPath}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `token ${state.token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: `Delete ${item.name}`,
                    sha: item.sha
                })
            });

            if (!res.ok) throw new Error('删除失败');

            showToast(`${isDir ? '文件夹' : '文件'} "${item.name}" 已删除`);
            hideModal();
            fetchFiles();// 刷新文件列表
        } catch (error) {
            console.error('删除错误:', error);
            showToast(`删除失败: ${error.message}`);
            confirmBtn.disabled = false;
            // 移除旋转动画，恢复按钮文本
            confirmBtn.innerHTML = '确认删除';
        }
    };

    cancelBtn.onclick = hideModal;
}


</script >





<script>
// 确保在DOM元素加载完成后初始化
if (window.el) {
    initUploadFeatures();
} else {
    // 监听DOM加载完成事件
    document.addEventListener('DOMContentLoaded', initUploadFeatures);
}

function initUploadFeatures() {
    // 避免重复绑定事件
    if (window.uploadFeaturesInitialized) return;
    window.uploadFeaturesInitialized = true;

    // 绑定上传按钮点击事件
    if (el.uploadBtn) {
        el.uploadBtn.addEventListener('click', handleUploadClick);
    }

    // 监听文件选择事件
    if (el.fileUploadInput) {
        el.fileUploadInput.addEventListener('change', handleFilesSelected);
    }
}

function handleUploadClick() {
    if (!state || !state.currentRepo) {
        showToast('请先选择仓库');
        return;
    }
    // 重置输入以允许重复选择同一文件
    if (el.fileUploadInput) {
        el.fileUploadInput.value = '';
        el.fileUploadInput.click();
    }
}

function handleFilesSelected(e) {
    const files = Array.from(e.target.files || []);
    if (files.length === 0) return;

    // 显示上传面板
    if (el.uploadPanel) {
        el.uploadPanel.classList.remove('hidden');
    }
    if (el.uploadItems) {
        el.uploadItems.innerHTML = '';
    }

    // 为每个文件创建上传项
    files.forEach((file, index) => {
        const uploadItem = document.createElement('div');
        uploadItem.className = 'flex flex-col gap-1';
        uploadItem.innerHTML = `
            <div class="flex justify-between items-center text-sm">
                <span class="truncate max-w-[70%]">${file.name}</span>
                <span class="text-gray-400">${formatSize ? formatSize(file.size) : formatFileSize(file.size)}</span>
            </div>
            <div class="h-1.5 bg-gray-700 rounded-full overflow-hidden">
                <div class="upload-progress h-full bg-blue-500 w-0 transition-all duration-300" data-index="${index}"></div>
            </div>
            <div class="text-xs text-gray-400 upload-status" data-index="${index}">等待上传...</div>
        `;
        if (el.uploadItems) {
            el.uploadItems.appendChild(uploadItem);
        }
    });

    // 开始上传文件
    uploadFilesInSequence(files, 0);
    
    // 清空输入
    e.target.value = '';
}

// 兼容处理：如果原代码没有formatSize函数则添加
function formatFileSize(bytes) {
    if (!bytes) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// 速率限制检查（使用全局函数避免冲突）
function checkUploadRateLimit() {
    if (!state) return true;
    const now = Date.now();
    if (now - (state.lastRequestTime || 0) < (state.MIN_INTERVAL || 1000)) {
        return false;
    }
    state.lastRequestTime = now;
    return true;
}

function uploadFilesInSequence(files, index) {
    if (index >= files.length) {
        // 所有文件上传完成
        setTimeout(() => {
            if (el.uploadPanel) {
                el.uploadPanel.classList.add('hidden');
            }
            // 调用原代码的刷新函数
            if (typeof fetchFiles === 'function') {
                fetchFiles();
            }
        }, 2000);
        return;
    }

    const file = files[index];
    const statusElement = document.querySelector(`.upload-status[data-index="${index}"]`);
    
    if (statusElement) {
        statusElement.textContent = '准备上传...';
    }

    // 检查速率限制
    const now = Date.now();
    const timeSinceLast = now - (state.lastRequestTime || 0);
    const minInterval = state ? state.MIN_INTERVAL : 1000;
    
    if (timeSinceLast < minInterval) {
        const waitTime = minInterval - timeSinceLast;
        const waitSeconds = Math.ceil(waitTime / 1000);
        
        if (statusElement) {
            statusElement.textContent = `等待中... ${waitSeconds}s`;
        }
        
        setTimeout(() => {
            uploadSingleFile(file, index)
                .then(() => uploadFilesInSequence(files, index + 1))
                .catch(() => uploadFilesInSequence(files, index + 1));
        }, waitTime);
    } else {
        uploadSingleFile(file, index)
            .then(() => uploadFilesInSequence(files, index + 1))
            .catch(() => uploadFilesInSequence(files, index + 1));
    }
}

async function uploadSingleFile(file, index) {
    return new Promise((resolve, reject) => {
        const progressBar = document.querySelector(`.upload-progress[data-index="${index}"]`);
        const statusElement = document.querySelector(`.upload-status[data-index="${index}"]`);

        // 更新进度和状态
        if (progressBar) progressBar.style.width = '5%';
        if (statusElement) statusElement.textContent = '正在处理文件...';

        // 读取文件内容
        const reader = new FileReader();
        
        // 根据文件类型选择读取方式
        if (file.type.includes('text') || file.size < 1024 * 1024) {
            reader.readAsText(file);
        } else {
            reader.readAsDataURL(file);
        }

        reader.onload = async (e) => {
            try {
                if (statusElement) statusElement.textContent = '正在编码内容...';
                
                // 处理文件内容
                let content;
                if (e.target.result.startsWith('data:')) {
                    content = e.target.result.split(',')[1];
                } else {
                    content = btoa(unescape(encodeURIComponent(e.target.result)));
                }

                if (progressBar) progressBar.style.width = '30%';

                // 准备上传参数
                if (!state || !state.currentRepo) {
                    throw new Error('未选择仓库');
                }
                const fileName = file.name;
                const filePath = state.currentPath ? `${state.currentPath}${fileName}` : fileName;
                const [owner, repo] = state.currentRepo.split('/');

                if (statusElement) statusElement.textContent = '正在上传...';
                
                // 执行上传请求
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${state.token}`,
                        'Content-Type': 'application/json',
                        'User-Agent': 'Mozilla/5.0'
                    },
                    body: JSON.stringify({
                        message: `Upload ${fileName}`,
                        content: content
                    }),
                    signal: AbortSignal.timeout(60000)
                });

                if (progressBar) progressBar.style.width = '100%';

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `上传失败: HTTP ${response.status}`);
                }

                // 上传成功
                if (statusElement) {
                    statusElement.textContent = '上传成功';
                    statusElement.className = 'text-xs text-green-400 upload-status';
                }
                if (typeof showToast === 'function') {
                    showToast(`文件 "${fileName}" 上传成功`);
                }
                if (state) {
                    state.lastRequestTime = Date.now();
                }
                resolve();
            } catch (error) {
                if (statusElement) {
                    statusElement.textContent = `失败: ${error.message.substring(0, 20)}...`;
                    statusElement.className = 'text-xs text-red-400 upload-status';
                }
                if (typeof showToast === 'function') {
                    showToast(`文件 "${file.name}" 上传失败`);
                }
                reject(error);
            }
        };

        // 处理文件读取错误
        reader.onerror = () => {
            if (statusElement) {
                statusElement.textContent = '文件读取失败';
                statusElement.className = 'text-xs text-red-400 upload-status';
            }
            if (typeof showToast === 'function') {
                showToast(`无法读取文件: ${file.name}`);
            }
            reject(new Error('文件读取失败'));
        };
    });
}
</script>






    <script >
    // 初始化手机返回键支持
function initBackButtonSupport() {
    // 页面加载时添加初始历史记录，确保首次返回键可被捕获
    if (window.history.state === null) {
        history.pushState({ page: 'initial' }, '', window.location.href);
    }

    // 监听手机返回键事件
    window.addEventListener('popstate', handleBackButton);

    // 记录导航历史（用于多级返回）
    state.navHistory = [state.currentPath || 'root'];
}

// 处理手机返回键逻辑
function handleBackButton(event) {
    // 判断是否有可返回的历史记录
    if (state.navHistory.length > 1) {
        // 移除当前路径
        state.navHistory.pop();
        // 获取上一级路径
        const prevPath = state.navHistory[state.navHistory.length - 1];
        
        // 执行页内返回操作
        if (prevPath === 'root') {
            // 返回仓库列表
            showRepoListView();
        } else {
            // 返回上一级文件夹
            navigateToPath(prevPath);
        }
        
        // 重新添加历史记录，保持监听有效
        history.pushState({ page: 'nav' }, '', window.location.href);
    } else {
        // 没有更多历史记录时，提示是否退出
        if (confirm('确定要退出应用吗？')) {
            // 允许浏览器默认返回行为
            history.back();
        } else {
            // 取消退出，重新添加历史记录
            history.pushState({ page: 'stay' }, '', window.location.href);
        }
    }
}

// 扩展导航函数，记录历史
function navigateToDir(dirName) {
    const newPath = state.currentPath ? `${state.currentPath}${dirName}/` : `${dirName}/`;
    state.navHistory.push(newPath); // 记录新路径到历史
    state.currentPath = newPath;
    renderPathNav();
    fetchFiles();
}

function navigateToPath(path) {
    state.navHistory.push(path); // 记录新路径到历史
    state.currentPath = path;
    renderPathNav();
    fetchFiles();
}

function goUp() {
    if (!state.currentRepo) return;
    if (!state.currentPath) {
        showRepoListView();
        return;
    }
    const parts = state.currentPath.split('/').filter(p => p);
    parts.pop();
    const newPath = parts.length ? parts.join('/') + '/' : '';
    state.navHistory.push(newPath); // 记录新路径到历史
    state.currentPath = newPath;
    renderPathNav();
    el.fileList.innerHTML = '<div class="flex justify-center items-center h-full py-10"><div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-gray-400"></div></div>';
    fetchFiles();
    showToast('已返回上一级');
}

// 在初始化时调用
document.addEventListener('DOMContentLoaded', () => {
    init();
    initBackButtonSupport(); // 添加手机返回键支持
});

    </script >






    <!-- 事件监听模块 -->
    <script>
        function setupEventListeners() {
            // 认证相关
            el.authBtn.addEventListener('click', () => {
                const token = el.tokenInput.value.trim();
                if (token) {
                    localStorage.setItem('gh_token', token);
                    state.token = token;
                    showApp();
                    fetchRepos();
                } else {
                    showToast('请输入令牌');
                }
            });

            el.logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('gh_token');
                state.token = null;
                state.repos = [];
                state.currentRepo = null;
                showAuth();
            });

            // 导航相关
            el.backBtn.addEventListener('click', goUp);
            el.repoBtn.addEventListener('click', showRepoListView);
            el.refreshBtn.addEventListener('click', fetchFiles);

            // 编辑相关
            el.closeEditModal.addEventListener('click', hideEditModal);
            el.cancelEdit.addEventListener('click', hideEditModal);
            el.saveEdit.addEventListener('click', saveEditedFile);

            // 文件夹和上传相关
            el.newFolderBtn.addEventListener('click', createNewFolder);
            
            // 点击空白处关闭上下文菜单
            document.addEventListener('click', (e) => {
                if (!el.contextMenu.contains(e.target)) {
                    hideContextMenu();
                }
            });

            // 点击空白处关闭模态框
            el.modalOverlay.addEventListener('click', (e) => {
                if (e.target === el.modalOverlay) {
                    hideModal();
                }
            });
        }
    </script>
    
    

</body>
</html>